#include "db_card.hsp"
#include "tcg_mod.hsp"
#include "tcg_skill.hsp"
#include "tcg_ai.hsp"
#include "tcg_custom.hsp"
// TCG is completely unused so I completely overwrite it at 2.19
// Ano uses deck as a card gallery, so if he change anything you only need to change `*select_deck` part below.

#deffunc dbghit
	*dbghit_WHILE1
		await
		stick a@tcg
		if ( a@tcg ) {
			return
		}
		goto *dbghit_WHILE1
	*dbghit_WEND1

#deffunc proctcg str proctcg_arg1, int proctcg_arg2
	if ( dbg_tcg ) {
		title proctcg_arg1
		if ( proctcg_arg2 ) {
			dbghit
		}
	}
	proc proctcg_arg1
	return

#deffunc cursor_check@tcg int cursor_check_tcg_mode
	if ( cfg_mmah_mouseoperation != TRUE ) { return }
	if ( mousex != mousebx@MMAH | mousey != mouseby@MMAH ) {
		mousebx@MMAH = mousex
		mouseby@MMAH = mousey
		if ( cursor_check_tcg_mode == 0 ) {
			if ( mousex >= basex@tcg + 140 & mousex <= basex@tcg + 780 & mousey >= basey@tcg + 70 & mousey <= basey@tcg + 520 ) {
				dsctmp@tcg = limit((mousey - 43 - basey@tcg) / 150, 0, 2) * 8 + limit((mousex - 144 - basex@tcg) / 80, 0, 7)
				if ( dsctmp@tcg >= 0 & dsctmp@tcg < 24 ) {
					dsc@tcg = limit(page@tcg * 8 + dsctmp@tcg, 0, dlistmax@tcg - 1)
				}
			}
		}
		if ( cursor_check_tcg_mode == 1 ) {
			if ( mousey >= holderiy@tcg(1) & mousey <= holderiy@tcg(1) + 96 ) { 
				csline@tcg = 3 
			}
			if ( mousey >= spotiy@tcg(1) & mousey <= spotiy@tcg(1) + 96 ) { 
				csline@tcg = 2 
			}
			if ( mousey >= spotiy@tcg(0) & mousey <= spotiy@tcg(0) + 96 ) { 
				csline@tcg = 1
			}
			if ( mousey >= holderiy@tcg(0) & mousey <= holderiy@tcg(0) + 96 ) { 
				csline@tcg = 0 
			}
			csfix
			x2@tcg = holderspace@tcg, spotspace@tcg
			if ( clistmax@tcg(csline@tcg) > 7 ) {
				x2@tcg(0) = ( holderspace@tcg * 7 ) / clistmax@tcg(csline@tcg)
			}
			if ( clistmax@tcg(csline@tcg) > 8 ) {
				x2@tcg(1) = ( spotspace@tcg * 8 ) / clistmax@tcg(csline@tcg)
			}
			if ( csline@tcg == 0 | csline@tcg == 3 ) {
				cs@tcg = limit((mousex + x2@tcg(0) - holderix@tcg) / x2@tcg(0) - 1, 0 - (csline@tcg == 0), limit(clistmax@tcg(csline@tcg) - 1, 0, maxcard@tcg))
			} else {
				cs@tcg = limit((mousex - (basex@tcg + 466 - clistmax@tcg(csline@tcg) * x2@tcg(1) / 2)) / x2@tcg(1), 0, limit(clistmax@tcg(csline@tcg) - 1, 0, maxcard@tcg))
			}
			csfix
		}
		if ( dbg_tcg ) {
			title "" + mousex + "/" + mousey + "/" + (mousex - basex@tcg) + "/" + (mousey - basey@tcg)
		}
	}
	if ( click_left@MMAH ) {
		key = key_enter
		if ( cursor_check_tcg_mode == 2 ) {
			if ( mousey < card@tcg(TCG_CARD_Y, cc@tcg) + 20 ) {
				key = key_north
			}
			if ( mousey > card@tcg(TCG_CARD_Y, cc@tcg) + 66 ) {
				key = key_south
			}
		}
		// During play: Enable drag and play.
		if ( cursor_check_tcg_mode == 1 & deck_mode@tcg == 0 ) {
			keyholding@tcg = 1
		}
		if ( mousex < basex@tcg ) {
			key = key_prev
			return
		}
		if ( mousex > basex@tcg + basew@tcg ) {
			key = key_next
			return
		}
		if ( cursor_check_tcg_mode == 0 ) {
			if ( mousey >= basey@tcg + 70 & mousey <= basey@tcg + 520 ) {
				if ( mousex >= basex@tcg + 114 & mousex <= basex@tcg + 140 ) {
					dsc@tcg = limit(dsc@tcg - 24, 0, dlistmax@tcg - 1)
					key == ""
					return
				}
				if ( mousex >= basex@tcg + 780 & mousex <= basex@tcg + 800 ) {
					dsc@tcg = limit(dsc@tcg + 24, 0, dlistmax@tcg - 1)
					key == ""
					return
				}
			}
			if ( mousex >= basex@tcg + 180 & mousey >= basey@tcg & mousey <= basey@tcg + 49 ) {
				ccf@tcg = limit((mousex - 180 - basex@tcg)/63, 0, cfmax@tcg - 1) + 1
				key = key_prev
				return
			}
			if ( mousex < basex@tcg + 114 ) {
				key = key_search
			}
			if ( mousex < basex@tcg + 114 &  mousey < basey@tcg + 120 ) {
				key = key_msglog
			}
			if ( mousey > basey@tcg + 537 ) {
				key = key_charainfo
			}
			if ( mousey < basey@tcg ) {
				key = key_fire
			}
			if ( mousey > basey@tcg + 600 ) {
				key = key_get
			}
		}
	} else {
		// Drag and play support
		if ( cursor_check_tcg_mode == 2 & keyholding@tcg ) {
			stick a, 256
			if ( a != 256 ) { // If not holding left click anymore
				key = key_cancel
				keyholding@tcg = 0
			} else { // If still holding left click
				if ( mousey < card@tcg(TCG_CARD_Y, cc@tcg) - 10 ) {
					key = key_north
					keyholding@tcg = 0
				}
				if ( mousey > card@tcg(TCG_CARD_Y, cc@tcg) + 106 ) {
					key = key_south
					keyholding@tcg = 0
				}
			}
		}
		if ( cursor_check_tcg_mode != 2 ) {
			keyholding@tcg = 0
		}
	}
	if ( click_right@MMAH ) {
		key = key_cancel
	}
	return

#defcfunc cdbit int cdbit_bit, int cdbit_charid
	if ( cdbit_charid < 0 | cdbit_charid >= maxcard@tcg ) {
		return
	}
	HMMBITCHECK@ card@tcg(30 + cdbit_bit / 32, cdbit_charid), cdbit_bit \ 32
	return abs(stat)

#deffunc cdbitmod int cdbitmod_bit, int cdbitmod_charid, int cdbitmod_seton
	if ( cdbitmod_charid < 0 | cdbitmod_charid >= maxcard@tcg ) {
		return
	}
	if ( cdbitmod_seton == 0 ) {
		HMMBITOFF@ card@tcg(30 + cdbitmod_bit / 32, cdbitmod_charid), cdbitmod_bit \ 32
		return
	}
	if ( cdbitmod_bit == TCG_BIT_INSANE & cdbitmod_seton == 1 ) {
		if ( cdbit(TCG_BIT_INSANE, cdbitmod_charid) & card@tcg(TCG_CARD_LOCATION, cdbitmod_charid) == TCG_LOCATION_FIELD ) {
			if ( hasspotspace(1 - card@tcg(TCG_CARD_CONTROLLER, cdbitmod_charid)) == TRUE ) {
				card@tcg(TCG_CARD_CONTROLLER, cdbitmod_charid) = 1 - card@tcg(TCG_CARD_CONTROLLER, cdbitmod_charid)
				makecardlist
				cardpos 0, -1
				cardpos 1, -1
				HMMBITOFF@ card@tcg(30 + cdbitmod_bit / 32, cdbitmod_charid), cdbitmod_bit \ 32
				return
			}
		}
	}
	HMMBITON@ card@tcg(30 + cdbitmod_bit / 32, cdbitmod_charid), cdbitmod_bit \ 32
	return

#deffunc cpflip
	if ( cp@tcg == TCG_CONTROLLER_OPPONENT ) {
		cp@tcg = TCG_CONTROLLER_PLAYER
		tp@tcg = TCG_CONTROLLER_OPPONENT
		cl@tcg = TCG_LANE_PLAYER_FIELD
		tl@tcg = TCG_LANE_OPPONENT_HAND
		ch@tcg = TCG_LANE_PLAYER_HAND
		th@tcg = TCG_LANE_OPPONENT_HAND
	}
	else {
		cp@tcg = TCG_CONTROLLER_OPPONENT
		tp@tcg = TCG_CONTROLLER_PLAYER
		cl@tcg = TCG_LANE_OPPONENT_FIELD
		tl@tcg = TCG_LANE_PLAYER_FIELD
		ch@tcg = TCG_LANE_OPPONENT_HAND
		th@tcg = TCG_LANE_PLAYER_HAND
	}
	return

#deffunc cpisplayer
	if ( player@tcg == TCG_CONTROLLER_PLAYER ) {
		cp@tcg = TCG_CONTROLLER_PLAYER
		tp@tcg = TCG_CONTROLLER_OPPONENT
		cl@tcg = TCG_LANE_PLAYER_FIELD
		tl@tcg = TCG_LANE_OPPONENT_FIELD
		ch@tcg = TCG_LANE_PLAYER_HAND
		th@tcg = TCG_LANE_OPPONENT_HAND
	}
	else {
		cp@tcg = TCG_CONTROLLER_OPPONENT
		tp@tcg = TCG_CONTROLLER_PLAYER
		cl@tcg = TCG_LANE_OPPONENT_FIELD
		tl@tcg = TCG_LANE_PLAYER_FIELD
		ch@tcg = TCG_LANE_OPPONENT_HAND
		th@tcg = TCG_LANE_PLAYER_HAND
	}
	return

#deffunc cpisme
	if ( ct@tcg == TCG_CONTROLLER_PLAYER ) {
		cp@tcg = TCG_CONTROLLER_PLAYER
		tp@tcg = TCG_CONTROLLER_OPPONENT
		cl@tcg = TCG_LANE_PLAYER_FIELD
		tl@tcg = TCG_LANE_OPPONENT_FIELD
		ch@tcg = TCG_LANE_PLAYER_HAND
		th@tcg = TCG_LANE_OPPONENT_HAND
	}
	else {
		cp@tcg = TCG_CONTROLLER_OPPONENT
		tp@tcg = TCG_CONTROLLER_PLAYER
		cl@tcg = TCG_LANE_OPPONENT_FIELD
		tl@tcg = TCG_LANE_PLAYER_FIELD
		ch@tcg = TCG_LANE_OPPONENT_HAND
		th@tcg = TCG_LANE_PLAYER_HAND
	}
	return

#deffunc cpisenemy
	if ( ct@tcg == TCG_CONTROLLER_PLAYER ) {
		cp@tcg = TCG_CONTROLLER_OPPONENT
		tp@tcg = TCG_CONTROLLER_PLAYER
		cl@tcg = TCG_LANE_OPPONENT_FIELD
		tl@tcg = TCG_LANE_PLAYER_FIELD
		ch@tcg = TCG_LANE_OPPONENT_HAND
		th@tcg = TCG_LANE_PLAYER_HAND
	}
	else {
		cp@tcg = TCG_CONTROLLER_PLAYER
		tp@tcg = TCG_CONTROLLER_OPPONENT
		cl@tcg = TCG_LANE_PLAYER_FIELD
		tl@tcg = TCG_LANE_OPPONENT_FIELD
		ch@tcg = TCG_LANE_PLAYER_HAND
		th@tcg = TCG_LANE_OPPONENT_HAND
	}
	return

#defcfunc cnvrare int cnvrare_arg1
	s@tcg = ""
	if ( cnvrare_arg1 < 0 ) { return "" }
	repeat limit(cnvrare_arg1, 1, 5)
		s@tcg += "*"
	loop
	return s@tcg

#defcfunc gameover
	if ( cpdata@tcg(TCG_PLAYER_LIFE, 1) <= 0 ) {
		return 2
	}
	if ( cpdata@tcg(TCG_PLAYER_LIFE, 0) <= 0 ) {
		return 1
	}
	return 0

#defcfunc cardcandeclareattack int cardcandeclareattack_arg1
	if ( card@tcg(TCG_CARD_LOCATION, cardcandeclareattack_arg1) != TCG_LOCATION_FIELD ) {
		return 0
	}
	if ( card@tcg(TCG_CARD_REF_TYPE, cardcandeclareattack_arg1) != TCG_TYPE_CREATURE ) {
		return 0
	}
	if ( cdbit(TCG_BIT_FOSSIL, cardcandeclareattack_arg1) ) {
		return 0
	}
	if ( cdbit(TCG_BIT_FROZEN, cardcandeclareattack_arg1) ) {
		return 0
	}
	if ( cdbit(TCG_BIT_CONFUSED, cardcandeclareattack_arg1) ) {
		return 0
	}
	if ( cdbit(TCG_BIT_DEFENDER, cardcandeclareattack_arg1) ) {
		return 0
	}
	if ( cdbit(TCG_BIT_EXHAUSTED, cardcandeclareattack_arg1) ) {
		return 0
	}
	return 1

#defcfunc cardcanblock int cardcanblock_arg1, int cardcanblock_arg2
	if ( card@tcg(TCG_CARD_LOCATION, cardcanblock_arg1) != TCG_LOCATION_FIELD ) {
		return 0
	}
	if ( card@tcg(TCG_CARD_REF_TYPE, cardcanblock_arg1) != TCG_TYPE_CREATURE ) {
		return 0
	}
	if ( specialruleanyonecanblock@tcg ) {
		return 1
	}
	if ( cdbit(TCG_BIT_GRAVITY, cardcanblock_arg2) == TRUE ) {
		return 1
	}
	if ( cdbit(TCG_BIT_FOSSIL, cardcanblock_arg1) ) {
		return 0
	}
	if ( cdbit(TCG_BIT_FLYING, cardcanblock_arg2) == TRUE & cdbit(TCG_BIT_FLYING, cardcanblock_arg1 ) != TRUE & cdbit(TCG_BIT_REACH, cardcanblock_arg1 ) != TRUE ) {
		return 0
	}
	if ( cdbit(TCG_BIT_INTIMIDATE, cardcanblock_arg2) == TRUE & card@tcg(TCG_CARD_REF_DOMAIN, cardcanblock_arg1) != card@tcg(TCG_CARD_REF_DOMAIN, cardcanblock_arg2) ) {
		return 0
	}
	if ( cdbit(TCG_BIT_PARALYSED, cardcanblock_arg1) == TRUE ) {
		return 0
	}
	if ( cdbit(TCG_BIT_CONFUSED, cardcanblock_arg1) == TRUE ) {
		return 0
	}
	if ( cdbit(TCG_BIT_VIGILANCE, cardcanblock_arg1) | cdbit(TCG_BIT_DEFENDER, cardcanblock_arg1) ) {
		return 1
	}
	if ( cdbit(TCG_BIT_EXHAUSTED, cardcanblock_arg1) ) {
		if ( card@tcg(TCG_CARD_STATUS, cardcanblock_arg1) != TCG_ACTION_EXHAUSTED ) {
			return 0
		}
	}
	return 1

#defcfunc cardcanuseskill int cardcanuseskill_arg1
	if ( card@tcg(TCG_CARD_LOCATION, cardcanuseskill_arg1) != TCG_LOCATION_FIELD ) {
		return 0
	}
	if ( card@tcg(TCG_CARD_REF_TYPE, cardcanuseskill_arg1) != TCG_TYPE_CREATURE ) {
		return 0
	}
	if ( cdbit(TCG_BIT_EXHAUSTED, cardcanuseskill_arg1) ) {
		return 0
	}
	if ( card@tcg(TCG_CARD_REF_SKILL_COST, cardcanuseskill_arg1) == 0 ) {
		return 0
	}
	if ( card@tcg(TCG_CARD_REF_SKILL_COST, cardcanuseskill_arg1) > cpdata@tcg(TCG_PLAYER_MANA, card@tcg(TCG_CARD_CONTROLLER, cardcanuseskill_arg1)) ) {
		return 0
	}
	return 1

#defcfunc hasholdspace int getholdersum_arg1
	return getholdersum(getholdersum_arg1) < maxholdersum@tcg(getholdersum_arg1)
#defcfunc hasspotspace int getspotsum_arg1
	return getspotsum(getspotsum_arg1) < maxspotsum@tcg(getspotsum_arg1)
#defcfunc getholdersum int getholdersum_arg1
	getsump@tcg = 0
	repeat maxcard@tcg
		if ( card@tcg(TCG_CARD_CONTROLLER, cnt) != getholdersum_arg1 ) {
			continue
		}
		if ( card@tcg(TCG_CARD_LOCATION, cnt) == TCG_LOCATION_HAND ) {
			getsump@tcg++
		}
	loop
	return getsump@tcg

#defcfunc getspotsum int getspotsum_arg1
	getsump@tcg = 0
	repeat maxcard@tcg
		if ( card@tcg(TCG_CARD_CONTROLLER, cnt) != getspotsum_arg1 ) {
			continue
		}
		if ( card@tcg(TCG_CARD_LOCATION, cnt) == TCG_LOCATION_FIELD ) {
			getsump@tcg++
		}
	loop
	return getsump@tcg

#defcfunc getdecksum int getdecksum_arg1
	getsump@tcg = 0
	repeat maxcard@tcg
		if ( card@tcg(TCG_CARD_CONTROLLER, cnt) != getdecksum_arg1 ) {
			continue
		}
		if ( card@tcg(TCG_CARD_LOCATION, cnt) == TCG_LOCATION_DECK ) {
			getsump@tcg++
		}
	loop
	return getsump@tcg

#deffunc cardpos int cardpos_arg1, int cardpos_arg2
	cardposn@tcg = (cardpos_arg1 == TCG_CONTROLLER_OPPONENT)
	l@tcg = TCG_LANE_PLAYER_FIELD * (cardposn@tcg == 0) + TCG_LANE_OPPONENT_FIELD * (cardposn@tcg == 1)
	p@tcg = -1
	spotlistmax@tcg = clistmax@tcg(l@tcg)
	repeat spotlistmax@tcg
		spotlist@tcg(cnt) = clist@tcg(cnt, l@tcg)
		if ( p@tcg == (-1) ) {
			if ( card@tcg(TCG_CARD_REF_TYPE, clist@tcg(cnt, l@tcg)) != TCG_TYPE_CREATURE ) {
				p@tcg = cnt
			}
		}
	loop
	if ( cardpos_arg2 != (-1) ) {
		if ( p@tcg != (-1) ) {
			repeat spotlistmax@tcg - p@tcg
				spotlist@tcg(spotlistmax@tcg - cnt) = spotlist@tcg(spotlistmax@tcg - cnt - 1)
			loop
			spotlist@tcg(p@tcg) = cardpos_arg2
		}
		else {
			spotlist@tcg(spotlistmax@tcg) = cardpos_arg2
		}
		spotlistmax@tcg++
	}
	x2@tcg = spotspace@tcg
	if ( spotlistmax@tcg > 8 ) {
		x2@tcg = ( spotspace@tcg * 8 ) / spotlistmax@tcg
	}
	x@tcg = basex@tcg + 466 - spotlistmax@tcg * x2@tcg / 2
	repeat spotlistmax@tcg
		p@tcg = spotlist@tcg(cnt)
		card@tcg(TCG_CARD_X_MOVETO, p@tcg) = x@tcg + cnt * x2@tcg, spotiy@tcg(cardposn@tcg)
	loop
	return

#deffunc cardposhand int cardposhand_arg1, int cardposhand_arg2
	cardposn@tcg = (cardposhand_arg1 == TCG_CONTROLLER_OPPONENT)
	l@tcg = TCG_LANE_PLAYER_HAND * (cardposn@tcg == 0) + TCG_LANE_OPPONENT_HAND * (cardposn@tcg == 1)
	holderlistmax@tcg = clistmax@tcg(l@tcg)
	if ( holderlistmax@tcg <= 0 ) { 
		return 
	}
	repeat holderlistmax@tcg
		holderlist@tcg(cnt) = clist@tcg(cnt, l@tcg)
	loop
	if ( cardposhand_arg2 != (-1) ) {
		holderlist@tcg(holderlistmax@tcg) = cardposhand_arg2
		holderlistmax@tcg++
	}
	x2@tcg = holderspace@tcg
	if ( holderlistmax@tcg >= 7 ) {
		x2@tcg = ( holderspace@tcg * 7 ) / holderlistmax@tcg
	}
	x@tcg = basex@tcg + 222
	cnt2@tcg = 0
	repeat holderlistmax@tcg
		pp@tcg = holderlist@tcg(cnt)
		if ( card@tcg(TCG_CARD_LOCATION, pp@tcg) != TCG_LOCATION_HAND ) { 
			continue 
		}
		card@tcg(TCG_CARD_X_MOVETO, pp@tcg) = x@tcg + cnt2@tcg * x2@tcg, holderiy@tcg(cardposn@tcg)
		cnt2@tcg++
	loop
	return

#deffunc cardposgrave int cardposgrave_arg1
	repeat 2
		cardposn@tcg = cnt
		if ( cardposn@tcg != cardposgrave_arg1 & cardposgrave_arg1 != -1 ) { continue }

		p@tcg = 0
		if ( gravesum@tcg(cardposn@tcg) > 0 ) {
			repeat gravesum@tcg(cardposn@tcg)
				if ( card@tcg(TCG_CARD_CONTROLLER, gravelist@tcg(cnt, cardposn@tcg)) != cardposn@tcg ) { continue }
				if ( card@tcg(TCG_CARD_LOCATION, gravelist@tcg(cnt, cardposn@tcg)) != TCG_LOCATION_GRAVEYARD ) { continue }
				gravelist@tcg(p@tcg, cardposn@tcg) = gravelist@tcg(cnt, cardposn@tcg)
				p@tcg++
			loop
		}

		gravesum@tcg(cardposn@tcg) = p@tcg
		cpdata@tcg(TCG_PLAYER_GRAVEYARD, cardposn@tcg) = p@tcg
		repeat maxcard@tcg
			if ( card@tcg(TCG_CARD_CONTROLLER, cnt) != cardposn@tcg ) { continue }
			if ( card@tcg(TCG_CARD_LOCATION, cnt) != TCG_LOCATION_GRAVEYARD ) { continue }
			cnt2@tcg = cnt
			f@tcg = 1
			repeat gravesum@tcg(cardposn@tcg)
				if ( cnt2@tcg == gravelist@tcg(cnt, cardposn@tcg) ) {
					f@tcg = 0
					break
				}
			loop
			if ( f@tcg ) {
				gravelist@tcg(gravesum@tcg(cardposn@tcg), cardposn@tcg) = cnt2@tcg
				gravesum@tcg(cardposn@tcg)++
				cpdata@tcg(TCG_PLAYER_GRAVEYARD, cardposn@tcg)++
			}
		loop
	loop
	gosub *refresh_bg
	return

#deffunc cardposexile int cardposexile_arg1
	repeat 2
		cardposn@tcg = cnt
		if ( cardposn@tcg != cardposexile_arg1 & cardposexile_arg1 != -1 ) { continue }

		p@tcg = 0
		if ( landsum@tcg(cardposn@tcg) > 0 ) {
			repeat landsum@tcg(cardposn@tcg)
				if ( card@tcg(TCG_CARD_CONTROLLER, landlist@tcg(cnt, cardposn@tcg)) != cardposn@tcg ) { continue }
				if ( card@tcg(TCG_CARD_LOCATION, landlist@tcg(cnt, cardposn@tcg)) != TCG_LOCATION_EXILE ) { continue }
				landlist@tcg(p@tcg, cardposn@tcg) = landlist@tcg(cnt, cardposn@tcg)
				p@tcg++
			loop
		}

		landsum@tcg(cardposn@tcg) = p@tcg
		repeat maxcard@tcg
			if ( card@tcg(TCG_CARD_CONTROLLER, cnt) != cardposn@tcg ) { continue }
			if ( card@tcg(TCG_CARD_LOCATION, cnt) != TCG_LOCATION_EXILE ) { continue }
			cnt2@tcg = cnt
			f@tcg = 1
			repeat gravesum@tcg(cardposn@tcg)
				if ( cnt2@tcg == landlist@tcg(cnt, cardposn@tcg) ) {
					f@tcg = 0
					break
				}
			loop
			if ( f@tcg ) {
				landlist@tcg(landsum@tcg(cardposn@tcg), cardposn@tcg) = cnt2@tcg
				landsum@tcg(cardposn@tcg)++
			}
		loop
	loop
	gosub *refresh_bg
	return

#deffunc makecardlist
	dim clist@tcg, maxcard@tcg, 7
	dim clistmax@tcg, 7
	repeat 2
		cnt2@tcg = cnt
		lmax@tcg = 0
		if ( cnt == 0 ) {
			p@tcg = 0
		}
		else {
			p@tcg = 3
		}
		repeat maxcard@tcg
			if ( card@tcg(TCG_CARD_CONTROLLER, cnt) != cnt2@tcg ) {
				continue
			}
			if ( card@tcg(TCG_CARD_LOCATION, cnt) != TCG_LOCATION_HAND ) {
				continue
			}
			clist@tcg(lmax@tcg, p@tcg) = cnt
			lmax@tcg++
		loop
		clist@tcg(lmax@tcg, p@tcg) = -1
		clistmax@tcg(p@tcg) = lmax@tcg
		lmax@tcg = 0
		if ( cnt == 0 ) {
			p@tcg = 1
		}
		else {
			p@tcg = 2
		}
		repeat maxcard@tcg
			if ( card@tcg(TCG_CARD_CONTROLLER, cnt) != cnt2@tcg ) {
				continue
			}
			if ( card@tcg(TCG_CARD_LOCATION, cnt) != TCG_LOCATION_FIELD ) {
				continue
			}
			clist@tcg(lmax@tcg, p@tcg) = cnt
			lmax@tcg++
		loop
		clist@tcg(lmax@tcg, p@tcg) = -1
		clistmax@tcg(p@tcg) = lmax@tcg
		cpdata@tcg(TCG_PLAYER_DECK, cnt) = getdecksum(cnt)
	loop
	repeat 7
		p@tcg = cnt
		repeat
			f@tcg = 0
			repeat clistmax@tcg(p@tcg)
				c1@tcg = clist@tcg(cnt, p@tcg)
				c2@tcg = clist@tcg(cnt + 1, p@tcg)
				if ( c2@tcg == (-1) ) {
					continue
				}
				c1x@tcg = card@tcg(TCG_CARD_X_MOVETO, c1@tcg)
				c2x@tcg = card@tcg(TCG_CARD_X_MOVETO, c2@tcg)
				if ( (maxholdersum@tcg(0) > 7 & p@tcg == 0) | (maxspotsum@tcg(0) > 8 & p@tcg == 1) | (maxholdersum@tcg(1) > 7 & p@tcg == 3) | (maxspotsum@tcg(1) > 8 & p@tcg == 2) ) {
					c1x@tcg = (-1) * c1@tcg
					c2x@tcg = (-1) * c2@tcg
				}
				if ( card@tcg(TCG_CARD_REF_DBID, c1@tcg) == CREATURE_ID_ESTORK_THE_DOGGOD ) { c1x@tcg -= 1000 }
				if ( card@tcg(TCG_CARD_REF_DBID, c2@tcg) == CREATURE_ID_ESTORK_THE_DOGGOD ) { c2x@tcg -= 1000 }
				if ( card@tcg(TCG_CARD_REF_DBID, c1@tcg) == CREATURE_ID_SAIMEF_THE_DOGGOD ) { c1x@tcg += 1000 }
				if ( card@tcg(TCG_CARD_REF_DBID, c2@tcg) == CREATURE_ID_SAIMEF_THE_DOGGOD ) { c2x@tcg += 1000 }
				if ( c2x@tcg < c1x@tcg ) {
					i@tcg = clist@tcg(cnt, p@tcg)
					clist@tcg(cnt, p@tcg) = clist@tcg(cnt + 1, p@tcg)
					clist@tcg(cnt + 1, p@tcg) = i@tcg
					f@tcg = 1
					break
				}
			loop
			if ( f@tcg == 0 ) {
				break
			}
		loop
	loop
	if ( player@tcg != cp@tcg ) {
		gosub *ai_evaluate
	}
	return

#deffunc cardhelp str cardhelp_arg1, int cardhelp_arg2
	if ( helpdur@tcg > 1 ) {
		if ( cardhelp_arg2 == 0 ) {
			helpdur@tcg--
			return
		}
	}
	if ( cardhelp_arg2 == 0 ) {
		dur@tcg = 1
	}
	else {
		dur@tcg = cardhelp_arg2
	}
	helpmsg@tcg = cardhelp_arg1
	helpdur@tcg = dur@tcg
	return

#deffunc tcgdrawcard int tcgdrawcard_arg1, int tcgdrawcard_arg2
	selected@tcg = 0
	if ( tcgdrawcard_arg2 == 0 ) {
		if ( cursor@tcg ) {
			if ( cs@tcg >= 0 ) {
				if ( clist@tcg(cs@tcg, csline@tcg) == tcgdrawcard_arg1 ) {
					selected@tcg = 1
				}
			}
		}
	}
	else {
		if ( tcgdrawcard_arg1 == dlist@tcg(0, dsc@tcg) ) {
			selected@tcg = 1
		}
	}
	if ( selected@tcg ) {
		gmode 2
		pos card@tcg(TCG_CARD_X, tcgdrawcard_arg1) - 5, card@tcg(TCG_CARD_Y, tcgdrawcard_arg1) - 5
		gcopy 7, 168, 144, 82, 106
		if ( debug | cdbit(TCG_BIT_FACE_UP, tcgdrawcard_arg1) == 1 | card@tcg(TCG_CARD_CONTROLLER, tcgdrawcard_arg1) == TCG_CONTROLLER_PLAYER ) {
			cardhelp carddetailn@tcg(tcgdrawcard_arg1)
			if ( displayinfo@tcg == 1 ) {
				cardhelp carddetailneff@tcg(tcgdrawcard_arg1)
			}
		}
		else {
			cardhelp ""
		}
	}
	repeat 1 + (selected@tcg == 1)
		x@tcg = card@tcg(TCG_CARD_X, tcgdrawcard_arg1)
		y@tcg = card@tcg(TCG_CARD_Y, tcgdrawcard_arg1)
		if ( cnt == 1 ) {
			if ( card@tcg(TCG_CARD_ANIM, tcgdrawcard_arg1) != TCG_ANIM_NONE ) {
				break
			}
			x@tcg = basex@tcg + 20
			y@tcg = basey@tcg + 490
			gmode 6, , , 140
			pos x@tcg - 6, y@tcg - 6
			gcopy 7, 168, 144, 82, 106
		}
		gmode 2
		if ( card@tcg(TCG_CARD_ANIM, tcgdrawcard_arg1) == TCG_ANIM_FADE & deckmode@tcg <= 0 ) {
			gmode 4, , , card@tcg(TCG_CARD_ANIM_DURATION, tcgdrawcard_arg1) * 15
		}
		pos x@tcg, y@tcg
		if ( cdbit(TCG_BIT_FACE_UP, tcgdrawcard_arg1) == 1 | deckmode@tcg > 0 | (card@tcg(TCG_CARD_CONTROLLER, tcgdrawcard_arg1) == TCG_CONTROLLER_PLAYER & cnt == 1) | ( dbg_tcg & ( card@tcg(TCG_CARD_LOCATION, tcgdrawcard_arg1) == TCG_LOCATION_HAND | card@tcg(TCG_CARD_LOCATION, tcgdrawcard_arg1) == TCG_LOCATION_FIELD ) ) ) {
			if ( card@tcg(TCG_CARD_REF_PIC, tcgdrawcard_arg1) > 0 ) {
				gcopy 7, 72 + card@tcg(TCG_CARD_REF_BG, tcgdrawcard_arg1) * 72, 0, 72, 96
			} else {
				if ( cnt == 0 & card@tcg(TCG_CARD_REF_PIC, tcgdrawcard_arg1) < 0 ) {
					p@tcg = abs(card@tcg(TCG_CARD_REF_PIC, tcgdrawcard_arg1))
					pos x@tcg, y@tcg
					gcopy 2, p@tcg \ 22 * 72, p@tcg / 22 * 96, 72, 96
				}
			}
				if ( cnt == 0 ) {
					if ( dbg_tcg ) {
						drawnid@tcg = tcgdrawcard_arg1
						drawneff@tcg = card@tcg(TCG_CARD_EFFECT, tcgdrawcard_arg1)
						drawnturncount@tcg = card@tcg(TCG_CARD_TURN_COUNT, tcgdrawcard_arg1)
						pos x@tcg + 60 - 4 * strlen(str(drawnid@tcg)), y@tcg + 4
						color 0, 0, 0
						bmes "" + drawnid@tcg, 235, 235, 235
						pos x@tcg + 60 - 4 * strlen(str(drawneff@tcg)), y@tcg + 20
						color 0, 0, 0
						bmes "" + drawneff@tcg, 235, 235, 235
						pos x@tcg + 60 - 4 * strlen(str(drawnturncount@tcg)), y@tcg + 36
						color 0, 0, 0
						bmes "" + drawnturncount@tcg, 235, 235, 235
					}
					if ( cdbit(TCG_BIT_FACE_UP, tcgdrawcard_arg1) | dbg_tcg ) {
						if ( card@tcg(TCG_CARD_REF_TYPE, tcgdrawcard_arg1) == TCG_TYPE_CREATURE & card@tcg(TCG_CARD_ANIM, tcgdrawcard_arg1) == TCG_ANIM_NONE ) {
							drawnhp@tcg = card@tcg(TCG_CARD_HP, tcgdrawcard_arg1)
							drawnmaxhp@tcg = card@tcg(TCG_CARD_REF_HP, tcgdrawcard_arg1)
							drawnatk@tcg = card@tcg(TCG_CARD_ATTACK, tcgdrawcard_arg1)
							drawnbaseatk@tcg = card@tcg(TCG_CARD_REF_ATTACK, tcgdrawcard_arg1)
							drawncost@tcg = card@tcg(TCG_CARD_COST, tcgdrawcard_arg1)
							drawnbasecost@tcg = card@tcg(TCG_CARD_REF_COST, tcgdrawcard_arg1)
							if ( tcgdrawcard_arg2 == 1 ) {
								drawnhp@tcg = card@tcg(TCG_CARD_REF_HP, tcgdrawcard_arg1)
								drawnatk@tcg = card@tcg(TCG_CARD_REF_ATTACK, tcgdrawcard_arg1)
								drawncost@tcg = card@tcg(TCG_CARD_REF_COST, tcgdrawcard_arg1)
							}
							gmode 2
							pos x@tcg, y@tcg + 81
							gzoom 21, 15, 7, 0, 96, 35, 25
							pos x@tcg + 12 - 4 * strlen(str(drawnatk@tcg)), y@tcg + 81
							color 0, 0, 0
							if ( drawnatk@tcg == drawnbaseatk@tcg ) {
								bmes "" + drawnatk@tcg, 235, 235, 235
							} else {
								if ( drawnatk@tcg > drawnbaseatk@tcg ) {
									bmes "" + drawnatk@tcg, 125, 235, 125
								} else {
									bmes "" + drawnatk@tcg, 235, 125, 125
								}
							}
							pos x@tcg + 51, y@tcg + 81
							gzoom 21, 15, 7, 48, 96, 35, 25
							pos x@tcg + 51 + 12 - 4 * strlen(str(drawnhp@tcg)), y@tcg + 81
							color 0, 0, 0
							if ( drawnhp@tcg < drawnmaxhp@tcg ) {
								bmes "" + drawnhp@tcg, 235, 125, 125
							} else {
								bmes "" + drawnhp@tcg, 235, 235, 235
							}
							if ( card@tcg(TCG_CARD_LOCATION, tcgdrawcard_arg1) == TCG_LOCATION_HAND | tcgdrawcard_arg2 == 1 ) {
								pos x@tcg, y@tcg
								gzoom 24, 24, 7, 192, 96, 32, 32
								pos x@tcg + 12 - 3 * strlen(str(drawncost@tcg)), y@tcg + 4
								color 0, 0, 0
								if ( drawncost@tcg == drawnbasecost@tcg ) {
									bmes "" + drawncost@tcg, 235, 235, 235
								} else {
									if ( drawncost@tcg > drawnbasecost@tcg ) {
										bmes "" + drawncost@tcg, 235, 125, 125
									} else {
										bmes "" + drawncost@tcg, 125, 235, 125
									}
								}
							}
						}
					}
				}
			if ( card@tcg(TCG_CARD_REF_PIC, tcgdrawcard_arg1) > 0 ) {
				if ( card@tcg(TCG_CARD_REF_DBID, tcgdrawcard_arg1) != CREATURE_ID_USER ) {
					p@tcg = card@tcg(TCG_CARD_REF_PIC, tcgdrawcard_arg1) \ COLOR_TINT_MULT + card@tcg(TCG_CARD_REF_CHARA_PIC, tcgdrawcard_arg1) * COLOR_TINT_MULT
					chara_preparepic p@tcg, (card@tcg(TCG_CARD_REF_PIC, tcgdrawcard_arg1) - card@tcg(TCG_CARD_REF_CHARA_PIC, tcgdrawcard_arg1) * COLOR_TINT_MULT) / COLOR_TINT_MULT
				}
				else {
					p@tcg = 1
					chara_preparepic p@tcg, 0
				}
				if ( card@tcg(TCG_CARD_REF_DBID, tcgdrawcard_arg1) == CREATURE_ID_USER ) {
					gmode 2, 32, 48
					pos x@tcg + 21, y@tcg + 24
					gcopy 10, 0, 0, 32, 48
				} else {
					color 0, 0, 0
					pos x@tcg + 13, y@tcg + 32 - chipc(CHIPC_F, p@tcg) + chipc(CHIPC_HEIGHT, p@tcg) / 6
					gcopy 5, 0, 960, chipc(CHIPC_WIDTH, p@tcg), chipc(CHIPC_HEIGHT, p@tcg)
					if ( card@tcg(TCG_CARD_REF_DBID, tcgdrawcard_arg1) == CREATURE_ID_JALDABAOTH_THE_CHAOS_CHILD & cdbit(TCG_BIT_COMMAND, tcgdrawcard_arg1) == 0 ) {
						pos x@tcg + 13 - 48, y@tcg + 32 - chipc(CHIPC_F, p@tcg) + chipc(CHIPC_HEIGHT, p@tcg) / 6
						gmode 2, 144, 96
						gcopy BUFFER_INF, 908 + rnd(3) * 144, 494
						gmode 2
					}
				}
			}
			color 255, 255, 255
		}
		else {
			gcopy 7, 0, 0, 72, 96
		}
		if ( cnt == 0 ) {
			if ( card@tcg(TCG_CARD_LOCATION, tcgdrawcard_arg1) == TCG_LOCATION_HAND ) {
				if ( cdbit(TCG_BIT_FACE_UP, tcgdrawcard_arg1) & card@tcg(TCG_CARD_REF_TYPE, tcgdrawcard_arg1) == TCG_TYPE_CREATURE ) {
					p@tcg = 0
					if ( cdbit(TCG_BIT_SILENCED, tcgdrawcard_arg1) == 1 ) {
						pos x@tcg, y@tcg + 69 - 13 * p@tcg
						color 0, 0, 0
						bmes "Silenced", 235, 125, 125 
						p@tcg++
					}
					if ( cdbit(TCG_BIT_CONFUSED, tcgdrawcard_arg1) == 1 ) {
						pos x@tcg, y@tcg + 69 - 13 * p@tcg
						color 0, 0, 0
						bmes "Confused", 235, 125, 125
						p@tcg++
					}
					if ( cdbit(TCG_BIT_POISONED, tcgdrawcard_arg1) == 1 ) {
						pos x@tcg, y@tcg + 69 - 13 * p@tcg
						color 0, 0, 0
						bmes "Poisoned", 235, 125, 125
						p@tcg++
					}
				}
			}
			if ( card@tcg(TCG_CARD_LOCATION, tcgdrawcard_arg1) == TCG_LOCATION_FIELD ) {
				if ( cdbit(TCG_BIT_FACE_UP, tcgdrawcard_arg1) ) {
					if ( card@tcg(TCG_CARD_REF_TYPE, tcgdrawcard_arg1) == TCG_TYPE_CREATURE ) {
						p@tcg = 0
						repeat 128
							if ( cdbit(cnt, tcgdrawcard_arg1) == 1 ) {
								pos x@tcg, y@tcg + 69 - 13 * p@tcg
								color 0, 0, 0
								if ( cnt == TCG_BIT_REGENERATION ) { 
									bmes "Regeneration", 235, 235, 235 
									p@tcg++
								}
								if ( cnt == TCG_BIT_ARMOR ) { 
									bmes "Armored", 235, 235, 235 
									p@tcg++
								}
								if ( cnt == TCG_BIT_FLYING ) { 
									bmes "Flying", 235, 235, 235 
									p@tcg++
								}
								if ( cnt == TCG_BIT_INTIMIDATE ) { 
									bmes "Intimidate", 235, 235, 235 
									p@tcg++
								}
								if ( cnt == TCG_BIT_REACH ) { 
									bmes "Reach", 235, 235, 235 
									p@tcg++
								}
								if ( cnt == TCG_BIT_LIFELINK ) { 
									bmes "Lifelink", 235, 235, 235 
									p@tcg++
								}
								// if ( cnt == TCG_BIT_HASTE ) { bmes "Regeneration", 235, 235, 235 }
								if ( cnt == TCG_BIT_TRAMPLE ) { 
									bmes "Trample", 235, 235, 235 
									p@tcg++
								}
								if ( cnt == TCG_BIT_FIRST_STRIKE ) { 
									bmes "First Strike", 235, 235, 235 
									p@tcg++
								}
								if ( cnt == TCG_BIT_DOUBLE_STRIKE ) { 
									bmes "Dual Strike", 235, 235, 235
									p@tcg++
								}
								if ( cnt == TCG_BIT_DEATHTOUCH ) { 
									bmes "Deathtouch", 235, 235, 235 
									p@tcg++
								}
								if ( cnt == TCG_BIT_CRITICAL ) { 
									bmes "Critical", 235, 235, 235 
									p@tcg++
								}
								// if ( cnt == TCG_BIT_WINDFURY ) { bmes "Windfury", 235, 235, 235 }
								if ( cnt == TCG_BIT_WINDFURY_USABLE ) { 
									bmes "Windfury", 235, 235, 235 
									p@tcg++
								}
								if ( cnt == TCG_BIT_VIGILANCE ) { 
									bmes "Vigilance", 235, 235, 235 
									p@tcg++
								}
								if ( cnt == TCG_BIT_DEFENDER ) { 
									bmes "Defender", 235, 235, 235 
									p@tcg++
								}
								if ( cnt == TCG_BIT_SPLIT ) { 
									bmes "Split", 235, 235, 235 
									p@tcg++
								}
								if ( cnt == TCG_BIT_RIDER ) { 
									bmes "Rider", 235, 235, 235 
									p@tcg++
								}
								if ( cnt == TCG_BIT_BARRIER ) { 
									bmes "Barrier", 235, 235, 235 
									p@tcg++
								}
								if ( cnt == TCG_BIT_EVASION ) { 
									bmes "Evasion", 235, 235, 235 
									p@tcg++
								}

								if ( cnt == TCG_BIT_DEATHWORD ) { 
									bmes "Deathword", 235, 125, 125 
									p@tcg++
								}
								if ( cnt == TCG_BIT_GRAVITY ) { 
									bmes "Gravity", 235, 125, 125 
									p@tcg++
								}
								if ( cnt == TCG_BIT_BLEEDING ) { 
									bmes "Bleeding", 235, 125, 125 
									p@tcg++
								}
								if ( cnt == TCG_BIT_POISONED ) { 
									bmes "Poisoned", 235, 125, 125 
									p@tcg++
								}
								if ( cnt == TCG_BIT_SUICIDE ) { 
									bmes "EXPLODING!", 235, 125, 125 
									p@tcg++
								}
								if ( cnt == TCG_BIT_PARALYSED ) { 
									bmes "Paralysed", 235, 125, 125 
									p@tcg++
								}
								if ( cnt == TCG_BIT_SILENCED ) { 
									bmes "Silenced", 235, 125, 125 
									p@tcg++
								}
								if ( cnt == TCG_BIT_FROZEN ) { 
									bmes "Frozen", 235, 125, 125 
									p@tcg++
								}
								if ( cnt == TCG_BIT_GHOST ) { 
									bmes "Ghost", 235, 235, 125 
									p@tcg++
								}
								if ( cnt == TCG_BIT_INSANE ) { 
									bmes "Insane", 235, 125, 125 
									p@tcg++
								}
								if ( cnt == TCG_BIT_CONFUSED ) { 
									bmes "Confused", 235, 125, 125 
									p@tcg++
								}
							}
						loop
						if ( card@tcg(TCG_CARD_STATUS, tcgdrawcard_arg1) == TCG_ACTION_ATTACKING ) {
							pos x@tcg, y@tcg + 18
							gcopy 7, 288, 120, 24, 24
						}
						if ( card@tcg(TCG_CARD_STATUS, tcgdrawcard_arg1) == TCG_ACTION_DEFENDING ) {
							pos x@tcg, y@tcg + 18
							gcopy 7, 312, 120, 24, 24
						}
						if ( card@tcg(TCG_CARD_STATUS, tcgdrawcard_arg1) == TCG_ACTION_INVOKING ) {
							pos x@tcg, y@tcg + 18
							gcopy 7, 264, 120, 24, 24
						}
						if ( card@tcg(TCG_CARD_STATUS, tcgdrawcard_arg1) == TCG_ACTION_EXHAUSTED ) {
							pos x@tcg, y@tcg + 18
							gcopy 7, 240, 120, 24, 24
						}
					}
				}
			}
		}
	loop
	return

#deffunc tcgpass int tcgpass_arg1
	animeframes@tcg = tcgpass_arg1 * cfg_tcganimewait / limit(timespentdraw@tcg, cfg_tcganimewait, 120) / 2
	animeseqbk@tcg = animeseq@tcg
	animeseq@tcg = 2
	repeat limit(animeframes@tcg, 1, 50)
		tcgdraw
	loop
	animeseq@tcg = animeseqbk@tcg
	return

#deffunc tcgdraw
	if ( animeseq@tcg == 1 ) { return }
	if ( debug ) {
		title " L:" + looplev + " S:" + sublev
	}
	*tcgdraw_WHILE1
	t@tcg++
	redraw 0
	gosub *tcg_drawInterface
	anime@tcg = 0
	font lang(cfg_font1, cfg_font2), 12 + en - en * 2, 0
	color 255, 255, 255
	gmode 2
	repeat 2
		x@tcg = holderix@tcg(cnt) - holderspace@tcg
		y@tcg = holderiy@tcg(cnt)
		pos x@tcg, y@tcg
		gcopy 7, 96, 144, 72, 96
		pos x@tcg + 14, y@tcg + 75
		mes "" + cpdata@tcg(TCG_PLAYER_DECK, cnt) + "/" + cpdata@tcg(TCG_PLAYER_GRAVEYARD, cnt)
	loop
	font lang(cfg_font1, cfg_font2), 13 + en - en * 2, 0
	// Calculate the time spent draw, normally the logic between draw takes about 1/8 of the draw.
	drawcardcount@tcg = 0
	currenttime1@tcg = gettime(7)
	drawpace@tcg = limit(cfg_tcganimewait * 6 /limit(timespentdraw@tcg,cfg_tcganimewait,120),2,6), limit(timespentdraw@tcg/cfg_tcganimewait, 1, 5)
	// title "/" + timespentdraw@tcg + "/" + drawpace@tcg(0) + "/" + drawpace@tcg(1)
	repeat maxcard@tcg
		c@tcg = maxcard@tcg - cnt - 1
		if ( cc@tcg != 0 ) {
			if ( c@tcg == 0 ) {
				c@tcg = cc@tcg
			}
			else {
				if ( c@tcg == cc@tcg ) {
					c@tcg = 0
				}
			}
		}
		if ( card@tcg(TCG_CARD_LOCATION, c@tcg) <= 0 ) {
			if ( card@tcg(TCG_CARD_ANIM_DURATION, c@tcg) <= 0 ) {
				continue
			}
		}
		if ( card@tcg(TCG_CARD_LOCATION, c@tcg) == TCG_LOCATION_EXILE ) {
			continue
		}
		if ( card@tcg(TCG_CARD_X, c@tcg) != card@tcg(TCG_CARD_X_MOVETO, c@tcg) | card@tcg(TCG_CARD_Y, c@tcg) != card@tcg(TCG_CARD_Y_MOVETO, c@tcg) | card@tcg(TCG_CARD_ANIM_DURATION, c@tcg) > 0 ) {
			anime@tcg = 1
			p@tcg = 0
			drawcardcount@tcg++
			drawpace@tcg(0) = limitmax(drawpace@tcg(0), limit(40/limit(drawcardcount@tcg,1,40),2,6))
			if ( card@tcg(TCG_CARD_X, c@tcg) != card@tcg(TCG_CARD_X_MOVETO, c@tcg) ) {
				p@tcg = (card@tcg(TCG_CARD_X_MOVETO, c@tcg) - card@tcg(TCG_CARD_X, c@tcg)) / drawpace@tcg(0)
				if ( card@tcg(TCG_CARD_X, c@tcg) > card@tcg(TCG_CARD_X_MOVETO, c@tcg) ) {
					p@tcg--
				}
				else {
					p@tcg++
				}
			}
			card@tcg(TCG_CARD_X, c@tcg) += p@tcg
			p@tcg = 0
			if ( card@tcg(TCG_CARD_Y, c@tcg) != card@tcg(TCG_CARD_Y_MOVETO, c@tcg) ) {
				p@tcg = (card@tcg(TCG_CARD_Y_MOVETO, c@tcg) - card@tcg(TCG_CARD_Y, c@tcg)) / drawpace@tcg(0)
				if ( card@tcg(TCG_CARD_Y, c@tcg) > card@tcg(TCG_CARD_Y_MOVETO, c@tcg) ) {
					p@tcg--
				}
				else {
					p@tcg++
				}
			}
			card@tcg(TCG_CARD_Y, c@tcg) += p@tcg
			if ( card@tcg(TCG_CARD_ANIM_DURATION, c@tcg) > 0 ) {
				card@tcg(TCG_CARD_ANIM_DURATION, c@tcg) -= limitmax(drawpace@tcg(1), card@tcg(TCG_CARD_ANIM_DURATION, c@tcg))
			}
		}
		if ( card@tcg(TCG_CARD_LOCATION, c@tcg) == TCG_LOCATION_ANIM ) { continue }
		tcgdrawcard c@tcg
	loop
	repeat maxcard@tcg
		c@tcg = maxcard@tcg - cnt - 1
		if ( card@tcg(TCG_CARD_LOCATION, c@tcg) != TCG_LOCATION_ANIM ) { continue }
		tcgdrawcard c@tcg
	loop
	font lang(cfg_font1, cfg_font2), 14 - en * 2, 0
	color 255, 255, 255
	gmode 2
	if ( cursor@tcg ) {
		if ( cs@tcg == (-1) ) {
			if ( phase@tcg == 2 ) {
				if ( selectmode@tcg == 0 ) {
					cardhelp lang("メインフェイズを終了する。", "End your main phase.")
				}
				if ( selectmode@tcg == 1 ) {
					cardhelp lang("ブロックしない。", "No blocker.")
				}
				if ( selectmode@tcg == 2 ) {
					cardhelp lang("ランダムに選ぶ。", "Choose Randomly.")
				}
			}
			pos holderix@tcg - holderspace@tcg - 5, holderiy@tcg - 5
			gcopy 7, 168, 144, 82, 106
		}
	}
	if ( chaintime@tcg > 0 ) {
		if ( chaintime@tcg == cfg_chaintime ) {
			dim star@tcg, 2, 10
			repeat 10
				star@tcg(0, cnt) = rnd(72) - 32, rnd(40) - 32
			loop
		}
		if ( chaintime@tcg > 5 ) {
			gmode 5, , , limit(chaintime@tcg * 3 - 40, 0, 255)
			color 0, 0, 0
			cnt2@tcg = cnt
			repeat 10
				pos chainx@tcg + star@tcg(0, cnt), chainy@tcg + star@tcg(1, cnt)
				gcopy 7, 64 * limit(17 - chaintime@tcg / 3, 0, 8), 416, 64, 64
				star@tcg(1, cnt) += 2
			loop
		}
		repeat 3
			p@tcg = (t@tcg / 4 + cnt) \ 7
			color p@tcg * 20, 25 + p@tcg * 20, 60 + p@tcg * 20
			boxl chainx@tcg - p@tcg, chainy@tcg - p@tcg, chainx@tcg + 72 + p@tcg, chainy@tcg + 96 + p@tcg
		loop
	}
	repeat efllistmax@tcg
		if ( efllist@tcg(4, cnt) <= 0 ) {
			continue
		}
		efllist@tcg(4, cnt) -= limitmax(drawpace@tcg(1), efllist@tcg(4, cnt))
		if ( efllist@tcg(0, cnt) == -1 ) {
			pos efllist@tcg(5, cnt), efllist@tcg(6, cnt)
			color 0, 0, 0
			bmes efllisttalk@tcg(cnt), 120, 255, 120
		}
		if ( efllist@tcg(0, cnt) == 1 ) {
			font lang(cfg_font1, cfg_font2), 20 - en * 2, 1
			color 0, 0, 0
			pos efllist@tcg(5, cnt) + 11, efllist@tcg(6, cnt) + efllist@tcg(4, cnt) / 3 + 21
			mes abs(efllist@tcg(1, cnt))
			color 255, 100, 100
			if ( efllist@tcg(1, cnt) > 0 ) {
				color 100, 255, 100
			}
			pos efllist@tcg(5, cnt) + 10, efllist@tcg(6, cnt) + efllist@tcg(4, cnt) / 3 + 20
			mes abs(efllist@tcg(1, cnt))
			font lang(cfg_font1, cfg_font2), 13 - en * 2, 0
			gmode 5, , , (efllist@tcg(4, cnt) - 30) * 8
			color 0, 0, 0
			pos efllist@tcg(5, cnt) - 12, efllist@tcg(6, cnt) + 10
			gcopy 7, 64 * limit(10 - (efllist@tcg(4, cnt) - 30) / 3, 0, 8), 360, 48, 64
		}
		if ( efllist@tcg(0, cnt) == 2 ) {
			font lang(cfg_font1, cfg_font2), 20 - en * 2, 1
			color 0, 0, 0
			pos efllist@tcg(2, cnt) + 31, efllist@tcg(3, cnt) + efllist@tcg(4, cnt) / 3 + 26
			mes abs(efllist@tcg(1, cnt))
			color 100, 100, 255
			pos efllist@tcg(2, cnt) + 30, efllist@tcg(3, cnt) + efllist@tcg(4, cnt) / 3 + 25
			mes abs(efllist@tcg(1, cnt))
			font lang(cfg_font1, cfg_font2), 13 - en * 2, 0
			color 255, 255, 255
			gmode 5, , , (efllist@tcg(4, cnt) - 30) * 8
			color 0, 0, 0
			pos efllist@tcg(5, cnt), efllist@tcg(6, cnt) + 24
			gcopy 7, 64 * limit(10 - (efllist@tcg(4, cnt) - 30) / 3, 0, 8), 416, 64, 64
			pos efllist@tcg(2, cnt), efllist@tcg(3, cnt) + 24
			gcopy 7, 64 * limit(10 - (efllist@tcg(4, cnt) - 30) / 3, 0, 8), 416, 64, 64
		}
		if ( efllist@tcg(0, cnt) == 3 ) {
			gmode 5, , , 120
			color 0, 0, 0
			pos efllist@tcg(5, cnt), efllist@tcg(6, cnt)
			gcopy 7, efllist@tcg(2, cnt) + 72 * limit(efllist@tcg(1, cnt) - 1 - (efllist@tcg(4, cnt) / animespeed@tcg), 0, efllist@tcg(1, cnt) - 1), efllist@tcg(3, cnt), 64, 64
		}
		if ( efllist@tcg(0, cnt) == 4 ) {
			gmode 2, 48, 48
			color 0, 0, 0
			pos efllist@tcg(5, cnt), efllist@tcg(6, cnt)
			grotate 7, efllist@tcg(2, cnt) + 48 * limit(efllist@tcg(1, cnt) - 1 - (efllist@tcg(4, cnt) / animespeed@tcg), 0, efllist@tcg(1, cnt) - 1), efllist@tcg(3, cnt), 0, 48, 48
		}
		if ( efllist@tcg(0, cnt) >= 5 & efllist@tcg(0, cnt) <= 23 ) {
			gmode 2, 96, 96
			color 0, 0, 0
			pos efllist@tcg(5, cnt), efllist@tcg(6, cnt)
			grotate 7, efllist@tcg(2, cnt) + 96 * limit(efllist@tcg(1, cnt) - 1 - (efllist@tcg(4, cnt) / animespeed@tcg / 2), 0, efllist@tcg(1, cnt) - 1), efllist@tcg(3, cnt), 0, 96, 96
		}
	loop
	gmode 2
	if ( screenupdate@tcg == (-1) ) {
		screenupdate@tcg = 0
		goto *tcgdraw_WEND1
	}
	else {
		currenttime2@tcg = gettime(7)
		timespentdraw@tcg = (currenttime2@tcg - currenttime1@tcg) + (currenttime1@tcg > currenttime2@tcg) * 1000
		timeawait@tcg = limit(cfg_tcganimewait - timespentdraw@tcg, 1, cfg_tcganimewait)
		await timeawait@tcg
		redraw 1
	}
	redraw 1
	if ( anime@tcg == 0 | animeseq@tcg == 2 ) {
		goto *tcgdraw_WEND1
	}
	goto *tcgdraw_WHILE1
	*tcgdraw_WEND1
	return

#deffunc efllistaddcard int efllistadd_arg1, int efllistadd_arg2, int efllistadd_arg3, int efllistadd_arg4
	proctcg "tcg efllistaddcard: efllistadd_arg1:" + efllistadd_arg1 + "/efllistadd_arg2:" + efllistadd_arg2 + "/efllistadd_arg3:" + efllistadd_arg3 + "/efllistadd_arg4:" + efllistadd_arg4
	if ( efllistadd_arg2 < 0 | efllistadd_arg2 >= maxcard@tcg ) { return }
	if ( efllistadd_arg3 != 1 & card@tcg(TCG_CARD_LOCATION, efllistadd_arg2) <= 0 ) { return }
	// Middle of card.
	elax@tcg = 36
	elay@tcg = 48
	if ( efllistadd_arg4 == 1 ) { // Cost
		elax@tcg = 12
		elay@tcg = 12
	}
	if ( efllistadd_arg4 == 2 ) { // Attack
		elax@tcg = 10
		elay@tcg = 88
	}
	if ( efllistadd_arg4 == 3 ) { // HP
		elax@tcg = 61
		elay@tcg = 88
	}
	efllistadd efllistadd_arg1, 0, card@tcg(TCG_CARD_X, efllistadd_arg2) + elax@tcg, card@tcg(TCG_CARD_Y, efllistadd_arg2) + elay@tcg
	return

#deffunc efllistaddchat str efllistadd_argstr, int efllistadd_arg2, int efllistadd_arg3
	proctcg "tcg efllistaddchat: efllistadd_argstr:" + efllistadd_argstr + "/efllistadd_arg2:" + efllistadd_arg2 + "/efllistadd_arg3:" + efllistadd_arg3
	if ( efllistadd_arg2 < 0 | efllistadd_arg2 >= maxcard@tcg ) { return }
	if ( efllistadd_arg3 != 1 & card@tcg(TCG_CARD_LOCATION, efllistadd_arg2) <= 0 ) { return }
	sprint@tcg = efllistadd_argstr
	if ( strlen(sprint@tcg) <= 0 ) { return }
	elax@tcg = 36 - strlen(sprint@tcg) * ((16 - en * 2) / 2 / 2)
	elay@tcg = -14
	eflistaddchatstr@tcg = efllistadd_argstr
	efllistadd -1, 0, card@tcg(TCG_CARD_X, efllistadd_arg2) + elax@tcg, card@tcg(TCG_CARD_Y, efllistadd_arg2) + elay@tcg
	return

#deffunc efllistadd int efllistadd_arg1, int efllistadd_arg2, int efllistadd_arg3, int efllistadd_arg4, int efllistadd_arg5, int efllistadd_arg6
	repeat efllistmax@tcg
		if ( efllist@tcg(4, cnt) <= 0 ) {
			efllist@tcg(0, cnt) = efllistadd_arg1
			efllist@tcg(1, cnt) = efllistadd_arg2
			if ( efllistadd_arg1 == -1 ) {
				efllisttalk@tcg(cnt) = eflistaddchatstr@tcg
				efllist@tcg(4, cnt) = 60
				efllist@tcg(5, cnt) = efllistadd_arg3, efllistadd_arg4
			}
			if ( efllistadd_arg1 == 1 ) {
				efllist@tcg(4, cnt) = 60
				efllist@tcg(5, cnt) = efllistadd_arg3 + rnd(30), efllistadd_arg4 + rnd(20)
			}
			if ( efllistadd_arg1 == 2 ) {
				efllist@tcg(4, cnt) = 60
				efllist@tcg(5, cnt) = efllistadd_arg3, efllistadd_arg4
				efllist@tcg(2, cnt) = efllistadd_arg5, efllistadd_arg6
			}
			if ( efllistadd_arg1 == 3 ) {
				efllist@tcg(1, cnt) = 2, 8, 576
				efllist@tcg(4, cnt) = efllist@tcg(1, cnt) * animespeed@tcg
				efllist@tcg(5, cnt) = efllistadd_arg3 - 32, efllistadd_arg4 - 32
			}
			if ( efllistadd_arg1 == 4 ) {
				efllist@tcg(1, cnt) = 10, 336, 1248
				efllist@tcg(4, cnt) = efllist@tcg(1, cnt) * animespeed@tcg
				efllist@tcg(5, cnt) = efllistadd_arg3, efllistadd_arg4
			}
			if ( efllistadd_arg1 >= 5 & efllistadd_arg1 <= 17 ) {
				efllist@tcg(1, cnt) = 5 + 1 * (efllistadd_arg1 != 7), 720, (efllistadd_arg1 - 5) * 96
				efllist@tcg(4, cnt) = efllist@tcg(1, cnt) * animespeed@tcg
				efllist@tcg(5, cnt) = efllistadd_arg3, efllistadd_arg4
			}
			if ( efllistadd_arg1 >= 18 & efllistadd_arg1 <= 23 ) {
				efllist@tcg(1, cnt) = 5 + 1 * (efllistadd_arg1 > 20), 0, 640 + (efllistadd_arg1 - 18) * 96
				efllist@tcg(4, cnt) = efllist@tcg(1, cnt) * animespeed@tcg * 2
				efllist@tcg(5, cnt) = efllistadd_arg3, efllistadd_arg4
			}
			break
		}
	loop
	eflistaddchatstr@tcg = ""
	return

#deffunc reconstruct_card_text int reconstruct_card_text_arg1_aeft
	if ( reconstruct_card_text_arg1_aeft < 0 | reconstruct_card_text_arg1_aeft >= maxcard@tcg ) { return }
	carddetailneffbk@tcg = carddetailneff@tcg(reconstruct_card_text_arg1_aeft)
	sdim lines@tcg
	split carddetailneff@tcg(reconstruct_card_text_arg1_aeft), "\n", lines@tcg
	f@tcg = stat
	if ( f@tcg >= 1 ) {
		carddetailneff@tcg(reconstruct_card_text_arg1_aeft) = lines@tcg(0)
		if ( f@tcg >= 2 & instr(carddetailneffbk@tcg, 0, "Bits:  ") != -1 ) {
			carddetailneff@tcg(reconstruct_card_text_arg1_aeft) += "\n" + lines@tcg(1)
		}
		carddetailneffbk@tcg = "Effect: " + effdesc@tcg(card@tcg(TCG_CARD_EFFECT, reconstruct_card_text_arg1_aeft))
		talk_conv carddetailneffbk@tcg, 65
		carddetailneff@tcg(reconstruct_card_text_arg1_aeft) += "\n" + carddetailneffbk@tcg
	}
	f@tcg = stat
	return

#deffunc card_ref int card_ref_arg1
	cardrefcost = 0
	cardrefhp = 0
	cardrefattack = 0
	cardrefdomain = 0
	cardrefrare = 100
	dbid = card_ref_arg1
	gosub *db_card@
	gosub *db_card_custom
	if ( cardreftype == 0 ) {
		cardreftype = 10
		cardrefdomain = 7
	}
	rtvaln = cardrefn
	if ( cardreftype == 10 ) {
		cardrefbg = cardrefdomain
		rtvaln += lang("  No.", "  No.") + cardrefno
	}
	if ( cardreftype == 30 ) {
		cardrefbg = 6
		rtvaln += lang(" <土地>", " <Land>")
	}
	if ( cardreftype == 20 ) {
		cardrefbg = 5
		rtvaln += lang(" <スペル>", " <Spell>")
	}
	// rtvaln += lang("  ランク:", "  Rank:") + cardrefcost
	rtvaln += " "
	if ( cardrefsex != "random" ) { rtvaln += " " + cardrefsex }
	rtvaln += " " + cardrefrace + " " + cardrefclass
	rtvaln += lang("  レア度:", "  Rare:") + cnvrare(cardrefrare)
	rtvaln2 = rtvaln
	s@tcg = ""
	s@tcg += lang("情報: ", "Data: " ) + cardrefdescription
	if ( gdata(GDATA_QUICK_USE) == 1 ) {
		talk_conv s@tcg, 95
	}
	else {
		talk_conv s@tcg, 100
	}
	rtvaln += "\n" + s@tcg
	s@tcg = ""
	if ( cardrefbits != "" ) {
		s@tcg += "Bits:  "
		s2@tcg = cardrefbits
		csvstr2 s2@tcg, s2@tcg
		repeat
			if ( s2@tcg(cnt) == "" ) {
				break
			}
			p@tcg = int(s2@tcg(cnt))
			if ( cnt >= 40 | p@tcg == 0 ) {
				break
			}
			if ( p@tcg == TCG_BIT_REGENERATION ) { s@tcg += "Regeneration "}
			if ( p@tcg == TCG_BIT_ARMOR ) { s@tcg += "Armored "}
			if ( p@tcg == TCG_BIT_FLYING ) { s@tcg += "Flying "}
			if ( p@tcg == TCG_BIT_INTIMIDATE ) { s@tcg += "Intimidate "}
			if ( p@tcg == TCG_BIT_REACH ) { s@tcg += "Reach "}
			if ( p@tcg == TCG_BIT_LIFELINK ) { s@tcg += "Lifelink "}
			if ( p@tcg == TCG_BIT_HASTE ) { s@tcg += "Haste "}
			if ( p@tcg == TCG_BIT_TRAMPLE ) { s@tcg += "Trample "}
			if ( p@tcg == TCG_BIT_FIRST_STRIKE ) { s@tcg += "First-Strike "}
			if ( p@tcg == TCG_BIT_DOUBLE_STRIKE ) { s@tcg += "Dual-Strike "}
			if ( p@tcg == TCG_BIT_DEATHTOUCH ) { s@tcg += "Deathtouch "}
			if ( p@tcg == TCG_BIT_CRITICAL ) { s@tcg += "Critical "}
			if ( p@tcg == TCG_BIT_WINDFURY ) { s@tcg += "Windfury "}
			if ( p@tcg == TCG_BIT_VIGILANCE ) { s@tcg += "Vigilance "}
			if ( p@tcg == TCG_BIT_DEFENDER ) { s@tcg += "Defender "}
			if ( p@tcg == TCG_BIT_SPLIT ) { s@tcg += "Splits "}
			if ( p@tcg == TCG_BIT_RIDER ) { s@tcg += "Rider "}
			if ( p@tcg == TCG_BIT_BARRIER ) { s@tcg += "Barrier "}
			if ( p@tcg == TCG_BIT_EVASION ) { s@tcg += "Evasion "}
			
			if ( p@tcg == TCG_BIT_DEATHWORD ) { s@tcg += "Deathword "}
			if ( p@tcg == TCG_BIT_GRAVITY ) { s@tcg += "Gravity "}
			if ( p@tcg == TCG_BIT_BLEEDING ) { s@tcg += "Bleeding "}
			if ( p@tcg == TCG_BIT_POISONED ) { s@tcg += "Poisoned "}
			if ( p@tcg == TCG_BIT_SUICIDE ) { s@tcg += "Kamikaze "}
			if ( p@tcg == TCG_BIT_PARALYSED ) { s@tcg += "Paralysed "}
			if ( p@tcg == TCG_BIT_SILENCED ) { s@tcg += "Silenced "}
			if ( p@tcg == TCG_BIT_FROZEN ) { s@tcg += "Frozen "}
			if ( p@tcg == TCG_BIT_INSANE ) { s@tcg += "Insane "}
			if ( p@tcg == TCG_BIT_CONFUSED ) { s@tcg += "Confused "}

			if ( p@tcg == TCG_BIT_YERLES ) { s@tcg += "<Yerles> "}
			if ( p@tcg == TCG_BIT_XEREN ) { s@tcg += "<Xeren> "}
			if ( p@tcg == TCG_BIT_FLAMETOWER ) { s@tcg += "<Flame> "}
			if ( p@tcg == TCG_BIT_FIGHTERGUILD ) { s@tcg += "<Fighter Guild> "}
			if ( p@tcg == TCG_BIT_THIEFGUILD ) { s@tcg += "<Thief Guild> "}
			if ( p@tcg == TCG_BIT_MAGEGUILD ) { s@tcg += "<Mage Guild> "}
			if ( p@tcg == TCG_BIT_ZANAN ) { s@tcg += "<Zanan> "}
			if ( p@tcg == TCG_BIT_BARIUS ) { s@tcg += "<Barius> "}
			if ( p@tcg == TCG_BIT_EULDERNA ) { s@tcg += "<Eulderna> "}
			if ( p@tcg == TCG_BIT_ELEAREFUGEE ) { s@tcg += "<Elea> "}
			if ( p@tcg == TCG_BIT_BANDIT ) { s@tcg += "<Bandit> "}
			if ( p@tcg == TCG_BIT_JUERE ) { s@tcg += "<Juere> "}
			if ( p@tcg == TCG_BIT_MERCENARY ) { s@tcg += "<Mercenary> "}
			if ( p@tcg == TCG_BIT_ZAILE ) { s@tcg += "<Zaile> "}
			if ( p@tcg == TCG_BIT_CITIZEN ) { s@tcg += "<Citizen> "}
			if ( p@tcg == TCG_BIT_NINJA ) { s@tcg += "<Ninja> "}
			if ( p@tcg == TCG_BIT_ADVENTURER ) { s@tcg += "<Adventurer> "}
			if ( p@tcg == TCG_BIT_SENSEI ) { s@tcg += "<Teacher> "}
			if ( p@tcg == TCG_BIT_PIRATE ) { s@tcg += "<Pirate> "}
			if ( p@tcg == TCG_BIT_ELEAMOB ) { s@tcg += "<Elea Mob> "}
			
			if ( p@tcg == TCG_BIT_WINDFURY_USABLE ) { s@tcg += "Windfury(1) "}
			if ( p@tcg == TCG_BIT_ENEMY ) { s@tcg += "[Summoned on Opponent Field] "}
			if ( p@tcg == TCG_BIT_ASSASSIN ) { s@tcg += "[Starts in Opponent Deck] "}
			if ( p@tcg == TCG_BIT_TEMPO ) { s@tcg += "[Drawn when Mana=Cost] "}
			if ( p@tcg == TCG_BIT_CONSTANT ) { s@tcg += "[Starts in your Hand] "}
			if ( p@tcg == TCG_BIT_MILLSUMMON ) { s@tcg += "[Summon itself when Sent to Graveyard from Deck] "}
			if ( p@tcg == TCG_BIT_DEVIL ) { s@tcg += "[Effect Cost 2 Life] "}
			if ( p@tcg == TCG_BIT_GHOST ) { s@tcg += "[Return on Begin Phase] "}
			if ( p@tcg == TCG_BIT_FLEETING ) { s@tcg += "[Discard if not Played] "}
			if ( p@tcg == TCG_BIT_PUMPKIN ) { s@tcg += "[Summoned into Opponent Deck / Gain [OnDraw:Discard&Draw1]] "}
			if ( p@tcg == TCG_BIT_SURGE ) { s@tcg += "[After Drawn: Discard this and Draw 1] "}
			if ( p@tcg == TCG_BIT_COMMAND ) { s@tcg += "[Command Card] "}
			if ( p@tcg == TCG_BIT_FOSSIL ) { s@tcg += "[Does Nothing until Unfossiled/Graved] "}
		loop
		rtvaln2 += "\n" + s@tcg
		s@tcg = ""
	}
	s@tcg += lang("Effect: ", "Effect: ")
	s@tcg += cardrefskill
	if ( gdata(GDATA_QUICK_USE) == 1 ) {
		talk_conv s@tcg, 65
	}
	else {
		talk_conv s@tcg, 70
	}
	rtvaln2 += "\n" + s@tcg
	return dbid

#deffunc create_card int create_card_arg1, int create_card_arg2
	card_ref create_card_arg2
	card@tcg(TCG_CARD_REF_DBID, create_card_arg1) = stat
	card@tcg(TCG_CARD_REF_TYPE, create_card_arg1) = cardreftype
	cardn@tcg(TCG_CARDN_REF_RACE, create_card_arg1) = cardrefrace
	cardn@tcg(TCG_CARDN_REF_CLASS, create_card_arg1) = cardrefclass
	cardn@tcg(TCG_CARDN_REF_SEX, create_card_arg1) = cardrefsex
	card@tcg(TCG_CARD_REF_DOMAIN, create_card_arg1) = cardrefdomain
	card@tcg(TCG_CARD_REF_COST, create_card_arg1) = cardrefcost
	card@tcg(TCG_CARD_REF_HP, create_card_arg1) = cardrefhp
	card@tcg(TCG_CARD_REF_ATTACK, create_card_arg1) = cardrefattack
	card@tcg(TCG_CARD_REF_ORG_COST, create_card_arg1) = cardrefcost
	card@tcg(TCG_CARD_REF_ORG_HP, create_card_arg1) = cardrefhp
	card@tcg(TCG_CARD_REF_ORG_ATTACK, create_card_arg1) = cardrefattack
	card@tcg(TCG_CARD_COST, create_card_arg1) = cardrefcost
	card@tcg(TCG_CARD_HP, create_card_arg1) = cardrefhp
	card@tcg(TCG_CARD_ATTACK, create_card_arg1) = cardrefattack
	card@tcg(TCG_CARD_EFFECT, create_card_arg1) = cardrefskillid
	card@tcg(TCG_CARD_REF_SKILL_COST, create_card_arg1) = cardrefskillcost
	cardn@tcg(TCG_CARDN_REF_SKILL, create_card_arg1) = cardrefskill
	card@tcg(TCG_CARD_REF_PIC, create_card_arg1) = cardrefpic
	card@tcg(TCG_CARD_REF_CHARA_PIC, create_card_arg1) = cardrefpicchar
	card@tcg(TCG_CARD_REF_BG, create_card_arg1) = cardrefbg
	carddetailn@tcg(create_card_arg1) = rtvaln
	carddetailneff@tcg(create_card_arg1) = rtvaln2
	repeat 128
		cdbitmod cnt, create_card_arg1, 0
	loop
	s@tcg = cardrefbits
	csvstr2 s@tcg, s@tcg
	repeat
		if ( s@tcg(cnt) == "" ) {
			break
		}
		p@tcg = int(s@tcg(cnt))
		if ( cnt >= 40 | p@tcg == 0 ) {
			break
		}
		cdbitmod p@tcg, create_card_arg1, 1
	loop
	return create_card_arg1

#deffunc generate_discover_extra_card int create_extra_card_player
	if ( cpdata@tcg(TCG_PLAYER_EXTRACARD, create_extra_card_player) + discovercount@tcg > MAX_CARD_EXTRA ) { 
		cextra@tcg = -1
		return -1 
	}
	cextrabk@tcg = cpdata@tcg(TCG_PLAYER_EXTRACARD, create_extra_card_player)
	deckbk@tcg = cpdata@tcg(TCG_PLAYER_DECK, create_extra_card_player)
	rndracebk@tcg = rndrace@tcg
	rndclassbk@tcg = rndclass@tcg
	rndsexbk@tcg = rndsex@tcg
	rnddomainbk@tcg = rnddomain@tcg
	rndlvlbk@tcg = rndlvl@tcg
	rndfixlvlbk@tcg = rndfixlvl@tcg
	// Generate candidate cards
	repeat discovercount@tcg
		discoverc@tcg = discover@tcg(cnt)
		if ( discoverc@tcg < 0 ) {
			gosub *card_filter
			if ( cardno <= 0 | cardno > MAX_CREATURE_ID - 3 ) { continue }
			discoverc@tcg = cardno
			
			rndrace@tcg = rndracebk@tcg
			rndclass@tcg = rndclassbk@tcg
			rndsex@tcg = rndsexbk@tcg
			rnddomain@tcg = rnddomainbk@tcg
			rndlvl@tcg = rndlvlbk@tcg
			rndfixlvl@tcg = rndfixlvlbk@tcg
		}
		cextra@tcg = create_extra_card_player * MAX_CARD_DECK_TOTAL + MAX_CARD_DECK + cpdata@tcg(TCG_PLAYER_EXTRACARD, create_extra_card_player)
		create_card cextra@tcg, discoverc@tcg
		card@tcg(TCG_CARD_LOCATION, cextra@tcg) = TCG_LOCATION_DISCOVER, create_extra_card_player, deckix@tcg(create_extra_card_player), deckiy@tcg(create_extra_card_player), deckix@tcg(create_extra_card_player), deckiy@tcg(create_extra_card_player)
		cpdata@tcg(TCG_PLAYER_EXTRACARD, create_extra_card_player)++
		cpdata@tcg(TCG_PLAYER_DECK, create_extra_card_player)++
	loop
	gosub *card_filter_reset
	discover_extra_card create_extra_card_player
	return cextra@tcg

#deffunc discover_extra_card int create_extra_card_player
	// Select from candidate cards in Anim area.
	rtval@tcg = -1
	if ( create_extra_card_player == player@tcg ) {
		deckmode@tcg = -2
		deckmodecp@tcg = create_extra_card_player
		gosub *select_deck
		cardpos 0, -1
		cardpos 1, -1
		cardposhand 0, -1
		cardposhand 1, -1
		cardposgrave -1
		deckmode@tcg = 0
		deckmodecp@tcg = 0
		if ( rtval@tcg >= 0 ) { 
			discover@tcg(0) = card@tcg(TCG_CARD_REF_DBID, rtval@tcg) 
		}
	}
	if ( rtval@tcg < 0 ) {
		discover@tcg(0) = card@tcg(TCG_CARD_REF_DBID, create_extra_card_player * MAX_CARD_DECK_TOTAL + MAX_CARD_DECK + cextrabk@tcg + rnd(discovercount@tcg))
	}
	// Reset temporary cards
	cpdata@tcg(TCG_PLAYER_EXTRACARD, create_extra_card_player) = cextrabk@tcg
	cpdata@tcg(TCG_PLAYER_DECK, create_extra_card_player) = deckbk@tcg
	repeat maxcard@tcg
		if ( card@tcg(TCG_CARD_LOCATION, cnt) == TCG_LOCATION_DISCOVER ) {
			card@tcg(TCG_CARD_LOCATION, cnt) = TCG_LOCATION_DEFAULT
			card@tcg(TCG_CARD_REF_DBID, cnt) = 0
		}
	loop
	if ( discover@tcg(0) < 0 ) { 
		cextra@tcg = -1
		return -1 
	}
	// Generate the selected card
	create_extra_card create_extra_card_player,  discover@tcg(0)
	return cextra@tcg

#deffunc create_extra_card int create_extra_card_player, int create_extra_card_id
	if ( cpdata@tcg(TCG_PLAYER_EXTRACARD, create_extra_card_player) >= MAX_CARD_EXTRA ) { 
		cextra@tcg = -1
		return -1 
	}
	cextra@tcg = create_extra_card_player * MAX_CARD_DECK_TOTAL + MAX_CARD_DECK + cpdata@tcg(TCG_PLAYER_EXTRACARD, create_extra_card_player)
	create_card cextra@tcg, create_extra_card_id
	card@tcg(TCG_CARD_LOCATION, cextra@tcg) = TCG_LOCATION_DECK, create_extra_card_player, deckix@tcg(create_extra_card_player), deckiy@tcg(create_extra_card_player), deckix@tcg(create_extra_card_player), deckiy@tcg(create_extra_card_player)
	cpdata@tcg(TCG_PLAYER_EXTRACARD, create_extra_card_player)++
	cpdata@tcg(TCG_PLAYER_DECK, create_extra_card_player)++
	cdbitmod TCG_BIT_FOSSIL, cextra@tcg, 0
	return cextra@tcg

#deffunc returncard int returncard_arg1
	n@tcg = card@tcg(TCG_CARD_CONTROLLER, returncard_arg1)
	cardorglocation@tcg = card@tcg(TCG_CARD_LOCATION, returncard_arg1)
	if ( card@tcg(TCG_CARD_LOCATION, returncard_arg1) == TCG_LOCATION_FIELD ) {
		efllistadd 2, 1, card@tcg(TCG_CARD_X, returncard_arg1), card@tcg(TCG_CARD_Y, returncard_arg1), deckix@tcg(n@tcg), deckiy@tcg(n@tcg)
	}
	if ( card@tcg(TCG_CARD_LOCATION, returncard_arg1) == TCG_LOCATION_HAND ) {
		efllistadd 2, 1, card@tcg(TCG_CARD_X, returncard_arg1), card@tcg(TCG_CARD_Y, returncard_arg1), deckix@tcg(n@tcg), deckiy@tcg(n@tcg)
	}
	if ( card@tcg(TCG_CARD_LOCATION, returncard_arg1) == TCG_LOCATION_GRAVEYARD ) {
		efllistadd 2, 1, graveix@tcg(n@tcg), graveiy@tcg(n@tcg), deckix@tcg(n@tcg), deckiy@tcg(n@tcg)
	}
	// create_card returncard_arg1, card@tcg(TCG_CARD_REF_DBID, returncard_arg1)
	card@tcg(TCG_CARD_LOCATION, returncard_arg1) = TCG_LOCATION_DECK
	card@tcg(TCG_CARD_X, returncard_arg1) = 0
	card@tcg(TCG_CARD_Y, returncard_arg1) = 0
	card@tcg(TCG_CARD_X_MOVETO, returncard_arg1) = 0
	card@tcg(TCG_CARD_Y_MOVETO, returncard_arg1) = 0
	card@tcg(TCG_CARD_ANIM, returncard_arg1) = 0
	card@tcg(TCG_CARD_ANIM_DURATION, returncard_arg1) = 0
	cdbitmod TCG_BIT_FACE_UP, returncard_arg1, 0
	makecardlist
	if ( cardorglocation@tcg == TCG_LOCATION_FIELD ) {
		cardpos 0, -1
		cardpos 1, -1
	}
	if ( cardorglocation@tcg == TCG_LOCATION_GRAVEYARD ) {
		cardposgrave -1
	}
	if ( cardorglocation@tcg == TCG_LOCATION_HAND ) {
		cardposhand (1-card@tcg(TCG_CARD_CONTROLLER, returncard_arg1)), -1
	}
	cardposhand card@tcg(TCG_CARD_CONTROLLER, returncard_arg1), -1
	gosub *refresh_bg
	return

#deffunc gravecard int gravecard_arg1
	// Card HP and Atk are restored only when it dies, or regenerates.
	card@tcg(TCG_CARD_HP, gravecard_arg1) = card@tcg(TCG_CARD_REF_HP, gravecard_arg1)
	card@tcg(TCG_CARD_ATTACK, gravecard_arg1) = card@tcg(TCG_CARD_REF_ATTACK, gravecard_arg1)
	cardorglocation@tcg = card@tcg(TCG_CARD_LOCATION, gravecard_arg1)
	// // Reorganize field card locations (This is uncessary due to cardpos, delete this in the future)
	if ( card@tcg(TCG_CARD_LOCATION, gravecard_arg1) == TCG_LOCATION_FIELD ) {
		repeat maxcard@tcg
			if ( card@tcg(TCG_CARD_LOCATION, cnt) != TCG_LOCATION_FIELD ) {
				continue
			}
			if ( card@tcg(TCG_CARD_CONTROLLER, cnt) != card@tcg(TCG_CARD_CONTROLLER, gravecard_arg1) ) {
				continue
			}
			if ( card@tcg(TCG_CARD_X, cnt) > card@tcg(TCG_CARD_X, gravecard_arg1) ) {
				card@tcg(TCG_CARD_X_MOVETO, cnt) -= spotspace@tcg
			}
		loop
	}
	if ( card@tcg(TCG_CARD_LOCATION, gravecard_arg1) == TCG_LOCATION_HAND ) {
		repeat maxcard@tcg
			if ( card@tcg(TCG_CARD_CONTROLLER, cnt) != gravecard_arg1 ) {
				continue
			}
			if ( card@tcg(TCG_CARD_LOCATION, cnt) != TCG_LOCATION_HAND ) {
				continue
			}
			if ( card@tcg(TCG_CARD_X, cnt) <= card@tcg(TCG_CARD_X, gravecard_arg1) ) {
				continue
			}
			card@tcg(TCG_CARD_X_MOVETO, cnt) -= holderspace@tcg
		loop
	}
	// Set card location to grave, update grave list, and update field/hand lists
	if ( card@tcg(TCG_CARD_LOCATION, gravecard_arg1) != TCG_LOCATION_GRAVEYARD ) {
		card@tcg(TCG_CARD_LOCATION, gravecard_arg1) = TCG_LOCATION_GRAVEYARD
		card@tcg(TCG_CARD_TURN_COUNT, gravecard_arg1) = 0
		cpdata@tcg(TCG_PLAYER_GRAVEYARD, card@tcg(TCG_CARD_CONTROLLER, gravecard_arg1))++
		cardposgrave card@tcg(TCG_CARD_CONTROLLER, gravecard_arg1)
		makecardlist
	}
	// Reorganize field and hand
	if ( cardorglocation@tcg == TCG_LOCATION_FIELD ) {
		cardpos card@tcg(TCG_CARD_CONTROLLER, gravecard_arg1), -1
	}
	if ( cardorglocation@tcg == TCG_LOCATION_HAND ) {
		cardposhand card@tcg(TCG_CARD_CONTROLLER, gravecard_arg1), -1
	}
	if ( cardorglocation@tcg == TCG_LOCATION_EXILE ) {
		cardposexile card@tcg(TCG_CARD_CONTROLLER, gravecard_arg1)
	}
	// Fire deathrattle effect
	if ( cardorglocation@tcg == TCG_LOCATION_FIELD ) {
		if ( (effref@tcg(TCG_SKILL_TYPE, card@tcg(TCG_CARD_EFFECT, gravecard_arg1)) & TCG_SKILL_TYPE_DEATHRATTLE) ) {
			effac@tcg = gravecard_arg1
			eff@tcg = card@tcg(TCG_CARD_EFFECT, gravecard_arg1)
			gosub *card_action_choose_target
			makecardlist
		}
	}
	if ( cdbit(TCG_BIT_MILLSUMMON, gravecard_arg1) & cardorglocation@tcg == TCG_LOCATION_DECK ) {
		putcard gravecard_arg1, card@tcg(TCG_CARD_CONTROLLER, gravecard_arg1)
	}
	if ( cdbit(TCG_BIT_FOSSIL, gravecard_arg1) ) {
		animeseq@tcg = 1
		cdbitmod TCG_BIT_FACE_UP, gravecard_arg1, 1
		card@tcg(TCG_CARD_ANIM, gravecard_arg1) = 0, 0
		card@tcg(TCG_CARD_LOCATION, gravecard_arg1) = TCG_LOCATION_ANIM
		card@tcg(TCG_CARD_X, gravecard_arg1) = graveix@tcg(card@tcg(TCG_CARD_CONTROLLER, gravecard_arg1)), graveiy@tcg(card@tcg(TCG_CARD_CONTROLLER, gravecard_arg1))
		card@tcg(TCG_CARD_X_MOVETO, gravecard_arg1) = basex@tcg + 455 - 36, basey@tcg + 270 - 48
		tcgpass 20
		create_card gravecard_arg1, card@tcg(TCG_CARD_REF_DBID, gravecard_arg1)
		cdbitmod TCG_BIT_FACE_UP, gravecard_arg1, 1
		cdbitmod TCG_BIT_FOSSIL, gravecard_arg1, 0
		efllistadd 18, 0, basex@tcg + 455, basey@tcg + 270, basex@tcg + 455, basey@tcg + 270
		tcgpass 30
		card@tcg(TCG_CARD_X_MOVETO, gravecard_arg1) = deckix@tcg(card@tcg(TCG_CARD_CONTROLLER, gravecard_arg1)), deckiy@tcg(card@tcg(TCG_CARD_CONTROLLER, gravecard_arg1))
		tcgpass 15
		card@tcg(TCG_CARD_LOCATION, gravecard_arg1) = TCG_LOCATION_GRAVEYARD
		cdbitmod TCG_BIT_FACE_UP, gravecard_arg1, 0
		returncard gravecard_arg1
		gettargetcard gravecard_arg1
		animeseq@tcg = 0
		tcgdraw
	}
	if ( card@tcg(TCG_CARD_EFFECT, gravecard_arg1) == TCG_EFF_POPPY | card@tcg(TCG_CARD_EFFECT, gravecard_arg1) == TCG_EFF_AINC | card@tcg(TCG_CARD_EFFECT, gravecard_arg1) == TCG_EFF_RETURNTODECKWHENKILLED | card@tcg(TCG_CARD_EFFECT, gravecard_arg1) == TCG_EFF_RETURNTOHANDWHENKILLED | card@tcg(TCG_CARD_EFFECT, gravecard_arg1) == TCG_EFF_GWEN | specialrulenoonedies@tcg ) {
		returncard gravecard_arg1
	}
	if ( card@tcg(TCG_CARD_EFFECT, gravecard_arg1) == TCG_EFF_RETURNTOHANDWHENKILLED | card@tcg(TCG_CARD_EFFECT, gravecard_arg1) == TCG_EFF_GWEN ) {
		gettargetcard gravecard_arg1
	}
	gosub *refresh_bg
	return

#deffunc dmgcard int dmgcard_arg1, int dmgcard_arg2, int dmgcard_arg_combat
	dmgcard_dmg = dmgcard_arg2
	if ( cdbit(TCG_BIT_BLEEDING, dmgcard_arg1) ) {
		dmgcard_dmg++
	}
	if ( dmgcard_arg_combat != TRUE ) {
		dmgcard_dmg += specialruleeffectdamage@tcg(1 - card@tcg(TCG_CARD_CONTROLLER, dmgcard_arg1))
	}
	if ( dmgcard_dmg > 0 ) {
		snd SOUNDLIST_ATK1
	}
	if ( card@tcg(TCG_CARD_EFFECT, dmgcard_arg1) == TCG_EFF_NOCOMBATDAMAGE & dmgcard_arg_combat == TRUE ) {
		efllistaddcard 18, dmgcard_arg1
		return
	}
	if ( cdbit(TCG_BIT_BARRIER, dmgcard_arg1) & dmgcard_dmg > 0 & dmgcard_arg_combat != TRUE ) {
		efllistadd 1, 0, card@tcg(TCG_CARD_X, dmgcard_arg1), card@tcg(TCG_CARD_Y, dmgcard_arg1) 
		return
	}
	if ( cdbit(TCG_BIT_ARMOR, dmgcard_arg1) & dmgcard_dmg > 0 ) {
		cdbitmod TCG_BIT_ARMOR, dmgcard_arg1, 0
		efllistadd 1, 0, card@tcg(TCG_CARD_X, dmgcard_arg1), card@tcg(TCG_CARD_Y, dmgcard_arg1) 
		return
	}
	if ( cdbit(TCG_BIT_RIDER, dmgcard_arg1) & dmgcard_dmg > 0 ) {
		cdbitmod TCG_BIT_RIDER, dmgcard_arg1, 0
		dmgcard_dmg = 2
	}
	if ( specialrulelifeordeathcombat@tcg ) {
		if ( dmgcard_dmg >= card@tcg(TCG_CARD_HP, dmgcard_arg1) ) {
			dmgcard_dmg = card@tcg(TCG_CARD_HP, dmgcard_arg1)
		} else {
			dmgcard_dmg = 0
		}
	}
	if ( dmgcard_dmg != 0 ) { 
		efllistadd 1, -dmgcard_dmg, card@tcg(TCG_CARD_X, dmgcard_arg1), card@tcg(TCG_CARD_Y, dmgcard_arg1) 
	}
	card@tcg(TCG_CARD_HP, dmgcard_arg1) -= dmgcard_dmg
	if ( card@tcg(TCG_CARD_HP, dmgcard_arg1) < 0 ) {
		card@tcg(TCG_CARD_HP, dmgcard_arg1) = 0
	}
	if ( card@tcg(TCG_CARD_HP, dmgcard_arg1) <= 0 & (card@tcg(TCG_CARD_LOCATION, dmgcard_arg1) == TCG_LOCATION_FIELD | card@tcg(TCG_CARD_LOCATION, dmgcard_arg1) == TCG_LOCATION_HAND) ) {
		card@tcg(TCG_CARD_ANIM, dmgcard_arg1) = TCG_ANIM_FADE, 18
		tcgdraw
		gravecard dmgcard_arg1
	}
	return

#deffunc dmgplayer int dmgplayer_arg1, int dmgplayer_arg2, int dmgplayer_arg_combat
	dmgplayer_dmg = dmgplayer_arg2
	if ( dmgplayer_arg_combat != TRUE ) {
		dmgplayer_dmg += specialruleeffectdamage@tcg(1-dmgplayer_arg1)
	}
	if ( dmgplayer_dmg > 0 ) {
		snd SOUNDLIST_ATK1
	}
	efllistadd 1, -dmgplayer_dmg, cpx@tcg(dmgplayer_arg1), cpy@tcg(dmgplayer_arg1)
	cpdata@tcg(TCG_PLAYER_LIFE, dmgplayer_arg1) -= dmgplayer_dmg
	if ( cpdata@tcg(TCG_PLAYER_LIFE, dmgplayer_arg1) <= 0 ) {
		cpdata@tcg(TCG_PLAYER_LIFE, dmgplayer_arg1) = 0
		if ( dmgplayer_arg1 == 0 ) {
			gameresult@tcg = 2
		} else {
			gameresult@tcg = 1
		}
	}
	return

#deffunc delbottomcard int delbottomcard_arg1
	// In Noa's original, left-most card is graved when hand limit is exceeded.
	// Draw logic is changed to not draw cards when hand is full, so this should only trigger with Itzpalt's effect.
	// Since hand limit can be increased beyond 7, card orders are no longer determined by the (x_moveto).
	// Now it deletes a random hand card instead.
	if ( specialruledrawswhenhandfull@tcg == FALSE ) { return }
	repeat limit(getholdersum(delbottomcard_arg1) - maxholdersum@tcg(delbottomcard_arg1), 0, 200)
		delcard@tcg = -1
		delcardc@tcg = 0
		repeat maxcard@tcg
			if ( card@tcg(TCG_CARD_CONTROLLER, cnt) != delbottomcard_arg1 ) {
				continue
			}
			if ( card@tcg(TCG_CARD_LOCATION, cnt) == TCG_LOCATION_HAND ) {
				delcardc@tcg++
				if ( rnd(delcardc@tcg) == 0 ) {
					delcard@tcg = cnt
				}
			}
		loop
		if ( delcard@tcg < 0 ) {
			break
		}
		card@tcg(TCG_CARD_Y_MOVETO, delcard@tcg) += (-25) + 50 * delbottomcard_arg1
		tcgdraw
		card@tcg(TCG_CARD_ANIM, delcard@tcg) = TCG_ANIM_FADE, 18
		gravecard delcard@tcg
	loop
	makecardlist
	cardposhand delbottomcard_arg1, -1
	tcgdraw
	return

#deffunc fatigueplayer int fatigueplayer_arg1
	efllistadd 18, 0, deckix@tcg(fatigueplayer_arg1), deckiy@tcg(fatigueplayer_arg1)
	cpdata@tcg(TCG_PLAYER_FATIGUE, fatigueplayer_arg1)++
	efllistadd 1, cpdata@tcg(TCG_PLAYER_FATIGUE, fatigueplayer_arg1), deckix@tcg(fatigueplayer_arg1), deckiy@tcg(fatigueplayer_arg1)
	dmgplayer fatigueplayer_arg1, cpdata@tcg(TCG_PLAYER_FATIGUE, fatigueplayer_arg1)
	if ( cpdata@tcg(TCG_PLAYER_FATIGUE, fatigueplayer_arg1) >= 5 & specialruleusenofatiguerecoil@tcg(1 - fatigueplayer_arg1) == 0 ) {
		dmgplayer 1 - fatigueplayer_arg1, cpdata@tcg(TCG_PLAYER_FATIGUE, fatigueplayer_arg1) / 5
	}
	return

#deffunc getrandomcard int getrandomcard_arg1
	p@tcg = getholdersum(getrandomcard_arg1)
	if ( hasholdspace(getrandomcard_arg1) == FALSE & specialruledrawswhenhandfull@tcg == FALSE ) {
		return
	}
	if ( getdecksum(getrandomcard_arg1) == 0 ) {
		if ( yaminogemu@tcg == 1 | specialruleusefatigue@tcg == 1 ) {
			fatigueplayer getrandomcard_arg1
		} else {
			cpdata@tcg(TCG_PLAYER_LIFE, getrandomcard_arg1) = 0
			if ( getrandomcard_arg1 == 0 ) {
				gameresult@tcg = 4
			} else {
				gameresult@tcg = 3
			}
		}
		return
	}
	p@tcg = getholdersum(getrandomcard_arg1)
	c@tcg = -1, 0
	ctempo@tcg = -1, 0
	repeat maxcard@tcg
		if ( card@tcg(TCG_CARD_LOCATION, cnt) != TCG_LOCATION_DECK ) { continue }
		if ( card@tcg(TCG_CARD_CONTROLLER, cnt) != getrandomcard_arg1 ) { continue }
		if ( cdbit(TCG_BIT_TEMPO, cnt) == TRUE | specialrulenextdrawtempo@tcg > 0 ) { // Tempo Cards with satisfied condition are drawn with higher priority
			if ( phase@tcg <= 1 & card@tcg(TCG_CARD_COST, cnt) == cpdata@tcg(TCG_PLAYER_MANA, getrandomcard_arg1) ) {
				ctempo@tcg(1)++
				if ( rnd(ctempo@tcg(1)) == 0 ) {
					ctempo@tcg(0) = cnt
				}
			}
			continue
		}
		if ( cdbit(TCG_BIT_CONSTANT, cnt) == TRUE ) { // Constant Cards start in your hand, if possible.
			if ( phase@tcg <= 1 & turn@tcg <= 0 ) {
				ctempo@tcg(1)++
				if ( rnd(ctempo@tcg(1)) == 0 ) {
					ctempo@tcg(0) = cnt
				}
			}
		}
		// This is the normal draw.
		c@tcg(1)++
		if ( rnd(c@tcg(1)) == 0 ) {
			c@tcg(0) = cnt
		}
	loop
	if ( ctempo@tcg(0) >= 0 | c@tcg(0) < 0 ) { c@tcg(0) = ctempo@tcg(0) }
	if ( c@tcg(0) < 0 ) { // If draw fails, draw from deck without tempo limit
		c@tcg = -1, 0
		repeat maxcard@tcg
			if ( card@tcg(TCG_CARD_LOCATION, cnt) != TCG_LOCATION_DECK ) { continue }
			if ( card@tcg(TCG_CARD_CONTROLLER, cnt) != getrandomcard_arg1 ) { continue }
			c@tcg(1)++
			if ( rnd(c@tcg(1)) == 0 ) {
				c@tcg(0) = cnt
			}
		loop
	}
	specialrulenextdrawtempo@tcg--
	if ( c@tcg(0) < 0 ) { return }
	proctcg "tcg draw: c" + c@tcg(0) + "/" + c@tcg(1) + " ctempo:" + ctempo@tcg(0) + "/" + ctempo@tcg(1) + " cp:" + getrandomcard_arg1 + " cpdataMANA:" + cpdata@tcg(TCG_PLAYER_MANA, getrandomcard_arg1) + " carddetailneff:" + carddetailneff@tcg(c@tcg(0))
	gettargetcard c@tcg
	return

#deffunc gettargetcard int gettargetcard_arg1
	n@tcg = card@tcg(TCG_CARD_CONTROLLER, gettargetcard_arg1)
	p@tcg = getholdersum(n@tcg)
	cardorglocation@tcg = card@tcg(TCG_CARD_LOCATION, gettargetcard_arg1)
	if ( hasholdspace(n@tcg) == FALSE & specialruledrawswhenhandfull@tcg == FALSE ) {
		return
	}
	if ( card@tcg(TCG_CARD_LOCATION, gettargetcard_arg1) == TCG_LOCATION_DECK ) {
		card@tcg(TCG_CARD_LOCATION, gettargetcard_arg1) = TCG_LOCATION_HAND, n@tcg, deckix@tcg(n@tcg), deckiy@tcg(n@tcg), holderix@tcg(n@tcg) + p@tcg * holderspace@tcg, holderiy@tcg(n@tcg), 0, 0
		cpdata@tcg(TCG_PLAYER_DECK, n@tcg)--
	}
	if ( card@tcg(TCG_CARD_LOCATION, gettargetcard_arg1) == TCG_LOCATION_GRAVEYARD ) {
		card@tcg(TCG_CARD_X, gettargetcard_arg1) = graveix@tcg(n@tcg), graveiy@tcg(n@tcg), graveix@tcg(n@tcg), graveiy@tcg(n@tcg), 0, 0
	}
	if ( card@tcg(TCG_CARD_LOCATION, gettargetcard_arg1) == TCG_LOCATION_FIELD ) {
		card@tcg(TCG_CARD_STATUS, gettargetcard_arg1) = TCG_ACTION_NONE
		cdbitmod TCG_BIT_EXHAUSTED, gettargetcard_arg1, 0
	}
	card@tcg(TCG_CARD_LOCATION, gettargetcard_arg1) = TCG_LOCATION_HAND, n@tcg
	card@tcg(TCG_CARD_X_MOVETO, gettargetcard_arg1) = holderix@tcg(n@tcg) + p@tcg * holderspace@tcg, holderiy@tcg(n@tcg)
	card@tcg(TCG_CARD_TURN_COUNT, gettargetcard_arg1) = 0
	if ( player@tcg == TCG_CONTROLLER_OBSERVER | n@tcg == player@tcg | specialruleseeopponenthand@tcg ) {
		cdbitmod TCG_BIT_FACE_UP, gettargetcard_arg1, 1
	}
	else {
		cdbitmod TCG_BIT_FACE_UP, gettargetcard_arg1, 0
	}
	if ( getholdersum(n@tcg) > maxholdersum@tcg(n@tcg) ) {
		nbk@tcg = n@tcg
		delbottomcard n@tcg
		n@tcg = nbk@tcg
	}
	if ( cardorglocation@tcg == TCG_LOCATION_FIELD ) {
		cardpos 0, -1
		cardpos 1, -1
	}
	if ( cardorglocation@tcg == TCG_LOCATION_GRAVEYARD ) {
		cardposgrave -1
	}
	if ( (effref@tcg(TCG_SKILL_TYPE, card@tcg(TCG_CARD_EFFECT, gettargetcard_arg1)) & TCG_SKILL_TYPE_ONDRAW) ) {
		if ( cdbit(TCG_BIT_PUMPKIN, gettargetcard_arg1) == 0 ) {
			effac@tcg = gettargetcard_arg1
			eff@tcg = card@tcg(TCG_CARD_EFFECT, gettargetcard_arg1)
			cdbitmod TCG_BIT_FACE_UP, effac@tcg, 1
			proctcg "tcg proc/ondraw: effacc:" + effac@tcg + "/eff" + eff@tcg
			gosub *card_action_choose_target
		}
	}
	if ( cdbit(TCG_BIT_SURGE, gettargetcard_arg1) ) {
		cdbitmod TCG_BIT_FACE_UP, gettargetcard_arg1, 1
		tcgpass 15
		cdbitmod TCG_BIT_SURGE, gettargetcard_arg1, 0
		card@tcg(TCG_CARD_ANIM, gettargetcard_arg1) = TCG_ANIM_FADE, 18
		tcgdraw
		gravecard gettargetcard_arg1
		getrandomcard card@tcg(TCG_CARD_CONTROLLER, gettargetcard_arg1)
	}
	makecardlist
	cardposhand 0, -1
	cardposhand 1, -1
	cardpos 0, -1
	cardpos 1, -1
	return

#deffunc saccard int saccard_arg1, int saccard_arg2
	snd SOUNDLIST_FEAT
	sac@tcg++
	// if ( dbg_tcg & saccard_arg2 == 0 ) { sac@tcg = 0 } 
	if ( saccard_arg2 == 0 ) {
		cardhelp lang("カードを捧げた。", "You sacrifice the card."), 40
	}
	else {
		cardhelp lang("相手はカードを捧げた。", "The opponent sacrifices the card."), 40
	}
	repeat maxcard@tcg
		if ( card@tcg(TCG_CARD_CONTROLLER, cnt) != saccard_arg2 ) {
			continue
		}
		if ( card@tcg(TCG_CARD_LOCATION, cnt) != TCG_LOCATION_HAND ) {
			continue
		}
		if ( card@tcg(TCG_CARD_X, cnt) <= card@tcg(TCG_CARD_X, saccard_arg1) ) {
			continue
		}
		card@tcg(TCG_CARD_X_MOVETO, cnt) -= holderspace@tcg
	loop
	cpdata@tcg(TCG_PLAYER_MAX_MANA, saccard_arg2)++
	cpdata@tcg(TCG_PLAYER_MANA, saccard_arg2)++
	effac@tcg = saccard_arg1
	eff@tcg = card@tcg(TCG_CARD_EFFECT, saccard_arg1)
	// costbk@tcg = card@tcg(TCG_CARD_COST, saccard_arg1)
	// card_ref 10000 + card@tcg(TCG_CARD_REF_DOMAIN, saccard_arg1) * 100 + rnd(2)
	// create_card saccard_arg1, stat
	// card@tcg(TCG_CARD_EFFECT, saccard_arg1) = eff@tcg
	// card@tcg(TCG_CARD_COST, saccard_arg1) = costbk@tcg
	cdbitmod TCG_BIT_FACE_UP, saccard_arg1, 0
	card@tcg(TCG_CARD_X_MOVETO, saccard_arg1) = landix@tcg(saccard_arg2) + landsum@tcg(saccard_arg2) * limit(landspace@tcg - landsum@tcg(saccard_arg2) / 2, 4, landspace@tcg)
	card@tcg(TCG_CARD_Y_MOVETO, saccard_arg1) = landiy@tcg(saccard_arg2)
	landlist@tcg(landsum@tcg(saccard_arg2), saccard_arg2) = saccard_arg1
	landsum@tcg(saccard_arg2)++
	tcgdraw
	makecardlist
	card@tcg(TCG_CARD_LOCATION, saccard_arg1) = TCG_LOCATION_EXILE
	cdbitmod TCG_BIT_FACE_UP, saccard_arg1, 1
	makecardlist
	cardposhand saccard_arg2, -1
	if ( (effref@tcg(TCG_SKILL_TYPE, eff@tcg) & TCG_SKILL_TYPE_SACRIFICE) ) {
		gosub *card_action_choose_target
		makecardlist
		tcgdraw
	}
	gosub *refresh_bg
	efllistadd 2, 1, card@tcg(TCG_CARD_X, saccard_arg1), card@tcg(TCG_CARD_Y, saccard_arg1), cpx@tcg(saccard_arg2), cpy@tcg(saccard_arg2)
	return

#deffunc opencard int opencard_arg1
	snd SOUNDLIST_CARD1
	cdbitmod TCG_BIT_FACE_UP, opencard_arg1, 1
	tcgdraw
	return

#deffunc putcard int putcard_arg1, int putcard_arg2
	if ( hasspotspace(putcard_arg2) == FALSE ) {
		if ( putcard_arg2 == player@tcg ) {
			snd SOUNDLIST_FAIL1
			cardhelp lang("これ以上は場に出せない。", "Your field is full."), 40
		}
		return -1
	}
	cardorglocation@tcg = card@tcg(TCG_CARD_LOCATION, putcard_arg1)
	cardorgcontroller@tcg = card@tcg(TCG_CARD_CONTROLLER, putcard_arg1)
	if ( card@tcg(TCG_CARD_LOCATION, putcard_arg1) == TCG_LOCATION_FIELD ) {
		if ( putcard_arg2 != card@tcg(TCG_CARD_CONTROLLER, putcard_arg1) ) {
			if ( hasspotspace(1 - card@tcg(TCG_CARD_CONTROLLER, putcard_arg1)) == TRUE ) {
				card@tcg(TCG_CARD_CONTROLLER, putcard_arg1) = 1 - card@tcg(TCG_CARD_CONTROLLER, putcard_arg1)
				makecardlist
				cardpos 0, -1
				cardpos 1, -1
			}
		}
		return -1
	}
	if ( card@tcg(TCG_CARD_LOCATION, putcard_arg1) == TCG_LOCATION_GRAVEYARD ) {
		card@tcg(TCG_CARD_X, putcard_arg1) = graveix@tcg(putcard_arg2), graveiy@tcg(putcard_arg2), graveix@tcg(putcard_arg2), graveiy@tcg(putcard_arg2), 0, 0
	}
	if ( card@tcg(TCG_CARD_LOCATION, putcard_arg1) == TCG_LOCATION_HAND ) {
		if ( putcardfree@tcg == 0 ) {
			if ( cdbit(TCG_BIT_ENEMY, putcard_arg1) ) {
				if ( hasspotspace(1 - card@tcg(TCG_CARD_CONTROLLER, putcard_arg1)) == FALSE ) {
					if ( 1 - card@tcg(TCG_CARD_CONTROLLER, putcard_arg1) == player@tcg ) {
						snd SOUNDLIST_FAIL1
						cardhelp lang("これ以上は場に出せない。", "Your opponent's field is full."), 40
					}
					return -1
				}
				card@tcg(TCG_CARD_CONTROLLER, putcard_arg1) = 1 - card@tcg(TCG_CARD_CONTROLLER, putcard_arg1)
			}
			if ( card@tcg(TCG_CARD_COST, putcard_arg1) > cpdata@tcg(TCG_PLAYER_MANA, putcard_arg2) ) {
				if ( putcard_arg2 == player@tcg ) {
					snd SOUNDLIST_FAIL1
					cardhelp lang("マナが足りない。", "You don't have enough mana."), 40
				}
				if ( debug == 0 ) {
					return -3
				}
			}
			cpdata@tcg(TCG_PLAYER_MANA, putcard_arg2) -= card@tcg(TCG_CARD_COST, putcard_arg1)
			specialrulemanaspent@tcg(putcard_arg2) += card@tcg(TCG_CARD_COST, putcard_arg1)
			if ( cardorgcontroller@tcg == TCG_CONTROLLER_PLAYER ) {
				card@tcg(TCG_CARD_Y_MOVETO, putcard_arg1) -= 25
			}
			else {
				card@tcg(TCG_CARD_Y_MOVETO, putcard_arg1) += 25
			}
			tcgdraw
		}
		cdbitmod TCG_BIT_FACE_UP, putcard_arg1, 0
	}
	putcardfree@tcg = 0
	if ( card@tcg(TCG_CARD_LOCATION, putcard_arg1) == TCG_LOCATION_DECK ) {
		card@tcg(TCG_CARD_X, putcard_arg1) = deckix@tcg(card@tcg(TCG_CARD_CONTROLLER, putcard_arg1)), deckiy@tcg(card@tcg(TCG_CARD_CONTROLLER, putcard_arg1)), deckix@tcg(card@tcg(TCG_CARD_CONTROLLER, putcard_arg1)), deckiy@tcg(card@tcg(TCG_CARD_CONTROLLER, putcard_arg1)), 0, 0
		cpdata@tcg(TCG_PLAYER_DECK, putcard_arg2)--
	}
	p@tcg = getspotsum(card@tcg(TCG_CARD_CONTROLLER, putcard_arg1))
	card@tcg(TCG_CARD_LOCATION, putcard_arg1) = TCG_LOCATION_FIELD
	card@tcg(TCG_CARD_TURN_COUNT, putcard_arg1) = 0
	if ( cdbit(TCG_BIT_HASTE, putcard_arg1) != TRUE & cdbit(TCG_BIT_RIDER, putcard_arg1) != TRUE ) {
		card@tcg(TCG_CARD_STATUS, putcard_arg1) = TCG_ACTION_EXHAUSTED
		cdbitmod TCG_BIT_EXHAUSTED, putcard_arg1, 1
	}
	cdbitmod TCG_BIT_WINDFURY_USABLE, putcard_arg1, 0
	if ( cdbit(TCG_BIT_WINDFURY, putcard_arg1) == TRUE ) {
		cdbitmod TCG_BIT_WINDFURY_USABLE, putcard_arg1, 1
	}
	if ( cardorglocation@tcg == TCG_LOCATION_GRAVEYARD ) {
		cardposgrave -1
	}
	if ( cardorglocation@tcg == TCG_LOCATION_HAND ) {
		cardposhand 0, -1
		cardposhand 1, -1
	}
	cardpos card@tcg(TCG_CARD_CONTROLLER, putcard_arg1), putcard_arg1
	makecardlist
	cardpos 0, -1
	cardpos 1, -1
	tcgdraw
	opencard putcard_arg1
	if ( (effref@tcg(TCG_SKILL_TYPE, card@tcg(TCG_CARD_EFFECT, putcard_arg1)) & TCG_SKILL_TYPE_BATTLECRY) ) {
		effac@tcg = putcard_arg1
		eff@tcg = card@tcg(TCG_CARD_EFFECT, putcard_arg1)
		proctcg "tcg proc/battlecry: effac:" + effac@tcg + "/eff" + eff@tcg
		gosub *card_action_choose_target
		makecardlist
	}
	cardposhand 0, -1
	cardposhand 1, -1
	cardpos 0, -1
	cardpos 1, -1
	tcgdraw
	if ( cdbit(TCG_BIT_PUMPKIN, putcard_arg1) ) {
		card@tcg(TCG_CARD_CONTROLLER, putcard_arg1) = 1 - card@tcg(TCG_CARD_CONTROLLER, putcard_arg1)
		cdbitmod TCG_BIT_PUMPKIN, putcard_arg1, 0
		cdbitmod TCG_BIT_SURGE, putcard_arg1, 1
		returncard putcard_arg1
		return 1
	}
	if ( cdbit(TCG_BIT_COMMAND, putcard_arg1) & card@tcg(TCG_CARD_LOCATION, putcard_arg1) != TCG_LOCATION_GRAVEYARD ) {
		card@tcg(TCG_CARD_ANIM, putcard_arg1) = TCG_ANIM_FADE, 18
		tcgdraw
		gravecard putcard_arg1
		return 1
	}
	if ( cdbit(TCG_BIT_SUICIDE, putcard_arg1) ) {
		card@tcg(TCG_CARD_HP, putcard_arg1) = 0
	}
	if ( card@tcg(TCG_CARD_HP, putcard_arg1) == 0 & card@tcg(TCG_CARD_LOCATION, putcard_arg1) == TCG_LOCATION_FIELD ) {
		dmgcard putcard_arg1, 0 + cdbit(TCG_BIT_SUICIDE, putcard_arg1) * 999
		if ( card@tcg(TCG_CARD_LOCATION, putcard_arg1) == TCG_LOCATION_FIELD ) {
			gravecard putcard_arg1
		}
	}
	return 1

#deffunc tcgdrawbg
	redraw 0
	x@tcg = 960
	y@tcg = 96
	w@tcg = 128
	h@tcg = 128
	gmode 0
	repeat windowh / h@tcg + 1
		cnt2@tcg = cnt
		repeat windoww / w@tcg + 1
			pos windoww - (cnt + 1) * w@tcg, windowh - (cnt2@tcg + 1) * h@tcg
			gcopy 3, x@tcg, y@tcg, w@tcg, h@tcg
		loop
	loop
	gmode 2
	return

#defcfunc calcstartcard int calcstartcard_arg1
	return 9 - (cpdata@tcg(TCG_PLAYER_DOMAIN, calcstartcard_arg1) > 2) - (cpdata@tcg(TCG_PLAYER_DOMAIN, calcstartcard_arg1) > 3) - (cpdata@tcg(TCG_PLAYER_DOMAIN, calcstartcard_arg1) > 4) - (cpdata@tcg(TCG_PLAYER_DOMAIN, calcstartcard_arg1) > 5) - (cpdata@tcg(TCG_PLAYER_DOMAIN, calcstartcard_arg1) > 6) - (cpdata@tcg(TCG_PLAYER_DOMAIN, calcstartcard_arg1) > 7) - (cpdata@tcg(TCG_PLAYER_DOMAIN, calcstartcard_arg1) > 8) - (cpdata@tcg(TCG_PLAYER_DOMAIN, calcstartcard_arg1) > 8)

#deffunc calcstartattb int calcstartattb_arg1
	cpdata@tcg(TCG_PLAYER_LIFE, calcstartattb_arg1) = limit(40 - cpdata@tcg(TCG_PLAYER_DOMAIN, calcstartattb_arg1) * 5, 25, 40)
	cpdata@tcg(TCG_PLAYER_MAX_MANA, calcstartattb_arg1) = 0
	specialrulenextturnmana@tcg(calcstartattb_arg1) = 0
	return

#deffunc calcdomain
	repeat 2
		dim domain@tcg, 9
		p@tcg = cnt
		cpdata@tcg(TCG_PLAYER_DOMAIN, p@tcg) = 0
		repeat maxcard@tcg
			if ( card@tcg(TCG_CARD_LOCATION, cnt) == TCG_LOCATION_DEFAULT ) {
				continue
			}
			if ( card@tcg(TCG_CARD_CONTROLLER, cnt) != p@tcg ) {
				continue
			}
			if ( domain@tcg(card@tcg(TCG_CARD_REF_DOMAIN, cnt)) == 0 ) {
				domain@tcg(card@tcg(TCG_CARD_REF_DOMAIN, cnt)) = 1
			}
		loop
		repeat 9
			if ( cnt == 4 | cnt == 5 ) { continue }
			if ( domain@tcg(cnt) ) {
				cpdata@tcg(TCG_PLAYER_DOMAIN, p@tcg)++
			}
		loop
		calcstartattb p@tcg
	loop
	return

#deffunc calcdecksize
	gdata(GDATA_DECK_SIZE + curdeck) = 0
	cardsize@tcg = 0
	cpdata@tcg(TCG_PLAYER_DOMAIN, 0) = 0
	dim domain@tcg, 9
	repeat maxcard@tcg
		if ( card(0, card@tcg(TCG_CARD_REF_DBID, cnt)) < deck(card@tcg(TCG_CARD_REF_DBID, cnt)) ) {
			deck(card@tcg(TCG_CARD_REF_DBID, cnt)) = card(0, card@tcg(TCG_CARD_REF_DBID, cnt))
		}
		if ( deck(card@tcg(TCG_CARD_REF_DBID, cnt)) <= 0 ) {
			continue
		}
		cardsize@tcg += card(0, cnt)
		gdata(GDATA_DECK_SIZE + curdeck) += deck(card@tcg(TCG_CARD_REF_DBID, cnt))
		domain@tcg(card@tcg(TCG_CARD_REF_DOMAIN, cnt)) = 1
	loop
	repeat 9
		if ( cnt == 4 | cnt == 5 ) { continue }
		if ( domain@tcg(cnt) ) {
			cpdata@tcg(TCG_PLAYER_DOMAIN, 0)++
		}
	loop
	calcstartattb 0
	return

#deffunc decktest
	dim card, 4, MAX_CARD
	dim deck, MAX_CARD
	repeat MAX_CARD
		dbid = cnt
		gosub *db_card@
		gosub *db_card_custom
		if ( stat == 0 ) {
			continue
		}
		card(0, cnt) = 10
	loop
	return

#deffunc tcgdeck
	maxcard@tcg = MAX_CARD
	tcginit
	displayinfo@tcg = 0
	cardmode@tcg = 1
	i@tcg = 0
	repeat MAX_CREATURE_ID - 3, 1
		create_card i@tcg, cnt
		card@tcg(TCG_CARD_LOCATION, i@tcg) = TCG_LOCATION_DECK, 0
		i@tcg++
	loop
	*tcgDeck_loop
	tcgdrawbg
	s@tcg = lang("白", "White"), lang("青", "Blue"), lang("銀", "Silver"), lang("赤", "Red"), lang("黒", "Black")
	repeat 5
		s@tcg(cnt) += lang("のデッキ", " Deck")
		file@tcg = "" + exedir + "tmp\\deck_" + cnt + ".s2"
		existwrapper file@tcg
		if ( strsize == (-1) ) {
			s@tcg(cnt) += lang(" (新規作成)", " (New)")
		}
		else {
			if ( gdata(GDATA_DECK_SIZE + cnt) < MIN_CARD_DECK ) {
				s@tcg(cnt) += " (NG " + gdata(GDATA_DECK_SIZE + cnt) + "/" + MIN_CARD_DECK + ")"
			}
			if ( gdata(GDATA_DECK_SIZE + cnt) > MAX_CARD_DECK ) {
				s@tcg(cnt) += " (NG " + gdata(GDATA_DECK_SIZE + cnt) + "/" + MAX_CARD_DECK + ")"
			}
			if ( gdata(GDATA_DECK) == cnt ) {
				s@tcg(cnt) += " [Use]"
			}
		}
		promptAdd s@tcg(cnt)
	loop
	val = basex@tcg + 400, basey@tcg + 230, 300, 1
	gosub *prompt_key@
	if ( rtval != (-1) ) {
		dim deck, MAX_CARD
		curdeck = rtval
		file = "" + exedir + "tmp\\deck_" + curdeck + ".s2"
		existwrapper file
		if ( strsize != (-1) ) {
			promptAdd lang("デッキの構築", "Edit Deck")
			promptAdd lang("メインデッキに設定", "Set as Main Deck")
			val = basex@tcg + 400, basey@tcg + 230, 240, 1
			gosub *prompt_key@
			if ( rtval == (-1) ) {
				goto *tcgDeck_loop
			}
			if ( rtval == 1 ) {
				gdata(GDATA_DECK) = curdeck
				goto *tcgDeck_loop
			}
			if ( rtval == 0 ) {
				fmode = 24
				gosub *game_ctrlFile@
			}
		}
		decksizebk@tcg = gdata(GDATA_DECK_SIZE + curdeck)
		snd SOUNDLIST_WEAR
		calcdecksize
		deckmode@tcg = 0, rtval@tcg
		deckmodecp@tcg = 0
		gosub *select_deck
		goto *tcgDeck_loop
	}
	return

#deffunc tcgmain
	maxcard@tcg = MAX_CARD_DECK_TOTAL * 2
	tcginit
	repeat 2
		rp@tcg = cnt
		cpx@tcg(cnt) = basex@tcg + 23
		cpy@tcg(cnt) = basey@tcg + 236 - cnt * 120
		cpdata@tcg(TCG_PLAYER_LIFE, cnt) = 30
		cpdata@tcg(TCG_PLAYER_GRAVEYARD, cnt) = 0
		cpdata@tcg(TCG_PLAYER_DECK, cnt) = 30
		cpdata@tcg(TCG_PLAYER_EXTRACARD, cnt) = 0
		if ( rp@tcg == 0 ) {
			gosub *card_loadplayerdeck
			if ( cardsize@tcg < MIN_CARD_DECK ) {
				gameresult@tcg = -2
				break
			}
		} else {
			gosub *card_generateopponentdeck
		}
		if ( cardsize@tcg < MIN_CARD_DECK ) {
			repeat MIN_CARD_DECK - cardsize@tcg
				cc@tcg = rp@tcg * MAX_CARD_DECK_TOTAL + cnt + cardsize@tcg
				card_ref rnd(MAX_CREATURE_ID - 3) + 1
				create_card cc@tcg, stat
				card@tcg(TCG_CARD_LOCATION, cc@tcg) = TCG_LOCATION_DECK, rp@tcg
			loop
		}
	loop
	if ( gameresult@tcg == -2 ) {
		s = lang("適切なデッキ", "a Proper Deck")
		file = "bg_re8"
		buff = lang("デュエルする前に、自分のデッキが少なくとも30枚はあることを確認する必要があるね。デッキに入れるカードを増やすべきかもしれないね。", "I should make sure my deck has at least 30 cards before a duel. May be I should get more cards to put them in my deck. ")
		listmax = 0
		if ( card(0, CREATURE_ID_USER) <= 0 ) {
			buff += "Miches from Vernis loves to play all sorts of boardgames, maybe I should ask her about this,"
		}
		chatList 1, lang("また今度ね", "Maybe next time.")
		gameresult@tcg = 0
		gosub *re_select
		return
	}
	if ( yaminogemu@tcg == 1 ) {
		s = lang("適切なデッキ", "a Proper Deck (Lethal)")
		file = "bg_re8"
		buff = ""
		listmax = 0
		if ( deck(CREATURE_ID_ITZPALT) > 0 ) { buff = "The Eternal League forbids Itzpalt from assisting participants of Termination Card Game (TCG)" }
		if ( deck(CREATURE_ID_OPATOS) > 0 ) { buff = "The Eternal League forbids Opatos from assisting participants of Termination Card Game (TCG)" }
		if ( deck(CREATURE_ID_MANI) > 0 ) { buff = "The Eternal League forbids Mani from assisting participants of Termination Card Game (TCG)" }
		if ( deck(CREATURE_ID_KUMIROMI) > 0 ) { buff = "The Eternal League forbids Kumiromi from assisting participants of Termination Card Game (TCG)" }
		if ( deck(CREATURE_ID_EHEKATL) > 0 ) { buff = "The Eternal League forbids Ehekatl from assisting participants of Termination Card Game (TCG)" }
		if ( deck(CREATURE_ID_JURE) > 0 ) { buff = "The Eternal League forbids Jure from assisting participants of Termination Card Game (TCG)" }
		if ( deck(CREATURE_ID_LULWY) > 0 ) { buff = "The Eternal League forbids Lulwy from assisting participants of Termination Card Game (TCG)" }
		if ( deck(CREATURE_ID_YACATECT) > 0 ) { buff = "The Eternal League forbids Yacatect from assisting participants of Termination Card Game (TCG)" }

		if ( deck(CREATURE_ID_THE_ELEMENT) > 0 ) { buff = "The Eternal League forbids Itzpalt from assisting participants of Termination Card Game (TCG)" }
		if ( deck(CREATURE_ID_BUILDUP_OPATOS) > 0 ) { buff = "The Eternal League forbids Opatos from assisting participants of Termination Card Game (TCG)" }
		if ( deck(CREATURE_ID_DEUS_EX_MANINA) > 0 ) { buff = "The Eternal League forbids Mani from assisting participants of Termination Card Game (TCG)" }
		if ( deck(CREATURE_ID_INSANE_KUMIROMI) > 0 ) { buff = "The Eternal League forbids Kumiromi from assisting participants of Termination Card Game (TCG)" }
		if ( deck(CREATURE_ID_GOD_INSIDE_EHEKATL) > 0 ) { buff = "The Eternal League forbids Ehekatl from assisting participants of Termination Card Game (TCG)" }
		if ( deck(CREATURE_ID_BLESSED_JURE) > 0 ) { buff = "The Eternal League forbids Jure from assisting participants of Termination Card Game (TCG)" }
		if ( deck(CREATURE_ID_DEVASTATE_LULWY) > 0 ) { buff = "The Eternal League forbids Lulwy from assisting participants of Termination Card Game (TCG)" }
		if ( deck(CREATURE_ID_HYPER_YACATECT) > 0 ) { buff = "The Eternal League forbids Yacatect from assisting participants of Termination Card Game (TCG)" }

		if ( cdata(CDATA_GOD, CHARA_PLAYER) != GOD_ITZPALT & deck(CREATURE_ID_EXILE) > 0 ) { buff = "Only a believer of Itzpalt can use the exile in Termination Card Game (TCG)" }
		if ( cdata(CDATA_GOD, CHARA_PLAYER) != GOD_OPATOS & deck(CREATURE_ID_GOLDEN_KNIGHT) > 0 ) { buff = "Only a believer of Opatos can use the golden knight in Termination Card Game (TCG)" }
		if ( cdata(CDATA_GOD, CHARA_PLAYER) != GOD_MANI & deck(CREATURE_ID_ANDROID) > 0 ) { buff = "Only a believer of Mani can use the android in Termination Card Game (TCG)" }
		if ( cdata(CDATA_GOD, CHARA_PLAYER) != GOD_KUMIROMI & deck(CREATURE_ID_CUTE_FAIRY) > 0 ) { buff = "Only a believer of Kumiromi can use the cute fairy in Termination Card Game (TCG)" }
		if ( cdata(CDATA_GOD, CHARA_PLAYER) != GOD_EHEKATL & deck(CREATURE_ID_BLACK_CAT) > 0 ) { buff = "Only a believer of Ehekatl can use the black cat in Termination Card Game (TCG)" }
		if ( cdata(CDATA_GOD, CHARA_PLAYER) != GOD_JURE & deck(CREATURE_ID_DEFENDER) > 0 ) { buff = "Only a believer of Jure can use the defender in Termination Card Game (TCG)" }
		if ( cdata(CDATA_GOD, CHARA_PLAYER) != GOD_LULWY & deck(CREATURE_ID_BLACK_ANGEL) > 0 ) { buff = "Only a believer of Lulwy can use the black angel in Termination Card Game (TCG)" }
		if ( cdata(CDATA_GOD, CHARA_PLAYER) != GOD_YACATECT & deck(CREATURE_ID_GOOSE) > 0 ) { buff = "Only a believer of Yacatect can use a goose in Termination Card Game (TCG)" }

		if ( buff != "" ) {
			chatList 1, lang("また今度ね", "Maybe next time.")
			gameresult@tcg = 0
			gosub *re_select
			return
		}
	}
	calcdomain
	if ( yaminogemu@tcg == 1 ) {
		lifestake@tcg = limit(cdata(CDATA_HP, CHARA_PLAYER), 1, 200000000), limit(cdata(CDATA_HP, tc), 1, 200000000)
		lifestakebase@tcg = cdata(CDATA_MAX_HP, CHARA_PLAYER), cdata(CDATA_MAX_HP, tc)
		if ( lifestakebase@tcg(0) < lifestakebase@tcg(1) ) {
			cpdata@tcg(TCG_PLAYER_LIFE, TCG_CONTROLLER_OPPONENT) = limit(cpdata@tcg(TCG_PLAYER_LIFE, TCG_CONTROLLER_OPPONENT) * lifestakebase@tcg(1) / lifestakebase@tcg(0), cpdata@tcg(TCG_PLAYER_LIFE, TCG_CONTROLLER_OPPONENT), 200000000)
		}
		if ( lifestakebase@tcg(0) > lifestakebase@tcg(1) ) {
			cpdata@tcg(TCG_PLAYER_LIFE, TCG_CONTROLLER_PLAYER) = limit(cpdata@tcg(TCG_PLAYER_LIFE, TCG_CONTROLLER_PLAYER) * lifestakebase@tcg(0) / lifestakebase@tcg(1), cpdata@tcg(TCG_PLAYER_LIFE, TCG_CONTROLLER_PLAYER), 200000000)
		}
		cpdata@tcg(TCG_PLAYER_LIFE, TCG_CONTROLLER_PLAYER) = limit(cpdata@tcg(TCG_PLAYER_LIFE, TCG_CONTROLLER_PLAYER) * 30 / limit(30 * lifestakebase@tcg(0) / lifestake@tcg(0), 30, 900), 5, 200000000)
		cpdata@tcg(TCG_PLAYER_LIFE, TCG_CONTROLLER_OPPONENT) = limit(cpdata@tcg(TCG_PLAYER_LIFE, TCG_CONTROLLER_OPPONENT) * 30 / limit(30 * lifestakebase@tcg(1) / lifestake@tcg(1), 30, 900), 5, 200000000)
		lifestakestart@tcg = cpdata@tcg(TCG_PLAYER_LIFE, TCG_CONTROLLER_PLAYER), cpdata@tcg(TCG_PLAYER_LIFE, TCG_CONTROLLER_OPPONENT)
	}
	cpdata@tcg(TCG_PLAYER_LIFE_TOTAL, 0) = cpdata@tcg(TCG_PLAYER_LIFE, 0)
	cpdata@tcg(TCG_PLAYER_LIFE_TOTAL, 1) = cpdata@tcg(TCG_PLAYER_LIFE, 1)
	repeat maxcard@tcg
		if ( cdbit(TCG_BIT_ASSASSIN, cnt) == TRUE ) {
			card@tcg(TCG_CARD_CONTROLLER, cnt) = 1 - card@tcg(TCG_CARD_CONTROLLER, cnt)
		}
		if ( cdbit(TCG_BIT_FOSSIL, cnt) == TRUE ) {
			card@tcg(TCG_CARD_REF_ATTACK, cnt) = 0
			card@tcg(TCG_CARD_ATTACK, cnt) = 0
			card@tcg(TCG_CARD_REF_HP, cnt) = limit(card@tcg(TCG_CARD_REF_COST, cnt),1,2000)
			card@tcg(TCG_CARD_HP, cnt) = limit(card@tcg(TCG_CARD_REF_COST, cnt),1,2000)
			card@tcg(TCG_CARD_COST, cnt) = limit(card@tcg(TCG_CARD_REF_COST, cnt)-1,0,2000)
			card@tcg(TCG_CARD_REF_COST, cnt) = limit(card@tcg(TCG_CARD_REF_COST, cnt)-1,0,2000)
			card@tcg(TCG_CARD_REF_PIC, cnt) = -23
			carddetailneff@tcg(cnt) = "Mysterious Fossil No.???    Dinosaur Tourist  Rare:Antique\nEffect: You need to unearth it somehow to use it.\n        Otherwise, it's just a ston"
			c@tcg = cnt
			repeat 128
				cdbitmod cnt, c@tcg, 0
			loop
			cdbitmod TCG_BIT_FOSSIL, c@tcg, 1
			continue
		}
		if ( (effref@tcg(TCG_SKILL_TYPE, card@tcg(TCG_CARD_EFFECT, cnt)) & TCG_SKILL_TYPE_ONGAMESTART) ) {
			effac@tcg = cnt
			eff@tcg = card@tcg(TCG_CARD_EFFECT, cnt)
			gosub *card_action_choose_target
		}
	loop
	ct@tcg = TCG_CONTROLLER_PLAYER
	ct@tcg += rnd(2) // Randomly decide who go first.
	player@tcg = TCG_CONTROLLER_PLAYER
	if ( deck(CREATURE_ID_MANI) > 0 ) {
		player@tcg = TCG_CONTROLLER_OBSERVER
	} else {
		if ( deck(CREATURE_ID_DEUS_EX_MANINA) > 0 ) {
			player@tcg = TCG_CONTROLLER_OPPONENT
		}
	}
	if ( deck(CREATURE_ID_JURE) > 0 | cdata(CDATA_ID, tc) == CREATURE_ID_JURE ) { 
		specialrulecreatureremovewounds@tcg = 1 
	} 
	if ( deck(CREATURE_ID_BLESSED_JURE) > 0 | cdata(CDATA_ID, tc) == CREATURE_ID_BLESSED_JURE ) { 
		specialrulenosaccingmanaautoinc@tcg = 1 
		specialrulenoonedies@tcg = 1 
	} 
	if ( deck(CREATURE_ID_ITZPALT) > 0 ) { 
		maxholdersum@tcg(0) += 4
		maxspotsum@tcg(0) += 4
	} 
	if ( deck(CREATURE_ID_THE_ELEMENT) > 0 ) { 
		maxholdersum@tcg(0) += 4
		maxspotsum@tcg(0) += 4
	} 
	if ( cdata(CDATA_ID, tc) == CREATURE_ID_ITZPALT ) { 
		maxholdersum@tcg(1) += 4
		maxspotsum@tcg(1) += 4
	} 
	if ( cdata(CDATA_ID, tc) == CREATURE_ID_THE_ELEMENT ) { 
		maxholdersum@tcg(1) += 4
		maxspotsum@tcg(1) += 4
	} 
	if ( deck(CREATURE_ID_THE_ELEMENT) > 0 | cdata(CDATA_ID, tc) == CREATURE_ID_ITZPALT | cdata(CDATA_ID, tc) == CREATURE_ID_THE_ELEMENT ) {
		specialruledrawswhenhandfull@tcg = 1 
		specialruledrawtwocardsperturn@tcg = 1 
		specialruleanyonecanblock@tcg = 1
		specialruleusefatigue@tcg = 1
	} 
	if ( cdata(CDATA_ID, tc) == CREATURE_ID_ITZPALT | cdata(CDATA_ID, tc) == CREATURE_ID_OPATOS | cdata(CDATA_ID, tc) == CREATURE_ID_MANI | cdata(CDATA_ID, tc) == CREATURE_ID_KUMIROMI | cdata(CDATA_ID, tc) == CREATURE_ID_EHEKATL | cdata(CDATA_ID, tc) == CREATURE_ID_JURE | cdata(CDATA_ID, tc) == CREATURE_ID_LULWY | cdata(CDATA_ID, tc) == CREATURE_ID_YACATECT | cdata(CDATA_ID, tc) == CREATURE_ID_THE_ELEMENT | cdata(CDATA_ID, tc) == CREATURE_ID_BUILDUP_OPATOS | cdata(CDATA_ID, tc) == CREATURE_ID_DEUS_EX_MANINA | cdata(CDATA_ID, tc) == CREATURE_ID_INSANE_KUMIROMI | cdata(CDATA_ID, tc) == CREATURE_ID_GOD_INSIDE_EHEKATL | cdata(CDATA_ID, tc) == CREATURE_ID_BLESSED_JURE | cdata(CDATA_ID, tc) == CREATURE_ID_DEVASTATE_LULWY | cdata(CDATA_ID, tc) == CREATURE_ID_HYPER_YACATECT ) {
		repeat maxcard@tcg
			if ( card@tcg(TCG_CARD_REF_DBID, cnt) == cdata(CDATA_ID, tc) ) {
				if ( card@tcg(TCG_CARD_CONTROLLER, cnt) == 0 ) {
					gravecard cnt
				} else {
					cdbitmod TCG_BIT_CONSTANT, cnt, 1
				}
			}
		loop
	}
	repeat 2
		initcp@tcg = cnt
		repeat calcstartcard(cnt)
			if ( initcp@tcg == ct@tcg & cnt == 0 ) {
				continue
			}
			getrandomcard initcp@tcg
		loop
	loop
	if ( cdata(CDATA_ID, tc) == CREATURE_ID_JALDABAOTH_THE_CHAOS_CHILD | cdata(CDATA_ID, tc) == CREATURE_ID_THE_CHAOS_CHILD | cdata(CDATA_ID, tc) == CREATURE_ID_AIME_THE_STORY_TELLER ) {
		f@tcg = 0
		repeat maxcard@tcg
			if ( card@tcg(TCG_CARD_REF_DBID, cnt) == CREATURE_ID_JALDABAOTH_THE_CHAOS_CHILD | card@tcg(TCG_CARD_REF_DBID, cnt) == CREATURE_ID_THE_CHAOS_CHILD ) {
				if ( card@tcg(TCG_CARD_CONTROLLER, cnt) == 0 | f@tcg == 1 ) {
					gravecard cnt
				} else {
					cdbitmod TCG_BIT_ENEMY, cnt, 0
					putcardfree@tcg = 1
					putcard cnt, TCG_CONTROLLER_OPPONENT
					efllistaddchat cnvtalk("Let there be light..."), cnt
					f@tcg = 1
				}
			}
		loop
	}
	*tcgmain_WHILE1
	cpisme
	gosub *phase_begin
	if ( gameover() ) {
		goto *tcgmain_WEND1
	}
	gosub *phase_draw
	if ( gameover() ) {
		goto *tcgmain_WEND1
	}
	gosub *phase_main
	if ( gameover() ) {
		goto *tcgmain_WEND1
	}
	gosub *phase_end
	if ( (specialruletimestop@tcg > 0 & ct@tcg == TCG_CONTROLLER_PLAYER) ) {
		specialruletimestop@tcg--
		goto *tcgmain_WHILE1
	}
	if ( (specialruletimestop@tcg < 0 & ct@tcg == TCG_CONTROLLER_OPPONENT) ) {
		specialruletimestop@tcg++
		goto *tcgmain_WHILE1
	}
	if ( ct@tcg == TCG_CONTROLLER_PLAYER ) {
		ct@tcg = TCG_CONTROLLER_OPPONENT
	}
	else {
		ct@tcg = TCG_CONTROLLER_PLAYER
	}
	goto *tcgmain_WHILE1
	*tcgmain_WEND1
		
	if ( yaminogemu@tcg == 1 ) {
		lifestakeend@tcg = cpdata@tcg(TCG_PLAYER_LIFE, TCG_CONTROLLER_PLAYER), cpdata@tcg(TCG_PLAYER_LIFE, TCG_CONTROLLER_OPPONENT)
	}
	listmax = 0
	if ( gameresult@tcg == -1 ) {
		s = "Surrendered!"
		file = "bg_re12"
		chatList 1, lang("また今度ね", "Maybe next time.")
	}
	if ( gameresult@tcg == -2 ) {
		s = "Escaped!"
		file = "bg_re9"
		chatList 1, lang("また今度ね", "Maybe next time.")
	}
	if ( gameresult@tcg > 0 & gameresult@tcg \ 2 == 1 ) {
		s = "You Win!"
		file = "bg_re15"
		chatList 1, lang("また今度ね", "To the Amur-cage you go!")
	}
	if ( gameresult@tcg > 0 & gameresult@tcg \ 2 == 0 ) {
		s = "You Lose!"
		file = "bg_re7"
		chatList 1, lang("また今度ね", "Noooooooooooooo!")
	}
	buff = "Unexpected outcome, report to developer."
	if ( gameresult@tcg == -1 ) { buff = "You flipped the table and leave the game." }
	if ( gameresult@tcg == -2 ) { buff = "You flipped the table in a hurry and leave the game." }
	if ( gameresult@tcg == 1 ) { buff = "Opponent's health is reduced to 0." }
	if ( gameresult@tcg == 2 ) { buff = "Your health is reduced to 0." }
	if ( gameresult@tcg == 3 ) { buff = "Opponent can't draw any cards." }
	if ( gameresult@tcg == 4 ) { buff = "You can't draw any cards." }
	if ( gameresult@tcg == 5 ) { buff = "You won using Zeome's effect." }
	if ( gameresult@tcg == 6 ) { buff = "You lose due to Zeome's effect." }
	if ( gameresult@tcg == 7 ) { buff = "You won using Meshera's effect." }
	if ( gameresult@tcg == 8 ) { buff = "You lose due to Meshera's effect." }
	if ( gameresult@tcg == 9 ) { buff = "You won using Unitdeads' effect." }
	if ( gameresult@tcg == 10 ) { buff = "You lose due to Unitdeads' effect." }
	if ( gameresult@tcg == 11 ) { buff = "You opponent is BANNED." }
	if ( gameresult@tcg == 12 ) { buff = "You are BANNED!" }
	if ( gameresult@tcg == 13 ) { buff = "You've been playing for too long!" }
	if ( gameresult@tcg == 14 ) { buff = "You've been playing for too long!" }
	if ( gameresult@tcg == 15 ) { buff = "You won due to the Chaos Child's effect." }
	if ( gameresult@tcg == 16 ) { buff = "You lose due to the Chaos Child's effect." }
	gosub *re_select
	tcginit2
	gosub *tcg_drawInterface
	gosub *refresh_bg
	tcgdraw
	*tcgmain_WEND2
	cardhelp lang("ゲームオーバー！Enterキーで退出。", "Game Over! Press Enter to leave."), 40
	tcgdraw
	await 15
	key_check
	if ( key == key_enter | key == key_cancel | key == key_escape | click_right@MMAH ) {
		return
	}
	goto *tcgmain_WEND2
	return

*phase_begin
	phase@tcg = 0
	turn@tcg++
	if ( turn@tcg > 50 | specialruleusealwaysfatigue@tcg(ct@tcg) ) {
		fatigueplayer ct@tcg
	}
	tcgdraw
	await 50
	sac@tcg = 0
	if ( ct@tcg == player@tcg ) {
		specialruleaitakeover@tcg = 0
	}
	if ( specialrulenosaccingmanaautoinc@tcg ) {
		sac@tcg = 1
		cpdata@tcg(TCG_PLAYER_MAX_MANA, cp@tcg)++
	}
	cpdata@tcg(TCG_PLAYER_MANA, cp@tcg) = limit(cpdata@tcg(TCG_PLAYER_MAX_MANA, cp@tcg) + specialrulenextturnmana@tcg(cp@tcg), 0, 10000)
	specialrulenextturnmana@tcg(cp@tcg) = 0
	repeat maxcard@tcg
		if ( cdbit(TCG_BIT_GHOST, cnt) != TRUE ) { continue }
		if ( card@tcg(TCG_CARD_CONTROLLER, cnt) != cp@tcg ) { continue }
		if ( card@tcg(TCG_CARD_LOCATION, cnt) != TCG_LOCATION_FIELD ) { continue }
		gettargetcard cnt
	loop
	repeat maxcard@tcg
		if ( card@tcg(TCG_CARD_CONTROLLER, cnt) != cp@tcg ) { continue }
		if ( card@tcg(TCG_CARD_LOCATION, cnt) != TCG_LOCATION_GRAVEYARD ) { continue }
		card@tcg(TCG_CARD_TURN_COUNT, cnt)++
		effac@tcg = cnt
		eff@tcg = card@tcg(TCG_CARD_EFFECT, cnt)
		if ( (effref@tcg(TCG_SKILL_TYPE, eff@tcg) & TCG_SKILL_TYPE_INGRAVE) ) {
			proctcg "tcg proc/in-grave: effac:" + effac@tcg + "/eff" + eff@tcg
			cdbitmod TCG_BIT_FACE_UP, effac@tcg, 1
			gosub *card_action_choose_target
		}
	loop
	repeat maxcard@tcg
		if ( card@tcg(TCG_CARD_LOCATION, cnt) != TCG_LOCATION_HAND & card@tcg(TCG_CARD_LOCATION, cnt) != TCG_LOCATION_FIELD ) { continue }
		if ( card@tcg(TCG_CARD_CONTROLLER, cnt) != cp@tcg ) { continue }
		card@tcg(TCG_CARD_TURN_COUNT, cnt)++
		if ( cdbit(TCG_BIT_POISONED, cnt) ) {
			card@tcg(TCG_CARD_HP, cnt)--
		}
		if ( cdbit(TCG_BIT_REGENERATION, cnt) | specialrulecreatureremovewounds@tcg ) {
			card@tcg(TCG_CARD_HP, cnt) = card@tcg(TCG_CARD_REF_HP, cnt)
			cdbitmod TCG_BIT_POISONED, cnt, 0
		}
		if ( card@tcg(TCG_CARD_HP, cnt) <= 0 ) {
			card@tcg(TCG_CARD_ANIM, cnt) = TCG_ANIM_FADE, 18
			tcgdraw
			gravecard cnt
			continue
		}
	loop
	repeat maxcard@tcg
		if ( card@tcg(TCG_CARD_LOCATION, cnt) != TCG_LOCATION_FIELD ) {
			continue
		}
		if ( card@tcg(TCG_CARD_CONTROLLER, cnt) != cp@tcg ) {
			continue
		}
		if ( cdbit(TCG_BIT_WINDFURY, cnt) == TRUE ) {
			cdbitmod TCG_BIT_WINDFURY_USABLE, cnt, 1
		}
		card@tcg(TCG_CARD_STATUS, cnt) = TCG_ACTION_NONE
		cdbitmod TCG_BIT_EXHAUSTED, cnt, 0
		if ( cdbit(TCG_BIT_FROZEN, cnt) == TRUE & card@tcg(TCG_CARD_STATUS, cnt) == TCG_ACTION_NONE ) {
			cdbitmod TCG_BIT_FROZEN, cnt, 0
			cdbitmod TCG_BIT_EXHAUSTED, cnt, 1
			card@tcg(TCG_CARD_STATUS, cnt) = TCG_ACTION_EXHAUSTED
		}
		if ( cdbit(TCG_BIT_PARALYSED, cnt) == TRUE & card@tcg(TCG_CARD_STATUS, cnt) == TCG_ACTION_NONE ) {
			cdbitmod TCG_BIT_PARALYSED, cnt, 0
			cdbitmod TCG_BIT_EXHAUSTED, cnt, 1
			card@tcg(TCG_CARD_STATUS, cnt) = TCG_ACTION_EXHAUSTED
		}
		if ( cdbit(TCG_BIT_DEATHWORD, cnt) & card@tcg(TCG_CARD_TURN_COUNT, cnt) >= 3) {
			card@tcg(TCG_CARD_HP, cnt) = 0
		}
		if ( card@tcg(TCG_CARD_HP, cnt) <= 0 ) {
			dmgcard cnt, 0
			continue
		}
		effac@tcg = cnt
		eff@tcg = card@tcg(TCG_CARD_EFFECT, cnt)
		if ( (effref@tcg(TCG_SKILL_TYPE, eff@tcg) & TCG_SKILL_TYPE_TURN_START) ) {
			proctcg "tcg proc/phase-begin: effac:" + effac@tcg + "/eff" + eff@tcg
			gosub *card_action_choose_target
		}
	loop
	makecardlist
	tcgdraw
	return

*phase_draw
	phase@tcg = 1
	tcgdraw
	await 50
	getrandomcard cp@tcg
	if ( specialruledrawtwocardsperturn@tcg ) {
		await 50
		getrandomcard cp@tcg
	}
	if ( cp@tcg != player@tcg & getspotsum(1-cp@tcg) >= getspotsum(cp@tcg) + 1 + rnd(6) ) { // Give AI extra cards because they suck
		await 50
		specialrulenextdrawtempo@tcg++
		getrandomcard cp@tcg
	}
	if ( dbg_tcg & cp@tcg == player@tcg ) {
		repeat 7 
			await 50
			getrandomcard cp@tcg
		loop
	}
	repeat maxcard@tcg
		if ( card@tcg(TCG_CARD_LOCATION, cnt) != TCG_LOCATION_HAND ) { continue }
		if ( card@tcg(TCG_CARD_CONTROLLER, cnt) != cp@tcg ) { continue }
		effac@tcg = cnt
		eff@tcg = card@tcg(TCG_CARD_EFFECT, cnt)
		if ( (effref@tcg(TCG_SKILL_TYPE, eff@tcg) & TCG_SKILL_TYPE_INHAND) ) {
			proctcg "tcg proc/in-hand: effac:" + effac@tcg + "/eff" + eff@tcg
			cdbitmod TCG_BIT_FACE_UP, effac@tcg, 1
			gosub *card_action_choose_target
		}
	loop
	tcgdraw
	return

*phase_main
	phase@tcg = 2
	tcgdraw
	await 50
	if ( cp@tcg == player@tcg & specialruleaitakeover@tcg <= 0 ) {
		selectmode@tcg = 0
		gosub *card_player
	}
	else {
		selectmode@tcg = -1
		gosub *card_ai
	}
	return

*phase_end
	specialrulemanalastturn@tcg(cp@tcg) = cpdata@tcg(TCG_PLAYER_MANA)
	repeat maxcard@tcg
		if ( card@tcg(TCG_CARD_LOCATION, cnt) != TCG_LOCATION_FIELD ) {
			continue
		}
		if ( card@tcg(TCG_CARD_CONTROLLER, cnt) != cp@tcg ) {
			continue
		}
		effac@tcg = cnt
		eff@tcg = card@tcg(TCG_CARD_EFFECT, cnt)
		if ( (effref@tcg(TCG_SKILL_TYPE, eff@tcg) & TCG_SKILL_TYPE_TURN_END) ) {
			proctcg "tcg proc/phase-end: effac:" + effac@tcg + "/eff" + eff@tcg
			gosub *card_action_choose_target
		}
	loop
	repeat maxcard@tcg
		if ( card@tcg(TCG_CARD_LOCATION, cnt) == TCG_LOCATION_FIELD | (card@tcg(TCG_CARD_LOCATION, cnt) == TCG_LOCATION_HAND & card@tcg(TCG_CARD_CONTROLLER, cnt) == cp@tcg) ) { 
			cdbitmod TCG_BIT_CONFUSED, cnt, 0
		}
		if ( cdbit(TCG_BIT_FLEETING, cnt) == TRUE & card@tcg(TCG_CARD_LOCATION, cnt) = TCG_LOCATION_HAND & card@tcg(TCG_CARD_CONTROLLER, cnt) == cp@tcg ) {
			card@tcg(TCG_CARD_ANIM, cnt) = TCG_ANIM_FADE, 18
			tcgdraw
			gravecard cnt
		}
	loop
	makecardlist
	tcgdraw
	phase@tcg = 3
	if ( cp@tcg == player@tcg ) {
		selectmode@tcg = 0
	}
	else {
		selectmode@tcg = -1
	}
	tcgdraw
	return

#deffunc csfix
	if ( selectmode@tcg == 2 ) {
		if ( targetlinenum@tcg <= 0 ) { return }
		targetlinevalid@tcg = 0
		repeat targetlinenum@tcg
			if ( csline@tcg == targetline@tcg(cnt) ) {
				targetcs@tcg = cnt
				targetlinevalid@tcg = 1 
			}
		loop
		if ( targetlinevalid@tcg == 0 ) {
			targetcs@tcg = 0
			csline@tcg = targetline@tcg(0)
			cs@tcg = 0 - (csline@tcg == 0)
		}
		repeat 6
			if ( clistmax@tcg(csline@tcg) < 0 | cs@tcg >= clistmax@tcg(csline@tcg) ) {
				if ( cnt != 0 ) { targetcs@tcg++ }
				if ( targetcs@tcg >= targetlinenum@tcg ) { targetcs@tcg = 0 }
				if ( targetcs@tcg < 0 ) { targetcs@tcg = targetlinenum@tcg - 1 }
				csline@tcg = targetline@tcg(targetcs@tcg)
				cs@tcg = 0 - (csline@tcg == 0)
			} else {
				break
			}
			if ( cnt == 5 ) {
				targetlinenum@tcg = 0
				csline@tcg = 0
				cs@tcg = -1
			}
		loop
		return
	}
	if ( clistmax@tcg(csline@tcg) == 0 ) {
		if ( csline@tcg != 0 ) {
			cs@tcg = -1
			csline@tcg = 0
		}
	}
	if ( cs@tcg == (-1) ) {
		if ( csline@tcg != 0 ) {
			cs@tcg = 0
		}
	}
	if ( cs@tcg >= clistmax@tcg(csline@tcg) ) {
		if ( csline@tcg == 0 ) {
			cs@tcg = -1
		}
		else {
			cs@tcg = 0
		}
	}
	if ( cs@tcg < (-1) ) {
		cs@tcg = clistmax@tcg(csline@tcg) - 1
	}
	return

#deffunc cslineup
	if ( selectmode@tcg == 2 ) {
		if ( targetlinenum@tcg <= 0 ) { return }
		targetcs@tcg++
		if ( targetcs@tcg >= targetlinenum@tcg ) { targetcs@tcg = 0 }
		if ( targetcs@tcg < 0 ) { targetcs@tcg = targetlinenum@tcg - 1 }
		csline@tcg = targetline@tcg(targetcs@tcg)
		cs@tcg = 0 - (csline@tcg == 0 | csline@tcg == 3)
		return
	}
	repeat
		csline@tcg++
		if ( csline@tcg == 4 ) {
			break
		}
		if ( clistmax@tcg(csline@tcg) != 0 ) {
			break
		}
	loop
	if ( csline@tcg == 4 ) {
		csline@tcg = 0
	}
	if ( csline@tcg == 0 | csline@tcg == 3 ) {
		cs@tcg = -1
	}
	else {
		cs@tcg = 0
	}
	if ( cs@tcg >= clistmax@tcg(csline@tcg) ) {
		cs@tcg = clistmax@tcg(csline@tcg) - 1
	}
	return

#deffunc cslinedown
	if ( selectmode@tcg == 2 ) {
		if ( targetlinenum@tcg <= 0 ) { return }
		targetcs@tcg--
		if ( targetcs@tcg >= targetlinenum@tcg ) { targetcs@tcg = 0 }
		if ( targetcs@tcg < 0 ) { targetcs@tcg = targetlinenum@tcg - 1 }
		csline@tcg = targetline@tcg(targetcs@tcg)
		cs@tcg = 0 - (csline@tcg == 0 | csline@tcg == 3)
		return
	}
	if ( csline@tcg == 0 ) {
		csline@tcg = 4
	}
	repeat
		csline@tcg--
		if ( csline@tcg == (-1) ) {
			break
		}
		if ( clistmax@tcg(csline@tcg) != 0 ) {
			break
		}
	loop
	if ( csline@tcg == (-1) ) {
		csline@tcg = 0
	}
	if ( csline@tcg == 0 | csline@tcg == 3  ) {
		cs@tcg = -1
	}
	else {
		cs@tcg = 0
	}
	if ( cs@tcg >= clistmax@tcg(csline@tcg) ) {
		cs@tcg = clistmax@tcg(csline@tcg) - 1
	}
	return

*refresh_bg
	gsel 4
	pos 0, 0
	picload exedir + "graphic\\bg_card.bmp", 1
	gmode 2
	font lang(cfg_font1, cfg_font2), 14 - en * 2, 0
	color 255, 255, 255
	repeat 2
		gmode 0
		cnt2@tcg = cnt
		dim mana@tcg, 10
		repeat landsum@tcg(cnt2@tcg)
			x@tcg = landix@tcg(cnt2@tcg) - basex@tcg + cnt * limit(landspace@tcg - landsum@tcg(cnt2@tcg) / 2, 4, landspace@tcg)
			y@tcg = landiy@tcg(cnt2@tcg) - basey@tcg
			m@tcg = landlist@tcg(cnt, cnt2@tcg)
			n@tcg = abs(card@tcg(TCG_CARD_REF_PIC, m@tcg))
			mana@tcg(card@tcg(TCG_CARD_REF_DOMAIN, m@tcg))++
			pos x@tcg, y@tcg
			// gcopy 2, n@tcg \ 22 * 72, n@tcg / 22 * 96, 72, 96
			gcopy 7, 72 + card@tcg(TCG_CARD_REF_DOMAIN, m@tcg) * 72, 0, 72, 96
		loop
		y@tcg = landiy@tcg(cnt2@tcg) - basey@tcg + (cnt == 0) * 80
		x@tcg = landix@tcg(cnt2@tcg) - basex@tcg - 16
		repeat 10
			if ( mana@tcg(cnt) == 0 ) {
				continue
			}
			pos x@tcg - 15, y@tcg - 2
			// gcopy 7, cnt * 12, 126, 12, 18
			gzoom 12, 18, 7, 72 + cnt * 72, 0, 72, 96
			pos x@tcg, y@tcg
			mes mana@tcg(cnt)
			if ( cnt2@tcg == 0 ) {
				y@tcg -= 20
			}
			else {
				y@tcg += 20
			}
		loop
		gravespace@tcg = 22
		if ( gravesum@tcg(cnt2@tcg) > 5 ) {
			gravespace@tcg = 110 / gravesum@tcg(cnt2@tcg)
		}
		repeat gravesum@tcg(cnt2@tcg)
			x@tcg = graveix@tcg(cnt2@tcg) - basex@tcg - cnt * gravespace@tcg
			y@tcg = graveiy@tcg(cnt2@tcg) - basey@tcg
			m@tcg = gravelist@tcg(cnt, cnt2@tcg)
			if ( dbg_tcg ) {
				pos x@tcg + 60, y@tcg - 28
				color 0, 0, 0
				bmes "" + m@tcg, 235, 235, 235
				pos x@tcg + 60, y@tcg - 14
				color 0, 0, 0
				bmes "" + card@tcg(TCG_CARD_EFFECT, m@tcg), 235, 235, 235
			}
			if ( card@tcg(TCG_CARD_REF_PIC, m@tcg) > 0 ) {
				gmode 2
				pos x@tcg, y@tcg
				gcopy 7, 72 + card@tcg(TCG_CARD_REF_BG, m@tcg) * 72, 0, 72, 96
				if ( gravesum@tcg(cnt2@tcg) <= 3 | cnt == gravesum@tcg(cnt2@tcg) - 1 ) {
					if ( card@tcg(TCG_CARD_REF_DBID, m@tcg) != CREATURE_ID_USER ) {
						n@tcg = card@tcg(TCG_CARD_REF_PIC, m@tcg) \ COLOR_TINT_MULT + card@tcg(TCG_CARD_REF_CHARA_PIC, m@tcg) * COLOR_TINT_MULT
						chara_preparepic n@tcg, (card@tcg(TCG_CARD_REF_PIC, m@tcg) - card@tcg(TCG_CARD_REF_CHARA_PIC, m@tcg) * COLOR_TINT_MULT) / COLOR_TINT_MULT
						gsel 4
					}
					else {
						n@tcg = 1
						chara_preparepic n@tcg, 0
						gsel 4
					}
					if ( card@tcg(TCG_CARD_REF_DBID, m@tcg) == CREATURE_ID_USER ) {
						gmode 2, 32, 48
						pos x@tcg + 21, y@tcg + 24
						gcopy 10, 0, 0, 32, 48
					} else {
						color 0, 0, 0
						pos x@tcg + 13, y@tcg + 32 - chipc(CHIPC_F, n@tcg) + chipc(CHIPC_HEIGHT, n@tcg) / 6
						gcopy 5, 0, 960, chipc(CHIPC_WIDTH, n@tcg), chipc(CHIPC_HEIGHT, n@tcg)
					}
				}
			}
			else {
				gmode 0
				pos x@tcg, y@tcg
				gcopy 7, 72 + card@tcg(TCG_CARD_REF_BG, m@tcg) * 72, 0, 72, 96
				if ( card@tcg(TCG_CARD_REF_PIC, m@tcg) < 0 ) {
					n@tcg = abs(card@tcg(TCG_CARD_REF_PIC, m@tcg))
					gcopy 2, n@tcg \ 22 * 72, n@tcg / 22 * 96, 72, 96
				}
			}
		loop
	loop
	gsel 0
	return

*tcg_drawDeck
	font lang(cfg_font1, cfg_font2), 10 + en - en * 2, 0
	color 255, 255, 255
	gmode 2
	repeat cfmax@tcg
		x@tcg = basex@tcg + 180 + cnt * 63
		y@tcg = basey@tcg + 26 + (ccf@tcg == cnt) * 3
		p@tcg = cflist@tcg(cnt)
		color 0, 0, 0
		if ( ccf@tcg == cnt ) {
			gmode 4, , , 255
			color 255, 255, 255
		}
		else {
			gmode 4, , , 120
			color 200, 200, 200
		}
		pos x@tcg, y@tcg
		gcopy 7, 360, 96, 63, 20
		gmode 2
		pos x@tcg + 1, y@tcg + 4
		mes cfname@tcg(p@tcg)
		if ( ccf@tcg == cnt ) {
			pos x@tcg + 65, y@tcg - 5
			gcopy 7, 288, 96, 24, 24
		}
	loop
	font lang(cfg_font1, cfg_font2), 13 + en - en * 2, 0
	repeat 8 * 3
		p@tcg = page@tcg * 8 + cnt
		if ( p@tcg >= dlistmax@tcg ) {
			break
		}
		c@tcg = dlist@tcg(0, p@tcg)
		i@tcg = card@tcg(TCG_CARD_REF_DBID, c@tcg)
		x@tcg = basex@tcg + 144 + cnt \ 8 * 80
		y@tcg = basey@tcg + 70 + cnt / 8 * 150
		if ( deckmode@tcg == 0 ) {
			if ( deck(i@tcg) != 0 ) {
				s@tcg = "" + deck(i@tcg)
			}
			else {
				s@tcg = ""
			}
			s@tcg += "(" + card(0, i@tcg) + ")"
			color 0, 0, 0
			pos x@tcg + 1, y@tcg + 111
			mes s@tcg
			if ( deck(i@tcg) != 0 ) {
				color 150, 255, 150
			}
			else {
				color 200, 200, 200
			}
			pos x@tcg, y@tcg + 110
			mes s@tcg
		}
		card@tcg(TCG_CARD_X, c@tcg) = x@tcg
		card@tcg(TCG_CARD_Y, c@tcg) = y@tcg
		card@tcg(TCG_CARD_X_MOVETO, c@tcg) = x@tcg
		card@tcg(TCG_CARD_Y_MOVETO, c@tcg) = y@tcg
		tcgdrawcard c@tcg, 1
	loop
	font lang(cfg_font1, cfg_font2), 13 - en * 2, 0
	color 255, 255, 255
	s@tcg = ""
	if ( sortmode@tcg == 0 ) { s@tcg += "Sort by: DBID   " }
	if ( sortmode@tcg == 1 ) { s@tcg += "Sort by: Domain   " }
	if ( sortmode@tcg == 2 ) { s@tcg += "Sort by: Cost   " }
	if ( sortmode@tcg == 3 ) { s@tcg += "Sort by: Attack   " }
	if ( sortmode@tcg == 4 ) { s@tcg += "Sort by: Hp   " }
	if ( filtertype@tcg == 0 ) { s@tcg += "Filter: DBID   " }
	if ( filtertype@tcg == 1 ) { s@tcg += "Filter: Domain   " }
	if ( filtertype@tcg == 2 ) { s@tcg += "Filter: Cost   " }
	if ( filtertype@tcg == 3 ) { s@tcg += "Filter: Attack   " }
	if ( filtertype@tcg == 4 ) { s@tcg += "Filter: Hp   " }
	if ( filtertype@tcg >= 5 & filtertype@tcg <= 14 ) { s@tcg += "Filter: Race" + (filtertype@tcg - 4) + "   " }
	if ( filtertype@tcg == 15 ) { s@tcg += "Filter: Class1   " }
	if ( filtertype@tcg == 16 ) { s@tcg += "Filter: Class2 & Sex   " }
	if ( s@tcg != "" ) {
		pos basex@tcg + 130, basey@tcg + 500
		mes s@tcg
	}
	pos basex@tcg + 130, basey@tcg + 515
	mes lang("" + key_next + "," + key_prev + ",Tab [フィルター切替]  決定ｷｰ [カード選択]  ｷｬﾝｾﾙｷｰ [終了]", "" + key_next + "," + key_prev + " [<-Filter->] " + key_fire + "," + key_get + " [Type] " + key_search + " [Sort] " + key_charainfo + " [Info] Enter [Select]  Cancel [Exit]")
	pos basex@tcg + 700, basey@tcg + 515
	mes "Page " + ((dsc@tcg / 8 / 3) + 1) + "/" + (((dlistmax@tcg - 1) / 8 / 3) + 1)
	return

*tcg_drawInterface
	gmode 0
	pos basex@tcg, basey@tcg
	gcopy 4, 0, 0, basew@tcg, baseh@tcg
	font lang(cfg_font1, cfg_font2), 13 - en * 2, 0
	gmode 2
	pos basex@tcg + 20, basey@tcg + 22
	if ( cardmode@tcg != 0 | ct@tcg == player@tcg ) {
		gcopy 7, 360, 120, 88, 84
	}
	else {
		gcopy 7, 456, 120, 88, 84
	}
	if ( cardmode@tcg == 0 ) {
		color 0, 0, 0
		pos basex@tcg + 39, basey@tcg + 58
		mes "Turn " + turn@tcg
		color 255, 255, 255
		pos basex@tcg + 38, basey@tcg + 57
		mes "Turn " + turn@tcg
		repeat 2
			x@tcg = cpx@tcg(cnt)
			y@tcg = cpy@tcg(cnt)
			pos x@tcg, y@tcg
			gcopy 7, 264, 144, 72, 120
			s@tcg = "" + cpdata@tcg(TCG_PLAYER_LIFE, cnt)
			pos x@tcg + 36 - strlen(s@tcg) * 3, y@tcg + 9 - en
			mes s@tcg
			if ( cnt == (1 - player@tcg) & debug == 0 ) {
				s@tcg = "?/" + cpdata@tcg(TCG_PLAYER_MAX_MANA, cnt)
			}
			else {
				s@tcg = "" + cpdata@tcg(TCG_PLAYER_MANA, cnt) + "/" + cpdata@tcg(TCG_PLAYER_MAX_MANA, cnt)
			}
			pos x@tcg + 36 - strlen(s@tcg) * 3, y@tcg + 95 - en
			mes s@tcg
		loop
		repeat 4
			if ( cnt - 1 == phase@tcg ) {
				pos basex@tcg + 4, basey@tcg + 370 + cnt * 20
				gcopy 7, 360, 216, 106, 18
			}
			pos basex@tcg + 36, basey@tcg + 373 + cnt * 20
			if ( cnt == 0 ) {
				if ( ct@tcg == player@tcg ) {
					color 150, 150, 255
					mes "Player"
				}
				else {
					color 255, 150, 150
					mes "Opponent"
				}
				color 215, 215, 215
			}
			else {
				mes phasen@tcg(cnt - 1)
			}
		loop
	}
	else {
		color 0, 0, 0
		pos basex@tcg + 41, basey@tcg + 53
		mes "Deck\n Editor"
		color 255, 255, 255
		pos basex@tcg + 40, basey@tcg + 52
		mes "Deck\n Editor"
		pos basex@tcg + 24, basey@tcg + 120
		if ( gdata(GDATA_DECK_SIZE + curdeck) < MIN_CARD_DECK ) {
			color 255, 100, 100
			mes "Deck " + gdata(GDATA_DECK_SIZE + curdeck) + "/" + MIN_CARD_DECK
		}
		else {
			if ( gdata(GDATA_DECK_SIZE + curdeck) > MAX_CARD_DECK ) {
				color 255, 100, 100
				mes "Deck " + gdata(GDATA_DECK_SIZE + curdeck) + "/" + MAX_CARD_DECK

			} else {
				color 100, 255, 100
				mes "Deck " + gdata(GDATA_DECK_SIZE + curdeck) + "/" + gdata(GDATA_DECK_SIZE + curdeck)
			}
		}
		color 215, 215, 215
		pos basex@tcg + 24, basey@tcg + 140
		mes "Life " + cpdata@tcg(TCG_PLAYER_LIFE, 0)
		pos basex@tcg + 24, basey@tcg + 160
		mes "Mana " + cpdata@tcg(TCG_PLAYER_MAX_MANA, 0)
		pos basex@tcg + 24, basey@tcg + 180
		mes "Card " + calcstartcard(0)
		pos basex@tcg + 24, basey@tcg + 220
		mes "Domain * " + cpdata@tcg(TCG_PLAYER_DOMAIN, 0)
		s@tcg = ""
		repeat 9
			if ( domain@tcg(cnt) ) {
				s@tcg += "" + domname@tcg(cnt) + "\n"
			}
		loop
		pos basex@tcg + 24, basey@tcg + 240
		mes s@tcg
	}
	if ( gdata(GDATA_QUICK_USE) == 1 ) {
		font lang(cfg_font1, cfg_font2), 12, 0
		pos basex@tcg + 125, basey@tcg + 542
		mes helpmsg@tcg
	}
	else {
		font lang(cfg_font1, cfg_font2), 10, 0
		if ( displayinfo@tcg == 1 ) {
			font cfg_font2, 13, 0
		}
		pos basex@tcg + 120, basey@tcg + 537
		mes helpmsg@tcg
	}
	return

*tcg_initBg
	gmode 4, , , 180
	redraw 0
	repeat 2
		cnt2@tcg = cnt
	loop
	gsel 0
	return

*select_deck_pos
	if ( dsc@tcg < 0 ) {
		dsc@tcg = dlistmax@tcg - 1
	}
	if ( dsc@tcg >= dlistmax@tcg ) {
		dsc@tcg = 0
	}
	if ( dsc@tcg >= (page@tcg + 3) * 8 ) {
		page@tcg = dsc@tcg / 8
	}
	if ( dsc@tcg < page@tcg * 8 ) {
		page@tcg = dsc@tcg / 8
	}
	page@tcg = page@tcg - page@tcg \ 3
	return

*select_deck
	gsel 4
	pos 0, 0
	picload exedir + "graphic\\bg_card.bmp", 1
	gsel 0
	dim dlist@tcg, 2, 400
	dim cflist@tcg, 10
	sdim cfname@tcg, 16, 10
	cfname@tcg = lang("候補", "List"), lang("デッキ", "Deck"), domname@tcg(0), domname@tcg(1), domname@tcg(2), domname@tcg(3), domname@tcg(4), domname@tcg(5), domname@tcg(6), domname@tcg(7), domname@tcg(8), domname@tcg(9)
	cflist@tcg = 0
	cfmax@tcg = 1
	ccf@tcg = 0
	if ( deckmode@tcg == 0 ) {
		cflist@tcg = 1, 2, 3, 4, 5, 6, 7, 8, 9
		cfmax@tcg = 9
		if ( filtertype@tcg == 0 ) {
			cfname@tcg = lang("候補", "List"), lang("デッキ", "Deck"), "0-150", "151-300", "301-450", "451-600", "601-750", "751-900", "900+  ", "All" 
			cflist@tcg = 1, 2, 3, 4, 5, 6, 7, 8, 9, 10
			cfmax@tcg = 9
		}
		if ( filtertype@tcg == 1 ) {
			cfname@tcg = lang("候補", "List"), lang("デッキ", "Deck"), "Blue", "Green", "White", "Black", "Neutral", "Legendary", "Gray", "Red", "All"
			cflist@tcg = 1, 2, 3, 4, 5, 6, 7, 8, 9, 10
			cfmax@tcg = 10
		}
		if ( filtertype@tcg == 2 ) {
			cfname@tcg = lang("候補", "List"), lang("デッキ", "Deck"), "Cost 0", "Cost 1", "Cost 2", "Cost 3", "Cost 4", "Cost 5", "Cost 6", "Cost 7", "Cost 8+"
			cflist@tcg = 1, 2, 3, 4, 5, 6, 7, 8, 9, 10
			cfmax@tcg = 10
		}
		if ( filtertype@tcg == 3 ) {
			cfname@tcg = lang("候補", "List"), lang("デッキ", "Deck"), "1- Atk", "2 Atk", "3 Atk", "4 Atk", "5 Atk", "6 Atk", "7 Atk", "8 Atk", "9+ Atk"
			cflist@tcg = 1, 2, 3, 4, 5, 6, 7, 8, 9, 10
			cfmax@tcg = 10
		}
		if ( filtertype@tcg == 4 ) {
			cfname@tcg = lang("候補", "List"), lang("デッキ", "Deck"), "1 HP", "2 HP", "3 HP", "4 HP", "5 HP", "6 HP", "7 HP", "8 HP", "9+ HP"
			cflist@tcg = 1, 2, 3, 4, 5, 6, 7, 8, 9, 10
			cfmax@tcg = 10
		}
		if ( filtertype@tcg == 5 ) {
			cfname@tcg = lang("候補", "List"), lang("デッキ", "Deck"), "seamonster", "frog", "snail", "shell", "spirit", "slime", "bird", "mushroom"
			cflist@tcg = 1, 2, 3, 4, 5, 6, 7, 8, 9, 10
			cfmax@tcg = 9
		}
		if ( filtertype@tcg == 6 ) {
			cfname@tcg = lang("候補", "List"), lang("デッキ", "Deck"), "wisp", "bacteria", "wasp", "rabbit", "dinosaur", "largeanimal", "mandrake", "horse"
			cflist@tcg = 1, 2, 3, 4, 5, 6, 7, 8, 9, 10
			cfmax@tcg = 9
		}
		if ( filtertype@tcg == 7 ) {
			cfname@tcg = lang("候補", "List"), lang("デッキ", "Deck"), "beast", "bear", "ent", "sheep", "dog", "fairy", "beetle"
			cflist@tcg = 1, 2, 3, 4, 5, 6, 7, 8, 9, 10
			cfmax@tcg = 8
		}
		if ( filtertype@tcg == 8 ) {
			cfname@tcg = lang("候補", "List"), lang("デッキ", "Deck"), "minotaur", "lizardman", "orc", "goblin", "kobolt", "yeek", "medusa", "harpy"
			cflist@tcg = 1, 2, 3, 4, 5, 6, 7, 8, 9, 10
			cfmax@tcg = 9
		}
		if ( filtertype@tcg == 9 ) {
			cfname@tcg = lang("候補", "List"), lang("デッキ", "Deck"), "snake", "rat", "mutant", "mazin", "imp", "hand", "yith", "giant"
			cflist@tcg = 1, 2, 3, 4, 5, 6, 7, 8, 9, 10
			cfmax@tcg = 9
		}
		if ( filtertype@tcg == 10 ) {
			cfname@tcg = lang("候補", "List"), lang("デッキ", "Deck"), "drake", "eye", "asura", "rock", "dragon", "golem", "metal"
			cflist@tcg = 1, 2, 3, 4, 5, 6, 7, 8, 9, 10
			cfmax@tcg = 8
		}
		if ( filtertype@tcg == 11 ) {
			cfname@tcg = lang("候補", "List"), lang("デッキ", "Deck"), "zombie", "ghost", "piece", "armor", "lich", "skeleton", "bat", "cat"
			cflist@tcg = 1, 2, 3, 4, 5, 6, 7, 8, 9, 10
			cfmax@tcg = 9
		}
		if ( filtertype@tcg == 12 ) {
			cfname@tcg = lang("候補", "List"), lang("デッキ", "Deck"), "spider", "worm", "cupid", "eulderna", "roran", "karune", "dwarf", "elea"
			cflist@tcg = 1, 2, 3, 4, 5, 6, 7, 8, 9, 10
			cfmax@tcg = 9
		}
		if ( filtertype@tcg == 13 ) {
			cfname@tcg = lang("候補", "List"), lang("デッキ", "Deck"), "yerles", "juere", "norland", "zanan", "catsister", "quickling", "machine", "vehicle"
			cflist@tcg = 1, 2, 3, 4, 5, 6, 7, 8, 9, 10
			cfmax@tcg = 9
		}
		if ( filtertype@tcg == 14 ) {
			cfname@tcg = lang("候補", "List"), lang("デッキ", "Deck"), "undeadgod", "machinegod", "catgod", "doggod", "servant", "god"
			cflist@tcg = 1, 2, 3, 4, 5, 6, 7, 8, 9, 10
			cfmax@tcg = 7
		}
		if ( filtertype@tcg == 15 ) {
			cfname@tcg = lang("候補", "List"), lang("デッキ", "Deck"), "warrior", "thief", "wizard", "claymore", "priest", "archer", "warmage", "gunner"
			cflist@tcg = 1, 2, 3, 4, 5, 6, 7, 8, 9, 10
			cfmax@tcg = 9
		}
		if ( filtertype@tcg == 16 ) {
			cfname@tcg = lang("候補", "List"), lang("デッキ", "Deck"), "predator", "farmer", "pianist", "tourist", "classless", "male", "female", "random", "other"
			cflist@tcg = 1, 2, 3, 4, 5, 6, 7, 8, 9, 10
			cfmax@tcg = 10
		}
	}
	*select_deck_loop
	dlistmax@tcg = 0
	dsc@tcg = 0
	repeat maxcard@tcg
		// Deck mode -2: Choose a card from temporary zone.
		if ( deckmode@tcg == -2 & card@tcg(TCG_CARD_LOCATION, cnt) != TCG_LOCATION_DISCOVER ) {
			continue
		}
		// Deck mode -1: View deck in combat.
		// Deck mode 0: Edit Mode
		// Deck mode 4: Choose a card from deck.
		if ( (deckmode@tcg == 0 | deckmode@tcg == -1 | deckmode@tcg == 4) & card@tcg(TCG_CARD_LOCATION, cnt) != TCG_LOCATION_DECK ) {
			continue
		}
		// Deck mode 2: Choose a card from field.
		if ( deckmode@tcg == 1 & card@tcg(TCG_CARD_LOCATION, cnt) != TCG_LOCATION_FIELD ) {
			continue
		}
		// Deck mode 2: Choose a card from hand.
		if ( deckmode@tcg == 2 & card@tcg(TCG_CARD_LOCATION, cnt) != TCG_LOCATION_HAND ) {
			continue
		}
		// Deck mode 3: Choose a card from grave.
		if ( deckmode@tcg == 3 & card@tcg(TCG_CARD_LOCATION, cnt) != TCG_LOCATION_GRAVEYARD ) {
			continue
		}
		// Deck mode 5: Choose a card from hand/field.
		if ( deckmode@tcg == 5 & card@tcg(TCG_CARD_LOCATION, cnt) != TCG_LOCATION_HAND & card@tcg(TCG_CARD_LOCATION, cnt) != TCG_LOCATION_FIELD ) {
			continue
		}
		// Deck mode 6: Choose a card from hand/deck.
		if ( deckmode@tcg == 6 & card@tcg(TCG_CARD_LOCATION, cnt) != TCG_LOCATION_HAND & card@tcg(TCG_CARD_LOCATION, cnt) != TCG_LOCATION_DECK ) {
			continue
		}
		// Deck mode 7: Choose a card from exile.tt
		if ( deckmode@tcg == 7 & card@tcg(TCG_CARD_LOCATION, cnt) != TCG_LOCATION_DECK & card@tcg(TCG_CARD_LOCATION, cnt) != TCG_LOCATION_HAND & card@tcg(TCG_CARD_LOCATION, cnt) != TCG_LOCATION_FIELD & card@tcg(TCG_CARD_LOCATION, cnt) != TCG_LOCATION_GRAVEYARD ) {
			continue
		}
		// Deck mode 8: Anywhere
		// Deck mode 9: Choose a card from exile.
		if ( deckmode@tcg == 9 & card@tcg(TCG_CARD_LOCATION, cnt) != TCG_LOCATION_EXILE ) {
			continue
		}
		if ( deckmode@tcg < 0 & deckmodecp@tcg == 0 & card@tcg(TCG_CARD_CONTROLLER, cnt) != cp@tcg ) {
			continue
		}
		if ( deckmode@tcg < 0 & deckmodecp@tcg == 1 & card@tcg(TCG_CARD_CONTROLLER, cnt) == cp@tcg ) {
			continue
		}
		if ( cflist@tcg(ccf@tcg) == 1 & deckmode@tcg == 0 ) {
			if ( deck(card@tcg(TCG_CARD_REF_DBID, cnt)) == 0 ) {
				continue
			}
		}
		if ( cflist@tcg(ccf@tcg) >= 2 ) {
			if ( filtertype@tcg == 0 ) {
				if ( cflist@tcg(ccf@tcg) <= 8 ) {
					if ( limit((card@tcg(TCG_CARD_REF_DBID, cnt) - 1) / 150, 0, 6)  != cflist@tcg(ccf@tcg) - 2 ) {
						continue
					}
				}
			}
			if ( filtertype@tcg == 1 ) {
				if ( cflist@tcg(ccf@tcg) <= 9 ) {
					if ( card@tcg(TCG_CARD_REF_DOMAIN, cnt) != cflist@tcg(ccf@tcg) - 2 ) {
						continue
					}
				}
			}
			if ( filtertype@tcg == 2 ) {
				if ( cflist@tcg(ccf@tcg) <= 9 ) {
					if ( card@tcg(TCG_CARD_REF_COST, cnt) != cflist@tcg(ccf@tcg) - 2 ) {
						continue
					}
				}
				if ( cflist@tcg(ccf@tcg) == 10 ) {
					if ( card@tcg(TCG_CARD_REF_COST, cnt) < cflist@tcg(ccf@tcg) - 2 ) {
						continue
					}
				}
			}
			if ( filtertype@tcg == 3 ) {
				if ( cflist@tcg(ccf@tcg) == 2 ) {
					if ( card@tcg(TCG_CARD_REF_ATTACK, cnt) > 1 ) {
						continue
					}
				}
				if ( cflist@tcg(ccf@tcg) <= 9 & cflist@tcg(ccf@tcg) >= 3 ) {
					if ( card@tcg(TCG_CARD_REF_ATTACK, cnt) != cflist@tcg(ccf@tcg) - 1 ) {
						continue
					}
				}
				if ( cflist@tcg(ccf@tcg) == 10 ) {
					if ( card@tcg(TCG_CARD_REF_ATTACK, cnt) < cflist@tcg(ccf@tcg) - 1 ) {
						continue
					}
				}
			}
			if ( filtertype@tcg == 4 ) {
				if ( cflist@tcg(ccf@tcg) == 2 ) {
					if ( card@tcg(TCG_CARD_REF_HP, cnt) > 1 ) {
						continue
					}
				}
				if ( cflist@tcg(ccf@tcg) <= 9 & cflist@tcg(ccf@tcg) >= 3 ) {
					if ( card@tcg(TCG_CARD_REF_HP, cnt) != cflist@tcg(ccf@tcg) - 1 ) {
						continue
					}
				}
				if ( cflist@tcg(ccf@tcg) == 10 ) {
					if ( card@tcg(TCG_CARD_REF_HP, cnt) < cflist@tcg(ccf@tcg) - 1 ) {
						continue
					}
				}
			}
			if ( filtertype@tcg == 5 ) {
				if ( cflist@tcg(ccf@tcg) == 2 & cardn@tcg(TCG_CARDN_REF_RACE, cnt) != "seamonster" ) { continue }
				if ( cflist@tcg(ccf@tcg) == 3 & cardn@tcg(TCG_CARDN_REF_RACE, cnt) != "frog" ) { continue }
				if ( cflist@tcg(ccf@tcg) == 4 & cardn@tcg(TCG_CARDN_REF_RACE, cnt) != "snail" ) { continue }
				if ( cflist@tcg(ccf@tcg) == 5 & cardn@tcg(TCG_CARDN_REF_RACE, cnt) != "shell" ) { continue }
				if ( cflist@tcg(ccf@tcg) == 6 & cardn@tcg(TCG_CARDN_REF_RACE, cnt) != "spirit" ) { continue }
				if ( cflist@tcg(ccf@tcg) == 7 & cardn@tcg(TCG_CARDN_REF_RACE, cnt) != "slime" ) { continue }
				if ( cflist@tcg(ccf@tcg) == 8 & cardn@tcg(TCG_CARDN_REF_RACE, cnt) != "bird" ) { continue }
				if ( cflist@tcg(ccf@tcg) == 9 & cardn@tcg(TCG_CARDN_REF_RACE, cnt) != "mushroom" ) { continue }
			}
			if ( filtertype@tcg == 6 ) {
				if ( cflist@tcg(ccf@tcg) == 2 & cardn@tcg(TCG_CARDN_REF_RACE, cnt) != "wisp" ) { continue }
				if ( cflist@tcg(ccf@tcg) == 3 & cardn@tcg(TCG_CARDN_REF_RACE, cnt) != "bacteria" ) { continue }
				if ( cflist@tcg(ccf@tcg) == 4 & cardn@tcg(TCG_CARDN_REF_RACE, cnt) != "wasp" ) { continue }
				if ( cflist@tcg(ccf@tcg) == 5 & cardn@tcg(TCG_CARDN_REF_RACE, cnt) != "rabbit" ) { continue }
				if ( cflist@tcg(ccf@tcg) == 6 & cardn@tcg(TCG_CARDN_REF_RACE, cnt) != "dinosaur" ) { continue }
				if ( cflist@tcg(ccf@tcg) == 7 & cardn@tcg(TCG_CARDN_REF_RACE, cnt) != "largeanimal" ) { continue }
				if ( cflist@tcg(ccf@tcg) == 8 & cardn@tcg(TCG_CARDN_REF_RACE, cnt) != "mandrake" ) { continue }
				if ( cflist@tcg(ccf@tcg) == 9 & cardn@tcg(TCG_CARDN_REF_RACE, cnt) != "horse" ) { continue }
			}
			if ( filtertype@tcg == 7 ) {
				if ( cflist@tcg(ccf@tcg) == 2 & cardn@tcg(TCG_CARDN_REF_RACE, cnt) != "beast" ) { continue }
				if ( cflist@tcg(ccf@tcg) == 3 & cardn@tcg(TCG_CARDN_REF_RACE, cnt) != "bear" ) { continue }
				if ( cflist@tcg(ccf@tcg) == 4 & cardn@tcg(TCG_CARDN_REF_RACE, cnt) != "ent" ) { continue }
				if ( cflist@tcg(ccf@tcg) == 5 & cardn@tcg(TCG_CARDN_REF_RACE, cnt) != "sheep" ) { continue }
				if ( cflist@tcg(ccf@tcg) == 6 & cardn@tcg(TCG_CARDN_REF_RACE, cnt) != "dog" ) { continue }
				if ( cflist@tcg(ccf@tcg) == 7 & cardn@tcg(TCG_CARDN_REF_RACE, cnt) != "fairy" ) { continue }
				if ( cflist@tcg(ccf@tcg) == 8 & cardn@tcg(TCG_CARDN_REF_RACE, cnt) != "beetle" ) { continue }
			}
			if ( filtertype@tcg == 8 ) {
				if ( cflist@tcg(ccf@tcg) == 2 & cardn@tcg(TCG_CARDN_REF_RACE, cnt) != "minotaur" ) { continue }
				if ( cflist@tcg(ccf@tcg) == 3 & cardn@tcg(TCG_CARDN_REF_RACE, cnt) != "lizardman" ) { continue }
				if ( cflist@tcg(ccf@tcg) == 4 & cardn@tcg(TCG_CARDN_REF_RACE, cnt) != "orc" ) { continue }
				if ( cflist@tcg(ccf@tcg) == 5 & cardn@tcg(TCG_CARDN_REF_RACE, cnt) != "goblin" ) { continue }
				if ( cflist@tcg(ccf@tcg) == 6 & cardn@tcg(TCG_CARDN_REF_RACE, cnt) != "kobolt" ) { continue }
				if ( cflist@tcg(ccf@tcg) == 7 & cardn@tcg(TCG_CARDN_REF_RACE, cnt) != "yeek" ) { continue }
				if ( cflist@tcg(ccf@tcg) == 8 & cardn@tcg(TCG_CARDN_REF_RACE, cnt) != "medusa" ) { continue }
				if ( cflist@tcg(ccf@tcg) == 9 & cardn@tcg(TCG_CARDN_REF_RACE, cnt) != "harpy" ) { continue }
			}
			if ( filtertype@tcg == 9 ) {
				if ( cflist@tcg(ccf@tcg) == 2 & cardn@tcg(TCG_CARDN_REF_RACE, cnt) != "snake" ) { continue }
				if ( cflist@tcg(ccf@tcg) == 3 & cardn@tcg(TCG_CARDN_REF_RACE, cnt) != "rat" ) { continue }
				if ( cflist@tcg(ccf@tcg) == 4 & cardn@tcg(TCG_CARDN_REF_RACE, cnt) != "mutant" ) { continue }
				if ( cflist@tcg(ccf@tcg) == 5 & cardn@tcg(TCG_CARDN_REF_RACE, cnt) != "mazin" ) { continue }
				if ( cflist@tcg(ccf@tcg) == 6 & cardn@tcg(TCG_CARDN_REF_RACE, cnt) != "imp" ) { continue }
				if ( cflist@tcg(ccf@tcg) == 7 & cardn@tcg(TCG_CARDN_REF_RACE, cnt) != "hand" ) { continue }
				if ( cflist@tcg(ccf@tcg) == 8 & cardn@tcg(TCG_CARDN_REF_RACE, cnt) != "yith" ) { continue }
				if ( cflist@tcg(ccf@tcg) == 9 & cardn@tcg(TCG_CARDN_REF_RACE, cnt) != "giant" ) { continue }
			}
			if ( filtertype@tcg == 10 ) {
				if ( cflist@tcg(ccf@tcg) == 2 & cardn@tcg(TCG_CARDN_REF_RACE, cnt) != "drake" ) { continue }
				if ( cflist@tcg(ccf@tcg) == 3 & cardn@tcg(TCG_CARDN_REF_RACE, cnt) != "eye" ) { continue }
				if ( cflist@tcg(ccf@tcg) == 4 & cardn@tcg(TCG_CARDN_REF_RACE, cnt) != "asura" ) { continue }
				if ( cflist@tcg(ccf@tcg) == 5 & cardn@tcg(TCG_CARDN_REF_RACE, cnt) != "rock" ) { continue }
				if ( cflist@tcg(ccf@tcg) == 6 & cardn@tcg(TCG_CARDN_REF_RACE, cnt) != "dragon" ) { continue }
				if ( cflist@tcg(ccf@tcg) == 7 & cardn@tcg(TCG_CARDN_REF_RACE, cnt) != "golem" ) { continue }
				if ( cflist@tcg(ccf@tcg) == 8 & cardn@tcg(TCG_CARDN_REF_RACE, cnt) != "metal" ) { continue }
			}
			if ( filtertype@tcg == 11 ) {
				if ( cflist@tcg(ccf@tcg) == 2 & cardn@tcg(TCG_CARDN_REF_RACE, cnt) != "zombie" ) { continue }
				if ( cflist@tcg(ccf@tcg) == 3 & cardn@tcg(TCG_CARDN_REF_RACE, cnt) != "ghost" ) { continue }
				if ( cflist@tcg(ccf@tcg) == 4 & cardn@tcg(TCG_CARDN_REF_RACE, cnt) != "piece" ) { continue }
				if ( cflist@tcg(ccf@tcg) == 5 & cardn@tcg(TCG_CARDN_REF_RACE, cnt) != "armor" ) { continue }
				if ( cflist@tcg(ccf@tcg) == 6 & cardn@tcg(TCG_CARDN_REF_RACE, cnt) != "lich" ) { continue }
				if ( cflist@tcg(ccf@tcg) == 7 & cardn@tcg(TCG_CARDN_REF_RACE, cnt) != "skeleton" ) { continue }
				if ( cflist@tcg(ccf@tcg) == 8 & cardn@tcg(TCG_CARDN_REF_RACE, cnt) != "bat" ) { continue }
				if ( cflist@tcg(ccf@tcg) == 9 & cardn@tcg(TCG_CARDN_REF_RACE, cnt) != "cat" ) { continue }
			}
			if ( filtertype@tcg == 12 ) {
				if ( cflist@tcg(ccf@tcg) == 2 & cardn@tcg(TCG_CARDN_REF_RACE, cnt) != "spider" ) { continue }
				if ( cflist@tcg(ccf@tcg) == 3 & cardn@tcg(TCG_CARDN_REF_RACE, cnt) != "worm" ) { continue }
				if ( cflist@tcg(ccf@tcg) == 4 & cardn@tcg(TCG_CARDN_REF_RACE, cnt) != "cupid" ) { continue }
				if ( cflist@tcg(ccf@tcg) == 5 & cardn@tcg(TCG_CARDN_REF_RACE, cnt) != "eulderna" ) { continue }
				if ( cflist@tcg(ccf@tcg) == 6 & cardn@tcg(TCG_CARDN_REF_RACE, cnt) != "roran" ) { continue }
				if ( cflist@tcg(ccf@tcg) == 7 & cardn@tcg(TCG_CARDN_REF_RACE, cnt) != "karune" ) { continue }
				if ( cflist@tcg(ccf@tcg) == 8 & cardn@tcg(TCG_CARDN_REF_RACE, cnt) != "dwarf" ) { continue }
				if ( cflist@tcg(ccf@tcg) == 9 & cardn@tcg(TCG_CARDN_REF_RACE, cnt) != "elea" ) { continue }
			}
			if ( filtertype@tcg == 13 ) {
				if ( cflist@tcg(ccf@tcg) == 2 & cardn@tcg(TCG_CARDN_REF_RACE, cnt) != "yerles" ) { continue }
				if ( cflist@tcg(ccf@tcg) == 3 & cardn@tcg(TCG_CARDN_REF_RACE, cnt) != "juere" ) { continue }
				if ( cflist@tcg(ccf@tcg) == 4 & cardn@tcg(TCG_CARDN_REF_RACE, cnt) != "norland" ) { continue }
				if ( cflist@tcg(ccf@tcg) == 5 & cardn@tcg(TCG_CARDN_REF_RACE, cnt) != "zanan" ) { continue }
				if ( cflist@tcg(ccf@tcg) == 6 & cardn@tcg(TCG_CARDN_REF_RACE, cnt) != "catsister" ) { continue }
				if ( cflist@tcg(ccf@tcg) == 7 & cardn@tcg(TCG_CARDN_REF_RACE, cnt) != "quickling" ) { continue }
				if ( cflist@tcg(ccf@tcg) == 8 & cardn@tcg(TCG_CARDN_REF_RACE, cnt) != "machine" ) { continue }
				if ( cflist@tcg(ccf@tcg) == 9 & cardn@tcg(TCG_CARDN_REF_RACE, cnt) != "vehicle" ) { continue }
			}
			if ( filtertype@tcg == 14 ) {
				if ( cflist@tcg(ccf@tcg) == 2 & cardn@tcg(TCG_CARDN_REF_RACE, cnt) != "undeadgod" ) { continue }
				if ( cflist@tcg(ccf@tcg) == 3 & cardn@tcg(TCG_CARDN_REF_RACE, cnt) != "machinegod" ) { continue }
				if ( cflist@tcg(ccf@tcg) == 4 & cardn@tcg(TCG_CARDN_REF_RACE, cnt) != "catgod" ) { continue }
				if ( cflist@tcg(ccf@tcg) == 5 & cardn@tcg(TCG_CARDN_REF_RACE, cnt) != "doggod" ) { continue }
				if ( cflist@tcg(ccf@tcg) == 6 & cardn@tcg(TCG_CARDN_REF_RACE, cnt) != "servant" ) { continue }
				if ( cflist@tcg(ccf@tcg) == 7 & cardn@tcg(TCG_CARDN_REF_RACE, cnt) != "god" ) { continue }
			}
			if ( filtertype@tcg == 15 ) {
				if ( cflist@tcg(ccf@tcg) == 2 & cardn@tcg(TCG_CARDN_REF_CLASS, cnt) != "warrior" ) { continue }
				if ( cflist@tcg(ccf@tcg) == 3 & cardn@tcg(TCG_CARDN_REF_CLASS, cnt) != "thief" ) { continue }
				if ( cflist@tcg(ccf@tcg) == 4 & cardn@tcg(TCG_CARDN_REF_CLASS, cnt) != "wizard" ) { continue }
				if ( cflist@tcg(ccf@tcg) == 5 & cardn@tcg(TCG_CARDN_REF_CLASS, cnt) != "claymore" ) { continue }
				if ( cflist@tcg(ccf@tcg) == 6 & cardn@tcg(TCG_CARDN_REF_CLASS, cnt) != "priest" ) { continue }
				if ( cflist@tcg(ccf@tcg) == 7 & cardn@tcg(TCG_CARDN_REF_CLASS, cnt) != "archer" ) { continue }
				if ( cflist@tcg(ccf@tcg) == 8 & cardn@tcg(TCG_CARDN_REF_CLASS, cnt) != "warmage" ) { continue }
				if ( cflist@tcg(ccf@tcg) == 9 & cardn@tcg(TCG_CARDN_REF_CLASS, cnt) != "gunner" ) { continue }
			}
			if ( filtertype@tcg == 16 ) {
				if ( cflist@tcg(ccf@tcg) == 2 & cardn@tcg(TCG_CARDN_REF_CLASS, cnt) != "predator" ) { continue }
				if ( cflist@tcg(ccf@tcg) == 3 & cardn@tcg(TCG_CARDN_REF_CLASS, cnt) != "farmer" ) { continue }
				if ( cflist@tcg(ccf@tcg) == 4 & cardn@tcg(TCG_CARDN_REF_CLASS, cnt) != "pianist" ) { continue }
				if ( cflist@tcg(ccf@tcg) == 5 & cardn@tcg(TCG_CARDN_REF_CLASS, cnt) != "tourist" ) { continue }
				if ( cflist@tcg(ccf@tcg) == 6 & cardn@tcg(TCG_CARDN_REF_CLASS, cnt) != "" ) { continue }
				if ( cflist@tcg(ccf@tcg) == 7 & cardn@tcg(TCG_CARDN_REF_SEX, cnt) != "male" ) { continue }
				if ( cflist@tcg(ccf@tcg) == 8 & cardn@tcg(TCG_CARDN_REF_SEX, cnt) != "female" ) { continue }
				if ( cflist@tcg(ccf@tcg) == 9 & cardn@tcg(TCG_CARDN_REF_SEX, cnt) != "random" ) { continue }
				if ( cflist@tcg(ccf@tcg) == 10 & cardn@tcg(TCG_CARDN_REF_SEX, cnt) != "" ) { continue }
			}
		}
		cnt2@tcg = cnt
		if ( deckmode@tcg > 0 ) {
			if ( target_num@tcg <= 0 ) { continue }
			f@tcg = 0
			repeat target_num@tcg
				if ( target@tcg(cnt) == cnt2@tcg ) { 
					f@tcg = 1
				}
			loop
			if ( f@tcg == 0 ) {
				continue
			}
		}
		cdbitmod TCG_BIT_FACE_UP, cnt2@tcg, 1
		if ( deckmode@tcg == 0 & card(0, card@tcg(TCG_CARD_REF_DBID, cnt2@tcg) ) == 0 ) {
			if ( cflist@tcg(ccf@tcg) == 1 ) {
				continue
			} else {
				card@tcg(TCG_CARD_CONTROLLER, cnt2@tcg) = TCG_CONTROLLER_OPPONENT
				cdbitmod TCG_BIT_FACE_UP, cnt2@tcg, 0
			}
		}
		dlist@tcg(0, dlistmax@tcg) = cnt2@tcg
		dlistmax@tcg++
	loop
	repeat
		f@tcg = 0
		if ( dlistmax@tcg == 0 ) {
			break
		}
		repeat dlistmax@tcg - 1
			p@tcg = card@tcg(TCG_CARD_REF_DBID, dlist@tcg(0, cnt)), card@tcg(TCG_CARD_REF_DBID, dlist@tcg(0, cnt + 1))
			if ( sortmode@tcg == 1 ) {
				p@tcg = card@tcg(TCG_CARD_REF_DOMAIN, dlist@tcg(0, cnt)), card@tcg(TCG_CARD_REF_DOMAIN, dlist@tcg(0, cnt + 1))
			}
			if ( sortmode@tcg == 2 ) {
				p@tcg = card@tcg(TCG_CARD_REF_COST, dlist@tcg(0, cnt)), card@tcg(TCG_CARD_REF_COST, dlist@tcg(0, cnt + 1))
			}
			if ( sortmode@tcg == 3 ) {
				p@tcg = card@tcg(TCG_CARD_REF_ATTACK, dlist@tcg(0, cnt)), card@tcg(TCG_CARD_REF_ATTACK, dlist@tcg(0, cnt + 1))
			}
			if ( sortmode@tcg == 4 ) {
				p@tcg = card@tcg(TCG_CARD_REF_HP, dlist@tcg(0, cnt)), card@tcg(TCG_CARD_REF_HP, dlist@tcg(0, cnt + 1))
			}
			if ( p@tcg > p@tcg(1) ) {
				f@tcg = 1
				p@tcg = dlist@tcg(0, cnt), dlist@tcg(1, cnt)
				dlist@tcg(0, cnt) = dlist@tcg(0, cnt + 1), dlist@tcg(1, cnt + 1)
				dlist@tcg(0, cnt + 1) = p@tcg, p@tcg(1)
			}
		loop
		if ( f@tcg == 0 ) {
			break
		}
	loop
	gosub *select_deck_pos
	*select_deck_loop_WHILE1
	redraw 0
	gosub *tcg_drawInterface
	gosub *tcg_drawDeck
	if ( deckmode@tcg > 0 & eff@tcg >= 0 & eff@tcg < 3000 ) {
		cardhelp effdesc@tcg(eff@tcg), 10
	}
	redraw 1
	await 30
	key_check
	cursor_check@tcg 0
	if ( deckmode@tcg == 0 ) {
		getkey a, 119
		if ( a ) {
			gosub *DeckExportImportMenu
			gosub *tcg_drawInterface
			gosub *tcg_drawDeck
			goto *select_deck
		}
	}
	if ( key == key_next ) {
		ccf@tcg++
		snd SOUNDLIST_CURSOR1
		if ( ccf@tcg >= cfmax@tcg ) {
			ccf@tcg = 0
		}
		goto *select_deck_loop
	}
	if ( key == key_fire | key == key_get ) {
		if ( key == key_fire ) { filtertype@tcg-- }
		if ( key == key_get ) { filtertype@tcg++ }
		if ( filtertype@tcg > 16 ) {
			filtertype@tcg = 0
		}
		if ( filtertype@tcg < 0 ) {
			filtertype@tcg = 16
		}
		goto *select_deck
	}
	if ( key == key_msglog & deckmode@tcg == 0 ) {
		promptAdd lang("デッキのリセット", "Reset Your Deck"), "a"
		promptAdd lang("キャンセル", "Cancel"), "b"
		val = basex@tcg + 420, basey@tcg + 230, 200, 1
		gosub *prompt_key@
		if ( rtval == 0 ) {
			repeat MAX_CARD
				deck(cnt) = 0
			loop
			calcdecksize
			goto *select_deck
		}
	}
	if ( key == key_charainfo ) {
		displayinfo@tcg = limit(1 - displayinfo@tcg, 0, 1)
		if ( cardmode@tcg == 1 ) {
			i@tcg = 0
			repeat MAX_CREATURE_ID - 3, 1
				fubk@tcg = cdbit(TCG_BIT_FACE_UP, i@tcg)
				create_card i@tcg, cnt
				card@tcg(TCG_CARD_LOCATION, i@tcg) = TCG_LOCATION_DECK, 0
				card@tcg(TCG_CARD_CONTROLLER, i@tcg) = (1 - fubk@tcg)
				cdbitmod TCG_BIT_FACE_UP, i@tcg, fubk@tcg
				i@tcg++
			loop
		}
	}
	if ( key == key_search ) {
		sortmode@tcg++
		if ( sortmode@tcg > 4 ) {
			sortmode@tcg = 0
		}
		if ( sortmode@tcg < 0 ) {
			sortmode@tcg = 4
		}
		goto *select_deck
	}
	if ( key == key_prev ) {
		ccf@tcg--
		snd SOUNDLIST_CURSOR1
		if ( ccf@tcg < 0 ) {
			ccf@tcg = cfmax@tcg - 1
		}
		goto *select_deck_loop
	}
	if ( key == key_west ) {
		dsc@tcg--
		snd SOUNDLIST_CURSOR1
	}
	if ( key == key_east ) {
		dsc@tcg++
		snd SOUNDLIST_CURSOR1
	}
	if ( key == key_south ) {
		dsc@tcg += 8
		snd SOUNDLIST_CURSOR1
	}
	if ( key == key_north ) {
		dsc@tcg -= 8
		snd SOUNDLIST_CURSOR1
	}
	gosub *select_deck_pos
	if ( key == key_enter ) {
		if ( dlistmax@tcg == 0 ) {
			goto *select_deck_loop_WHILE1_CONTINUE
		}
		if ( deckmode@tcg == 0 ) {
			*select_deck_loop_WHILE2
			redraw 0
			calcdecksize
			gosub *tcg_drawInterface
			gosub *tcg_drawDeck
			act@tcg = 0, 0, 0
			cc@tcg = dlist@tcg(0, dsc@tcg)
			if ( deck(card@tcg(TCG_CARD_REF_DBID, cc@tcg)) < card(0, card@tcg(TCG_CARD_REF_DBID, cc@tcg)) ) {
				act@tcg(0) = 1
			}
			if ( deck(card@tcg(TCG_CARD_REF_DBID, cc@tcg)) != 0 ) {
				act@tcg(1) = 1
			}
			if ( act@tcg(0) == 0 ) {
				if ( act@tcg(1) == 0 ) {
					snd SOUNDLIST_FAIL1
					goto *select_deck_loop_WEND2
				}
			}
			gosub *select_action
			if ( f@tcg == 0 ) {
				if ( act@tcg(0) ) {
					if ( deck(card@tcg(TCG_CARD_REF_DBID, cc@tcg)) >= 1 & card@tcg(TCG_CARD_REF_DOMAIN, cc@tcg) == 5 ) {
						cardhelp lang("デッキに同じ伝説のカードを1枚しか入れることができない。", "You can only put 1 copy of the same Legendary Card in your deck."), 40
						deck(card@tcg(TCG_CARD_REF_DBID, cc@tcg)) = 1
						snd SOUNDLIST_FAIL1
						goto *select_deck_loop_WEND2
					}
					if ( deck(card@tcg(TCG_CARD_REF_DBID, cc@tcg)) >= 2 & card@tcg(TCG_CARD_REF_DOMAIN, cc@tcg) == 4 & card@tcg(TCG_CARD_EFFECT, cc@tcg) != TCG_EFF_NOLIMIT & card@tcg(TCG_CARD_EFFECT, cc@tcg) != TCG_EFF_NOVICE ) {
						cardhelp lang("デッキに同じ中立のカードを1枚しか入れることができない。", "You can only put 2 copy of the same Neutral Card in your deck."), 40
						deck(card@tcg(TCG_CARD_REF_DBID, cc@tcg)) = 2
						snd SOUNDLIST_FAIL1
						goto *select_deck_loop_WEND2
					}
					if ( deck(card@tcg(TCG_CARD_REF_DBID, cc@tcg)) >= 4 & card@tcg(TCG_CARD_EFFECT, cc@tcg) != TCG_EFF_NOLIMIT & card@tcg(TCG_CARD_EFFECT, cc@tcg) != TCG_EFF_NOVICE ) {
						cardhelp lang("デッキに同じカードを4枚しか入れることができない。", "You can only put 4 copy of the same Card in your deck."), 40
						deck(card@tcg(TCG_CARD_REF_DBID, cc@tcg)) = 4
						snd SOUNDLIST_FAIL1
						goto *select_deck_loop_WEND2
					}
					deck(card@tcg(TCG_CARD_REF_DBID, cc@tcg))++
					snd SOUNDLIST_CARD1
					goto *select_deck_loop_WHILE2_CONTINUE
				}
			}
			if ( f@tcg == 1 ) {
				if ( act@tcg(1) ) {
					deck(card@tcg(TCG_CARD_REF_DBID, cc@tcg))--
					snd SOUNDLIST_CARD1
					goto *select_deck_loop_WHILE2_CONTINUE
				}
			}
			goto *select_deck_loop_WEND2
			*select_deck_loop_WHILE2_CONTINUE
			goto *select_deck_loop_WHILE2
			*select_deck_loop_WEND2
			calcdecksize
			goto *select_deck_loop_WHILE1_CONTINUE
		}
		if ( deckmode@tcg != 0 ) {
			redraw 0
			gosub *tcg_drawInterface
			gosub *refresh_bg
			tcgdraw
			redraw 1
			rtval@tcg = dlist@tcg(0, dsc@tcg)
			return rtval@tcg
		}
		rtval@tcg = dlist@tcg(0, dsc@tcg)
		rtval@tcg = 1
		goto *select_deck_loop_WEND1
	}
	if ( key == key_cancel ) {
		if ( deckmode@tcg == 0 ) {
			promptAdd lang("セーブして終了", "Save & Exit")
			promptAdd lang("セーブしないで終了", "Just Exit")
			val = basex@tcg + 420, basey@tcg + 230, 240, 1
			gosub *prompt_key@
			if ( rtval == 0 ) {
				file = "" + exedir + "tmp\\deck_" + curdeck + ".s2"
				fmode = 23
				gosub *game_ctrlFile@
			}
			else {
				gdata(GDATA_DECK_SIZE + curdeck) = decksizebk@tcg
			}
			if ( rtval == (-1) ) {
				calcdecksize
				goto *select_deck_loop_WHILE1_CONTINUE
			}
		}
		if ( deckmode@tcg != 0 ) {
			redraw 0
			gosub *tcg_drawInterface
			gosub *refresh_bg
			tcgdraw
			redraw 1
			rtval@tcg = (-1)
			return rtval@tcg
		}
		rtval@tcg = 0
		goto *select_deck_loop_WEND1
	}
	*select_deck_loop_WHILE1_CONTINUE
	goto *select_deck_loop_WHILE1
	*select_deck_loop_WEND1
	gsel 4
	pos 0, 0
	picload exedir + "graphic\\bg_card.bmp", 1
	gosub *tcg_initBg
	return rtval@tcg

*card_player
	displayinfo@tcg = 1
	if ( selectmode@tcg == 0 ) {
		cs@tcg = -1
		csline@tcg = 0 + 3 * (player@tcg == 1)
	}
	if ( selectmode@tcg == 1 ) {
		if ( cs@tcg == (-1) ) {
			csline@tcg = 0 + 3 * (player@tcg == 1)
		}
		else {
			csline@tcg = 1 + (player@tcg == 1)
		}
	}
	*card_player_WHILE1
	if ( selectmode@tcg == 2 & eff@tcg >= 0 & eff@tcg < 3000 ) {
		cardhelp effdesc@tcg(eff@tcg), 10
	}
	makecardlist
	if ( player@tcg == 0 ) {
		cardposhand 0, -1
		cardpos 0, -1
	}
	if ( player@tcg == 1 ) {
		cardposhand 1, -1
		cardpos 1, -1
	}
	gosub *card_resolve_ongoing
	tcgdraw
	cursor@tcg = 1
	await 15
	key_check
	cursor_check@tcg 1
	if ( gameresult@tcg > 0 ) {
		return
	}
	if ( selectmode@tcg == 2 ) {
		csfix
		if ( cs@tcg < 0 ) {
			cardhelp lang("ランダムに選ぶ。", "Choose Randomly.")
		}
		if ( targetlinenum@tcg <= 0 ) {
			rtval@tcg = (-1)
			return
		}
	}
	if ( key == key_east ) {
		cs@tcg++
		snd SOUNDLIST_CURSOR1
		if ( cs@tcg == 0 ) {
			if ( clistmax@tcg(csline@tcg) == 0 ) {
				cslineup
			}
		}
		csfix
	}
	if ( key == key_west ) {
		cs@tcg--
		snd SOUNDLIST_CURSOR1
		if ( cs@tcg == (-1) ) {
			if ( csline@tcg != 0 ) {
				cs@tcg = clistmax@tcg(csline@tcg) - 1
			}
		}
		if ( cs@tcg == (-2) ) {
			if ( clistmax@tcg(csline@tcg) == 0 ) {
				cslinedown
			}
		}
		csfix
	}
	if ( key == key_north ) {
		cslineup
		snd SOUNDLIST_CURSOR1
		csfix
	}
	if ( key == key_south ) {
		cslinedown
		snd SOUNDLIST_CURSOR1
		csfix
	}
	if ( key == key_msglog ) {
		deckmode@tcg = -1
		deckmodecp@tcg = (specialruleseeopponenthand@tcg > 0)
		gosub *select_deck
		repeat maxcard@tcg
			if ( card@tcg(TCG_CARD_LOCATION, cnt) == TCG_LOCATION_DECK ) {
				cdbitmod TCG_BIT_FACE_UP, cnt, 0
			}
		loop
		deckmode@tcg = 0
		deckmodecp@tcg = 0
		goto *card_player_WHILE1
	}
	if ( key == key_enter ) {
		if ( cs@tcg <= (-1) ) {
			rtval@tcg = (-1)
			goto *card_player_WEND1
		}
		act@tcg = 0, 0, 0
		s@tcg = ""
		cc@tcg = clist@tcg(cs@tcg, csline@tcg)
		if ( selectmode@tcg == 2 ) {
			rtval@tcg = cc@tcg
			return
		}
		if ( (csline@tcg == 0 & player@tcg == 0) | (csline@tcg == 3 & (debug == 1 | player@tcg = 1)) ) {
			if ( card@tcg(TCG_CARD_COST, cc@tcg) <= cpdata@tcg(TCG_PLAYER_MANA, cp@tcg) ) {
				if ( card@tcg(TCG_CARD_REF_TYPE, cc@tcg) == TCG_TYPE_SPELL | selectmode@tcg == 0 ) {
					act@tcg(0) = 1
					s@tcg += lang("↑   カードを出す。\n", "UP: Put the card.\n")
				}
			}
			if ( sac@tcg == 0 ) {
				if ( selectmode@tcg == 0 ) {
					act@tcg(1) = 1
					s@tcg += lang("↓   カードを捧げてマナを得る(1ターンに1回)。\n", "Down: Sacrifice the card.\n")
				}
			}
		}
		if ( (csline@tcg == 1 & player@tcg == 0) | (csline@tcg == 2 & (debug == 1 | player@tcg = 1)) ) {
			if ( selectmode@tcg == 0 ) {
				if ( card@tcg(TCG_CARD_STATUS, cc@tcg) != TCG_ACTION_ATTACKING ) {
					if ( cardcandeclareattack(cc@tcg) ) {
						act@tcg(0) = 1
						s@tcg += lang("↑   攻撃を宣言する。\n", "UP: Declare an attack.\n")
					}
				}
			}
			if ( selectmode@tcg == 1 ) {
				if ( cardcanblock(cc@tcg, attackingcard@tcg) ) {
					act@tcg(0) = 1
					s@tcg += lang("↑   ブロックする。\n", "UP: Block.\n")
				}
			}
			if ( cardcanuseskill(cc@tcg) ) {
				act@tcg(2) = 1
				s@tcg += lang("決定 スキルを使用する。\n", "ENTER: Use the skill.\n")
			}
		}
		f@tcg = 0
		repeat 3
			if ( act@tcg(cnt) != 0 ) {
				f@tcg = 1
				break
			}
		loop
		if ( f@tcg == 0 ) {
			if ( debug == 0 ) {
				snd SOUNDLIST_FAIL1
				cardhelp lang("可能な行動はない。", "There is no action available."), 40
				goto *card_player_WHILE1_CONTINUE
			}
		}
		snd SOUNDLIST_CLICK1
		cardhelp s@tcg, 10
		tcgdraw
		gosub *select_action
		cc@tcg = clist@tcg(cs@tcg, csline@tcg)
		key = ""
		if ( f@tcg == (-1) ) {
			goto *card_player_WHILE1_CONTINUE
		}
		if ( act@tcg(f@tcg) == 0 ) {
			if ( debug == 0 ) {
				goto *card_player_WHILE1_CONTINUE
			}
		}
		if ( (csline@tcg == 1 & player@tcg == 0) | (csline@tcg == 2 & (debug == 1 | player@tcg = 1)) ) {
			if ( f@tcg == 0 ) {
				if ( selectmode@tcg == 1 ) {
					attacktarget@tcg = cc@tcg
					goto *card_player_WEND1
				}
				cardstack@tcg(TCG_STACK, stack@tcg) = cc@tcg, TCG_ACTION_ATTACKING, cp@tcg, -1
				stack@tcg++
				actionproc
				if ( gameover() ) {
					goto *card_player_WEND1
				}
				if ( cs@tcg >= clistmax@tcg(csline@tcg) ) {
					cs@tcg = clistmax@tcg(csline@tcg) - 1
				}
				csfix
				goto *card_player_WHILE1_CONTINUE
			}
			if ( f@tcg == 1 ) {
				card@tcg(TCG_CARD_STATUS, cc@tcg) = TCG_ACTION_NONE
			}
			if ( f@tcg == 2 ) {
				cardstack@tcg(TCG_STACK, stack@tcg) = cc@tcg, TCG_ACTION_INVOKING, cp@tcg
				stack@tcg++
				if ( chainmode@tcg ) {
					chaincontinue@tcg = 1
					spellused@tcg = 1
					goto *card_player_WEND1
				}
				actionproc
				if ( gameover() ) {
					goto *card_player_WEND1
				}
			}
			if ( cs@tcg >= clistmax@tcg(csline@tcg) ) {
				cs@tcg = clistmax@tcg(csline@tcg) - 1
			}
			csfix
			goto *card_player_WHILE1_CONTINUE
		}
		if ( f@tcg == 1 ) {
			cursor@tcg = 0
			saccard cc@tcg, cp@tcg - (player@tcg == 1) + (csline@tcg == 3)
			if ( cs@tcg >= clistmax@tcg(csline@tcg) ) {
				cs@tcg = clistmax@tcg(csline@tcg) - 1
			}
			csfix
			goto *card_player_WHILE1_CONTINUE
		}
		if ( f@tcg == 0 ) {
			cursor@tcg = 0
			putcard cc@tcg, cp@tcg - (player@tcg == 1) + (csline@tcg == 3)
			if ( gameover() ) {
				goto *card_player_WEND1
			}
			if ( card@tcg(TCG_CARD_REF_TYPE, cc@tcg) == TCG_TYPE_SPELL ) {
				cardstack@tcg(TCG_STACK, stack@tcg) = cc@tcg, TCG_ACTION_INVOKING, cp@tcg
				stack@tcg++
				if ( chainmode@tcg ) {
					chaincontinue@tcg = 1
					spellused@tcg = 1
					goto *card_player_WEND1
				}
				actionproc
			}
			if ( gameover() ) {
				goto *card_player_WEND1
			}
		}
		if ( cs@tcg >= clistmax@tcg(csline@tcg) ) {
			cs@tcg = clistmax@tcg(csline@tcg) - 1
		}
		csfix
	}
	if ( key == key_cancel ) {
		if ( selectmode@tcg == 2 ) {
			rtval@tcg = (-1)
			return
		}
		if ( selectmode@tcg != 0 ) {
			goto *card_player_WEND1
		}
		promptAdd lang("ターンエンド", "End Turn"), "a"
		promptAdd lang("いいえ", "No"), "b"
		val = basex@tcg + 420, basey@tcg + 230, 200, 1
		gosub *prompt_key@
		if ( rtval == 0 ) {
			goto *card_player_WEND1
		}
	}
	if ( key == "s"  | key_escape ) {
		promptAdd lang("降参する", "Surrender"), "a"
		promptAdd lang("いいえ", "No"), "b"
		val = basex@tcg + 420, basey@tcg + 230, 200, 1
		gosub *prompt_key@
		if ( rtval == 0 ) {
			cpdata@tcg(TCG_PLAYER_LIFE, 0) = 0
			gameresult@tcg = -1
			cursor@tcg = 0
			return
		}
	}
	if ( debug ) {
		getkey a@tcg, 112
		if ( a@tcg ) {
			repeat 5
				getrandomcard cp@tcg
			loop
		}
		getkey a@tcg, 113
		if ( a@tcg ) {
			deckmode@tcg = 0
			deckrefn@tcg = "slime"
			gosub *select_deck
		}
	}
	*card_player_WHILE1_CONTINUE
	goto *card_player_WHILE1
	*card_player_WEND1
	cursor@tcg = 0
	return

*select_action
	redraw 0
	p@tcg = 0
	i@tcg = 0
	f@tcg = 1
	*select_action_WHILE1
	p@tcg++
	i@tcg += f@tcg
	if ( i@tcg > 30 ) {
		f@tcg = -1
	}
	else {
		if ( i@tcg < 0 ) {
			f@tcg = 1
		}
	}
	repeat 3
		x@tcg(cnt) = card@tcg(TCG_CARD_X, cc@tcg) + 20
		if ( cnt == 0 ) {
			y@tcg(cnt) = card@tcg(TCG_CARD_Y, cc@tcg) - limit(p@tcg * 3, 0, 16)
		}
		if ( cnt == 1 ) {
			y@tcg(cnt) = card@tcg(TCG_CARD_Y, cc@tcg) + 60 + limit(p@tcg * 3, 0, 16)
		}
		if ( cnt == 2 ) {
			y@tcg(cnt) = card@tcg(TCG_CARD_Y, cc@tcg) + 30
		}
		gmode 0
		gsel 7
		pos cnt * 48, 264
		gcopy 0, x@tcg(cnt), y@tcg(cnt), 36, 36
		gsel 0
		if ( act@tcg(cnt) == 0 ) {
			continue
		}
		color 0, 0, 0
		gmode 4, 0, 0, limit(p@tcg * 30 + 20, 0, 255)
		pos x@tcg(cnt), y@tcg(cnt)
		gcopy 7, 192, 96, 36, 36
		gmode 4, 0, 0, 50 + i@tcg * 2
		pos x@tcg(cnt) + 13, y@tcg(cnt) + 11
		gcopy 7, 336 + (cnt == 2) * 12, 96 + cnt \ 2 * 24, 12, 12
	loop
	redraw 1
	redraw 0
	gmode 0
	repeat 3
		if ( act@tcg(cnt) == 0 ) {
			continue
		}
		pos x@tcg(cnt), y@tcg(cnt)
		gcopy 7, cnt * 48, 264, 36, 36
	loop
	await 15
	key_check
	cursor_check@tcg 2
	if ( key == key_north ) {
		f@tcg = 0
		goto *select_action_WEND1
	}
	if ( key == key_south ) {
		f@tcg = 1
		goto *select_action_WEND1
	}
	if ( key == key_enter ) {
		f@tcg = 2
		goto *select_action_WEND1
	}
	if ( key != "" ) {
		f@tcg = -1
		goto *select_action_WEND1
	}
	goto *select_action_WHILE1
	*select_action_WEND1
	return

*DeckExportImportMenu
	redraw 0
	cardhelp lang("[カスタムDeck]何をする？", "[Deck] What do you want to do?"), 100
	promptAdd "Export Deck", "null", 0
	promptAdd "Import Deck", "null", 1
	promptAdd "Reset Current Deck", "null", 2
	if ( gdata(GDATA_WIZARD) ) {
		promptAdd "Export Card List", "null", 3
	}
	val = promptx, prompty, 260, 1
	gosub *prompt_key
	gosub *tcg_drawInterface
	gosub *tcg_drawDeck
	if ( rtval == 0 ) {
		cardhelp lang("どのファイル名で保存する？", "Enter file name."), 100
		gosub *tcg_drawInterface
		gosub *tcg_drawDeck
		redraw 1
		fileext = "txt"
		filedsc = "ElonaPlus CGX custom Deck"
		_fdialog fileext, 17, filedsc, exedir + "user", "default_deck.txt"
		if ( stat == 0 ) {
			return
		}
		txtfile = refstr
		buff = ""
		notesel buff
		repeat MAX_CARD
			if ( deck(cnt) <= 0 ) { continue }
			noteadd "" + cnt + "," + deck(cnt) + ","
		loop
		notesave txtfile
		return
	}
	if ( rtval == 1 ) {
		cardhelp lang("どのファイルからDeckを作成する？", "Choose the Deck file."), 100
		gosub *tcg_drawInterface
		gosub *tcg_drawDeck
		redraw 1
		fileext = "txt"
		filedsc = "ElonaPlus CGX custom Deck"
		_fdialog fileext, 16, filedsc, exedir + "user", ""
		if ( stat == 0 ) {
			return
		}
		repeat MAX_CARD
			deck(cnt) = 0
		loop
		txtfile = refstr
		exist txtfile
		buff = ""
		notesel buff
		noteload txtfile
		repeat noteinfo(0)
			noteget s, cnt
			if ( s == "" ) { break }
			csvstr2 s, s
			if ( length(s) < 2 ) { continue }
			if ( s(0) == "" | s(1) == "" ) { continue }
			if ( int(s(0)) <= 0 | int(s(0)) >= MAX_CARD | int(s(1)) <= 0 ) { continue }
			deck(int(s(0))) = int(s(1))
		loop
		calcdecksize
		return
	}
	if ( rtval == 2 ) {
		repeat MAX_CARD
			deck(cnt) = 0
		loop
		calcdecksize
		return
	}
	if ( rtval == 3 ) {
		txtfile = exedir + "\\TCG_card_list.txt"
		buff = ""
		notesel buff
		repeat MAX_CARD
			if ( cnt <= 0 | cnt > MAX_CREATURE_ID - 3 ) {
				continue
			}
			card_ref cnt
			if ( stat >= 0 ) {
				sdim lines@tcg
				split rtvaln2, "\n", lines@tcg
				f@tcg = stat
				bits@tcg = ""
				if ( f@tcg >= 2 & instr(rtvaln2, 0, "Bits:  ") != -1 ) {
					bits@tcg = lines@tcg(1)
				}
				sreplace s@tcg, s@tcg, "\n", "  "
				sreplace s@tcg, s@tcg, "Effect: ", ""
				sreplace bits@tcg, bits@tcg, "Bits:  ", ""
				if ( cnt == 37 ) {
					cardrefcost = "race dependent"
					cardrefattack = "race/class dependent"
					cardrefhp = "race/class dependent"
					s@tcg = "class dependent"
					bits@tcg = "class/affliation dependent"
					cardrefrace = "player race"
					cardrefclass = "player class"
				}
				if ( cnt == 343 ) {
					cardrefn = "[AKA] [Player Name]"
					cardrefcost = "race dependent"
					cardrefattack = "race/class dependent"
					cardrefhp = "race/class dependent"
					s@tcg = "class dependent"
					bits@tcg = "class/affliation dependent"
					cardrefrace = "player race"
					cardrefclass = "player class"
				}
				if ( cnt == 901 ) {
					cardrefn = "[Random AKA] [Random Name]"
					cardrefcost = "race dependent"
					cardrefattack = "race/class dependent"
					cardrefhp = "race/class dependent"
					s@tcg = "class dependent"
					bits@tcg = "class dependent"
					cardrefrace = "random race"
					cardrefclass = "random class"
				}
				noteadd "|-"
				noteadd "|" + cnt + "||" + cardrefn + "||" + cnvcase(domname@tcg(cardrefdomain),3) + "||" + cardrefcost + "||" + cardrefattack + "||" + cardrefhp + "||" + s@tcg + "||" + bits@tcg + "||" + cardrefrace + "||" + cardrefclass + ""
			}
		loop
		notesave txtfile
		return
	}
	return
